<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>

  <meta charset="UTF-8">
  <title>ğŸ“˜ ××¢×¨×›×ª ×”×©××œ×ª ×¡×¤×¨×™× - ×§×¦×™×¨</title>
  <style>
    body { font-family: Arial; direction: rtl; background: #f9f9f9; padding: 20px; }
    .container { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    label, input, select, button { display: block; margin: 10px 0; }
    input, select { padding: 8px; width: 100%; }
    button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #studentTable {
  width: 100%;
  border-collapse: collapse;
}
#studentTable th {
  background-color: #f0f0f0;
  padding: 12px;
  text-align: center;
}
#studentTable td {
  font-size: 14px;
}
    #successMsg {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    footer{
        text-align: left; color: #888; font-size: 12px; margin-top: 40px;
    }
  #bookTable {
    width: 100%;
    border-collapse: collapse;
  }
  #bookTable th {
    background-color: #f0f0f0;
    padding: 12px;
    text-align: center;
  }

#signaturePad {
  touch-action: none;
  will-change: transform;
}

  #bookTable td {
    font-size: 14px;
  }

    .bolded
    {
        font-weight: bold;
    }
      .checkbox-list label {
    display: block;
    margin: 5px 0;
    cursor: pointer;
  }
.checkbox-list input[type="checkbox"] {
  width: 16px;
  height: 16px;
  margin-left: 4px; /* ××• ××¤×™×œ×• ×¤×—×•×ª */
  transform: none; /* ×”×¡×¨ ××ª ×”×”×’×“×œ×” */
  vertical-align: middle; /* ×œ×›×™×•×•×Ÿ ×™×™×©×•×¨ ×˜×•×‘ ×™×•×ª×¨ ×¢× ×”×˜×§×¡×˜ */
  cursor: pointer;
}


  .checkbox-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.checkbox-list label {
  background: #f1f1f1;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
}

.book-disabled {
  background-color: #eee !important;
  color: #888;
  border: 1px solid #ccc;
  text-decoration: line-through;
}

#signaturePad {
  border: 1px solid #ccc;
  width: 100%;
  height: 200px;
  touch-action: none; /* ××‘×˜×œ pinch/scroll */
  background-color: white;
  display: block;
  margin-bottom: 10px;
}
canvas {
  pointer-events: auto;
}
body {
  touch-action: auto;
}

html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden; /* ××•× ×¢ ×’×œ×™×œ×” ×œ×¨×•×—×‘ ×‘×œ×‘×“ */
}

#signaturePad {
  touch-action: none; /* ××•× ×¢ swipe/pinch ×¨×§ ×›××Ÿ */
  user-select: none;
  -webkit-user-drag: none;
}

#confirmBorrowModal {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  overflow: auto; /* ×××¤×©×¨ ×’×œ×™×œ×” ×× ×”×ª×•×›×Ÿ ××¨×•×š ××“×™ */
}

#scrollTopBtn {
  display: none;
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 99;
  width: 48px;
  height: 48px;
  font-size: 24px;
  border: none;
  outline: none;
  background-color: #007bff;
  color: white;
  cursor: pointer;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  line-height: 48px;
  text-align: center;
  padding: 0;
}

#scrollTopBtn:hover {
  background-color: #0056b3;
}


.tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      color:black;
    }
    .tab-button {
      padding: 10px 20px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      font-weight: bold;
      user-select: none;
      color:#000;
    }
    .tab-button.active {
      background: white;
      border-bottom: 2px solid white;
      box-shadow: 0 -2px 0 #007bff inset;
      color: #007bff;
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

#confirmBorrowModal > div {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

#signaturePad {
  width: 100%;
  height: 200px;
  border: 1px solid #ccc;
  touch-action: none;
  background-color: white;
}

.fullscreen-signature {
  background: white;
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 20px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.fullscreen-signature canvas {
  border: 2px solid #000;
  width: 90vw !important;
  height: 60vh !important;
}
.fullscreen-signature button {
  margin-top: 10px;
  font-size: 16px;
  padding: 10px 20px;

}

.borrowed-books-cell {
  max-height: 7.5em; /* 5 ×©×•×¨×•×ª ×‘×’×•×‘×” ×©×•×¨×” 1.5em */
  overflow-y: auto;
  padding-right: 5px;
  word-break: break-word;
  white-space: normal;
  vertical-align: top; /* ×—×©×•×‘! ×©×•×¨×” ×ª×ª×—×™×œ ××œ××¢×œ×” */
}

.borrowed-books-cell > div {
  padding: 2px 0;
  line-height: 1.5em; /* ×’×•×‘×” ×©×•×¨×” ××—×™×“ */
}

#studentPagination, #bookPagination {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin: 12px 0;
}
#studentPagination button,
#bookPagination button {
  padding: 6px 10px;
  border: 1px solid #007bff;
  background: white;
  color: #007bff;
  border-radius: 4px;
  cursor: pointer;
}
#studentPagination button.active,
#bookPagination button.active {
  background: #007bff;
  color: white;
}
#studentPagination button:disabled,
#bookPagination button:disabled {
  opacity: 0.6;
  cursor: default;
}


  </style>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <h1 id="yearHeader">ğŸ“˜ ××¢×¨×›×ª ×”×©××œ×ª ×¡×¤×¨×™× - ×§×¦×™×¨ ×¨×—×•×‘×•×ª - ×©× ×”: <span id="currentYearDisplay"></span></h1>
<input
  type="number"
  min="2026"
  id="yearSelect"
  style="
    width: 80px;
    height: 24px;
    cursor: pointer;
    vertical-align: middle;
    background: transparent;
    margin-left: 10px;
    margin-top: 4px;
    display: inline-block;
    font-size: 12px;
  "
  oninput="
    this.style.background = 'linear-gradient(to right, #007bff 0%, #007bff ' + 
    ((this.value - this.min) / (this.max - this.min)) * 100 + '%, #ccc ' +
    ((this.value - this.min) / (this.max - this.min)) * 100 + '%, #ccc 100%)';
  "
  onchange="
    this.dispatchEvent(new Event('input'));
  "
></div>

<div id="loadingOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.5);
  color: white;
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  padding-top: 40vh;
  z-index: 9999;
">×˜×•×¢×Ÿ...</div>

<div id="editStudentModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%;">
    <h3>×¢×¨×™×›×ª ×¤×¨×˜×™ ×ª×œ××™×“</h3>
    <label>×©× ××œ× <input id="editStudentName" type="text"></label>
    <label>×ª×¢×•×“×ª ×–×”×•×ª <input id="editStudentID" type="text" disabled></label>
    <label>×‘×™×ª ×¡×¤×¨
      <select id="editStudentSchool">
        <option value="×§×¦×™×¨ ×">×§×¦×™×¨ ×</option>
        <option value="×§×¦×™×¨ ×‘">×§×¦×™×¨ ×‘</option>
        <option value="×ª×™×›×•×Ÿ">×ª×™×›×•×Ÿ</option>
      </select>
    </label>
    <label>×›×™×ª×” <input id="editStudentClass" type="text"></label>
    <label>××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜ ×”×©××œ×ª ×¡×¤×¨×™×:
      <select id="editStudentInLoanProject">
        <option value="true">×›×Ÿ</option>
        <option value="false">×œ×</option>
      </select>
    </label>
    <div style="margin-top: 15px; text-align: left;">
      <button onclick="saveEditedStudent()">ğŸ’¾ ×©××•×¨</button>
      <button onclick="closeEditStudentModal()">âŒ ×‘×˜×œ</button>
    </div>
  </div>
</div>

<script>
  let currentEditIndex = null;

function editStudent(index) {
  currentEditIndex = index;
  const student = students[index];
  if (!student) return alert("×”×ª×œ××™×“ ×œ× × ××¦×");

  document.getElementById('editStudentName').value = student.name;
  document.getElementById('editStudentID').value = student.id; // ×œ× ×œ×¢×¨×•×š
  document.getElementById('editStudentSchool').value = student.school || '×§×¦×™×¨ ×';
  document.getElementById('editStudentClass').value = student.classroom || '';
  document.getElementById('editStudentInLoanProject').value = student.inLoanProject ? 'true' : 'false';

  document.getElementById('editStudentModal').style.display = 'flex';
}

function closeEditStudentModal() {
  currentEditIndex = null;
  document.getElementById('editStudentModal').style.display = 'none';
}

function saveEditedStudent() {
  if (currentEditIndex === null) return;

  const name = document.getElementById('editStudentName').value.trim();
  const school = document.getElementById('editStudentSchool').value;
  const classroom = document.getElementById('editStudentClass').value.trim();
  const inLoanProjectValue = document.getElementById('editStudentInLoanProject').value;

  if (!name || !classroom || inLoanProjectValue === '') {
    return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
  }

  students[currentEditIndex].name = name;
  students[currentEditIndex].school = school;
  students[currentEditIndex].classroom = classroom;
  students[currentEditIndex].inLoanProject = (inLoanProjectValue === 'true');

  saveData();
  showSuccess("×¤×¨×˜×™ ×”×ª×œ××™×“ ×¢×•×“×›× ×•");
  closeEditStudentModal();
  renderStudentTable();
  filterStudents();
}


let currentEditBookIndex = null;

function editBook(index) {
  currentEditBookIndex = index;
  const book = books[index];
  if (!book) return alert("×”×¡×¤×¨ ×œ× × ××¦×");

  document.getElementById('editBookName').value = book.name || '';
  document.getElementById('editBookSubject').value = book.subject || '';
  document.getElementById('editBookGrade').value = book.grade || '';
  document.getElementById('editBookLevel').value = book.level || '×›×œ×œ×™';
  document.getElementById('editBookVolume').value = book.volume || '×™×—×™×“';
  document.getElementById('editBookPublisher').value = book.publisher || '';
  document.getElementById('editBookType').value = book.type || '×¡×¤×¨';

  document.getElementById('editBookModal').style.display = 'flex';
}

function closeEditBookModal() {
  currentEditBookIndex = null;
  document.getElementById('editBookModal').style.display = 'none';
}

function saveEditedBook() {
  if (currentEditBookIndex === null) return;

  const name = document.getElementById('editBookName').value.trim();
  const subject = document.getElementById('editBookSubject').value.trim();
  const grade = document.getElementById('editBookGrade').value.trim();
  const level = document.getElementById('editBookLevel').value;
  const volume = document.getElementById('editBookVolume').value;
  const publisher = document.getElementById('editBookPublisher').value.trim();
  const type = document.getElementById('editBookType').value;

  if (!name || !subject || !grade || !level || !volume || !publisher || !type) {
    return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×—×•×‘×” ×œ×¡×¤×¨');
  }

  books[currentEditBookIndex].name = name;
  books[currentEditBookIndex].subject = subject;
  books[currentEditBookIndex].grade = grade;
  books[currentEditBookIndex].level = level;
  books[currentEditBookIndex].volume = volume;
  books[currentEditBookIndex].publisher = publisher;
  books[currentEditBookIndex].type = type;

  saveData();
  showSuccess("×¤×¨×˜×™ ×”×¡×¤×¨ ×¢×•×“×›× ×•");
  closeEditBookModal();
  renderBookTable();
  filterBooks();
}

</script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const yearInput = document.getElementById('yearSelect');  // ×©×“×” ×”×§×œ×˜ ××¡×•×’ number
    const yearDisplay = document.getElementById('currentYearDisplay');
    const minYear = 2026;

    // ×˜×¢×Ÿ ××ª ×”×©× ×” ×Ö¾localStorage, ××• ×”×’×“×¨ ××™× ×™××•×
    let selectedYear = parseInt(localStorage.getItem('selectedYear'), 10);
    if (isNaN(selectedYear) || selectedYear < minYear) {
      selectedYear = minYear;
      localStorage.setItem('selectedYear', selectedYear.toString());
    }

    // ×¢×“×›×Ÿ ××ª ×©×“×” ×”×§×œ×˜ ×•×”×ª×¦×•×’×”
    yearInput.value = selectedYear;
    yearDisplay.textContent = selectedYear;

    // ×××–×™×Ÿ ×œ×©×™× ×•×™×™× ×‘×§×œ×˜ (input) â€“ ×¨×§ ×× ×”×¢×¨×š ×—×•×§×™
    yearInput.addEventListener('input', () => {
      let val = parseInt(yearInput.value, 10);

      if (isNaN(val) || val < minYear) {
        yearDisplay.textContent = '×¢×¨×š ×œ× ×—×•×§×™';
        return;
      }

      localStorage.setItem('selectedYear', val.toString());
      yearDisplay.textContent = val;

      loadDataForYear(val);  // ×˜×¢×Ÿ ××—×“×© ××ª ×”× ×ª×•× ×™× ×œ×¤×™ ×”×©× ×”
    });

    // ×˜×¢×Ÿ ××ª ×”× ×ª×•× ×™× ×‘×ª×—×™×œ×” ×œ×¤×™ ×”×©× ×” ×©×”×•×’×“×¨×”
    loadDataForYear(selectedYear);
  });

  function loadDataForYear(year) {
    console.log("×˜×•×¢×Ÿ × ×ª×•× ×™× ×œ×©× ×”", year);
    loadData(); // ×¤×•× ×§×¦×™×” ×§×™×™××ª ×©××˜×¢× ×ª ××ª ×”× ×ª×•× ×™× ×©×œ×š
  }

  function yearKey(file) {
    const minYear = 2026;
    const maxYear = new Date().getFullYear() + 1;
    let year = parseInt(localStorage.getItem('selectedYear'), 10);

    if (isNaN(year) || year < minYear) year = minYear;
    if (year > maxYear) year = maxYear;

    return `/api/${year}/${file}`;
  }
</script>

 <div class="tabs" role="tablist" aria-label="× ×™×”×•×œ ××¢×¨×›×ª">
    <button class="tab-button active" data-tab="studentsTab" role="tab" aria-selected="true" aria-controls="studentsTab">× ×™×”×•×œ ×ª×œ××™×“×™×</button>
    <button class="tab-button" data-tab="booksTab" role="tab" aria-selected="false" aria-controls="booksTab">× ×™×”×•×œ ×¡×¤×¨×™×</button>
    <button class="tab-button" data-tab="borrowTab" role="tab" aria-selected="false" aria-controls="borrowTab">× ×™×”×•×œ ×”×©××œ×•×ª ×•×¨×›×™×©×•×ª</button>
    <button class="tab-button" data-tab="returnTab" role="tab" aria-selected="false" aria-controls="returnTab">× ×™×”×•×œ ×”×—×–×¨×•×ª ×•×—×™×•×‘×™×</button>
  </div>

<div id="successMsg"></div>
<div id="confirmBorrowModal" style="display:none; position:fixed; top:0; right:0; bottom:0; left:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:500px; width:90%;">
    <h3>ğŸ“‹ ××™×©×•×¨ ×”×©××œ×”</h3>
    <ul id="borrowBookList" style="text-align:right; padding-right:20px;"></ul>

    <label for="borrowerTypeSelect" style="display:block; margin-top:10px;">
  ××™ ××©××™×œ?
  <select id="borrowerTypeSelect" style="width: 100%; margin-top: 5px;">
    <option value="student">×ª×œ××™×“</option>
    <option value="parent">×”×•×¨×”\×—×‘×¨</option>
    <option value="staff">×‘×¢×œ ×ª×¤×§×™×“</option>
  </select>
</label>

<label for="borrowerNameInput" style="display:none; margin-top:10px;">
  ×©× ××œ× (×œ'×”×•×¨×”\×—×‘×¨' ×•'×‘×¢×œ ×ª×¤×§×™×“')
  <input id="borrowerNameInput" type="text" style="width: 100%;" placeholder="×”×§×œ×“ ×©× ××œ×">
</label>

    <label style="display:block; margin-top:10px;">
      <input type="checkbox" id="confirmBorrowCheckbox">
      ×× ×™ ×××©×¨/×ª ×©×§×™×‘×œ×ª×™ ××ª ×›×œ ×¡×¤×¨×™ ×”×œ×™××•×“ ×”××¦×•×™× ×™× ×œ×¢×™×œ, ×‘××¦×‘ ×ª×§×™×Ÿ
    </label>

    <div style="margin-top:15px;">
      <p style="margin-bottom:5px;">âœï¸ ×—×ª×™××”:</p>
      <div id="signatureContainer">
<canvas id="signaturePad"></canvas>
      <button onclick="clearSignature()" style="margin-top:5px;">ğŸ§¹ × ×§×” ×—×ª×™××”</button>
      </div>
    </div>

    <div style="margin-top:15px; text-align:left;">
      <button onclick="finalizeBorrow()" style="margin-left:10px;">âœ”ï¸ ××©×¨</button>
      <button onclick="closeBorrowModal()">âŒ ×‘×˜×œ</button>
    </div>
  </div>
</div>

<script>
  document.getElementById('borrowerTypeSelect').addEventListener('change', e => {
  const val = e.target.value;
  const nameInputLabel = document.getElementById('borrowerNameInput').parentElement;
  if (val === 'student') {
    nameInputLabel.style.display = 'none';
    document.getElementById('borrowerNameInput').value = '';
  } else {
    nameInputLabel.style.display = 'block';
  }
});
</script>

<div id="bulkLendModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
    <h3>ğŸ“¦ ×”×©××œ×” ××¨×•×›×–×ª</h3>

    <p>×‘×—×¨ ×¡×¤×¨×™× ×œ×”×©××œ×” ×œ×›×œ ×”×ª×œ××™×“×™× ×©×‘×¨×©×™××”:</p>

    <input id="bulkSearchBookInput" placeholder="ğŸ” ×—×¤×© ×œ×¤×™ ×©× ×¡×¤×¨" oninput="filterBulkBooks()">
    <input id="bulkSubjectFilter" placeholder="ğŸ” ×¡×™× ×•×Ÿ ×œ×¤×™ ××§×¦×•×¢" oninput="filterBulkBooks()">
    
    <select id="bulkLevelFilter" onchange="filterBulkBooks()">
      <option value="">×¨××ª ×œ×™××•×“</option>
      <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
      <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
      <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
    </select>

    <select id="bulkGradeFilter" onchange="filterBulkBooks()">
      <option value="">×©×›×‘×ª ×’×™×œ</option>
      <option value="×–">×–</option>
      <option value="×—">×—</option>
      <option value="×˜">×˜</option>
      <option value="×™">×™</option>
      <option value="×™×">×™×</option>
      <option value="×™×‘">×™×‘</option>
    </select>

    <div id="bulkBooksSelect" class="checkbox-list" style="margin: 10px 0;">

    </div>

    <div id="bulkBooksSelectOptions">
      <button onclick="selectAllFilteredBulkBooks()">×‘×—×¨ ××ª ×›×œ ×”×¡×¤×¨×™× ×”××•×¦×’×™×</button>
      <button onclick="selectedBulkBookIds.clear(); filterBulkBooks();">×‘×˜×œ ××ª ×›×œ ×”×‘×—×™×¨×•×ª</button>
    </div>
    <label><input type="checkbox" id="bulkConfirmCheckbox"> ×× ×™ ×××©×¨/×ª ×”×©××œ×” ××¨×•×›×–×ª ×‘×©× ×›×œ ×”×ª×œ××™×“×™×</label>
    
    <p>âœï¸ ×—×ª×™××ª ×‘×¢×œ ×ª×¤×§×™×“:</p>
    <div id="bulkSignatureContainer">
    <canvas id="bulkSignaturePad" style="border:2px solid #007bff; background-color:#f0f8ff; width:100%; height:150px;"></canvas>
    <button onclick="clearBulkSignature()">ğŸ§¹ × ×§×” ×—×ª×™××”</button>
    </div>
    <div style="text-align:left; margin-top:20px;">
      <button onclick="confirmBulkLend()">âœ”ï¸ ××©×¨</button>
      <button onclick="document.getElementById('bulkLendModal').style.display='none'">âŒ ×‘×˜×œ</button>
    </div>
  </div>
</div>


<!-- ××–×•×¨ × ×™×”×•×œ ×ª×œ××™×“×™× -->
   <div id="studentsTab" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="studentsTab">
<div class="container">
  <h2>â• ×”×•×¡×¤×ª ×ª×œ××™×“</h2>
  <label>×©× ××œ× <input id="studentName"></label>
  <label>×ª×¢×•×“×ª ×–×”×•×ª <input id="studentID"></label>
  <label>×‘×™×ª ×¡×¤×¨
    <select id="studentSchool">
      <option value="×§×¦×™×¨ ×">×§×¦×™×¨ ×</option>
      <option value="×§×¦×™×¨ ×‘">×§×¦×™×¨ ×‘</option>
      <option value="×ª×™×›×•×Ÿ">×ª×™×›×•×Ÿ</option>
    </select>
  </label>
  <label>×›×™×ª×” (×œ××©×œ: ×™1) <input id="studentClass"></label>
    <label>××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜ ×”×©××œ×ª ×¡×¤×¨×™×:
  <select id="studentInLoanProject" required>
    <option value="" disabled selected>×‘×—×¨</option>
    <option value="true">×›×Ÿ</option>
    <option value="false">×œ×</option>
  </select>
</label>
  <button onclick="addStudent()">×”×•×¡×£ ×ª×œ××™×“</button>
  <label class="bolded">×™×™×‘×•×</label><input type="file" accept=".xlsx" onchange="importExcel(event, 'students')">

</div>

  <div class="container">
  <h2>âœï¸ ×¨×©×™××ª ×ª×œ××™×“×™×</h2>
  <button onclick="openBulkLendModal()">ğŸ“š ×”×©××œ×” ××¨×•×›×–×ª ×œ×›×œ ×”×ª×œ××™×“×™× ×‘×¨×©×™××”</button>
  <label> ×¡×™× ×•×Ÿ ×ª×œ××™×“×™×:
    <input id="studentTableSearch" placeholder="×¡× ×Ÿ ×œ×¤×™ ×©×/×ª\"×–/×›×™×ª×”/×‘×™"×¡">
  </label>
  <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px;">
  <label>×¡× ×Ÿ ×œ×¤×™ ×©×›×‘×”:
    <select id="filterGrade" onchange="renderStudentTable()">
      <option value="">×”×›×œ</option>
      <option value="×–">×–</option>
      <option value="×—">×—</option>
      <option value="×˜">×˜</option>
      <option value="×™">×™</option>
      <option value="×™×">×™×</option>
      <option value="×™×‘">×™×‘</option>
    </select>
  </label>

  <label>×¡× ×Ÿ ×œ×¤×™ ×›×™×ª×” (×œ××©×œ ×™3):
    <input id="filterClassroom" oninput="renderStudentTable()" placeholder="×›×’×•×Ÿ: ×™3" />
  </label>

  <label>××§×¦×•×¢ ×œ×¡×™× ×•×Ÿ ×¡×¤×¨×™×:
    <input id="filterSubject" oninput="renderStudentTable()" placeholder="×›×’×•×Ÿ: ××ª××˜×™×§×”" />
  </label>

  <label>×¨××ª ×œ×™××•×“:
    <select id="filterLevel" onchange="renderStudentTable()">
      <option value="">×”×›×œ</option>
      <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
      <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
      <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
    </select>
  </label>

  <label>×¡×™× ×•×Ÿ ×œ×¤×™ ×”×©×ª×ª×¤×•×ª ×‘×¤×¨×•×™×§×˜:
  <select id="filterInLoanProject" onchange="renderStudentTable()">
    <option value="">×”×›×œ</option>
    <option value="true">×›×Ÿ</option>
    <option value="false">×œ×</option>
  </select>
</label>
</div>


  <table id="studentTable">
<thead>
  <tr>
    <th style="text-align: right;">×©×</th>
    <th style="text-align: center;">×ª"×–</th>
    <th style="text-align: center;">×›×™×ª×”</th>
    <th style="text-align: center;">×‘×™"×¡</th>
    <th style="text-align: center;">×—×•×‘</th>
    <th style="text-align: right;">×¡×¤×¨×™× ××•×©××œ×™×</th>
    <th style="text-align: center;">×–×× ×™ ×”×©××œ×”</th>
    <th style="text-align: center;">×–×× ×™ ×”×—×–×¨×”\×ª×©×œ×•×</th>
    <th style="text-align: center;">×¤×¢×•×œ×•×ª</th>
  </tr>
</thead>
    <tbody></tbody>
  </table>
<br>
<button onclick="deleteFilteredStudents()">××—×§ ××ª ×›×œ ×”×ª×œ××™×“×™× ×©×‘×ª×¦×•×’×”</button>
<button onclick="exportFilteredStudents()">×™×™×¦× ××ª ×›×œ ×”×ª×œ××™×“×™× ×©×‘×ª×¦×•×’×”</button>
</div>
   </div>

<!-- ××–×•×¨ × ×™×”×•×œ ×¡×¤×¨×™× -->
   <div id="booksTab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="booksTab">
<div class="container">
  <h2>ğŸ“š ×”×•×¡×¤×ª ×¡×¤×¨</h2>
 <label>×©× ×”×¡×¤×¨ <input id="bookName"></label>
<label>××§×¦×•×¢ <input id="bookSubject"></label>
<label>×©×›×‘×ª ×’×™×œ <input id="bookGrade"></label>
<label>×¨××ª ×œ×™××•×“
  <select id="bookLevel">
    <option value="×›×œ×œ×™">×›×œ×œ×™</option>
    <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
    <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
    <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
  </select>
</label>

<label>×›×¨×š
  <select id="bookVolume" required>
    <option value="" disabled selected>×‘×—×¨ ×›×¨×š</option>
    <option value="×™×—×™×“">×™×—×™×“</option>
    <option value="×">×</option>
    <option value="×‘">×‘</option>
    <option value="×’">×’</option>
    <option value="×“">×“</option>
  </select>
</label>

<label>×©× ×”×•×¦××” <input id="bookPublisher" required></label>

<label>×¡×•×’ ×”×¡×¤×¨
  <select id="bookType" required>
    <option value="" disabled selected>×‘×—×¨ ×¡×•×’ ×¡×¤×¨</option>
    <option value="×¡×¤×¨">×¡×¤×¨</option>
    <option value="×—×•×‘×¨×ª">×—×•×‘×¨×ª</option>
    <option value="×—×•×‘×¨×ª ×¤× ×™××™×ª">×—×•×‘×¨×ª ×¤× ×™××™×ª</option>
  </select>
</label>

<button onclick="addBook()">×”×•×¡×£ ×¡×¤×¨</button>

  <button onclick="exportToExcel(books, 'books')">ğŸ“¤ ×™×™×¦×•× ×¡×¤×¨×™×</button>
  <input type="file" accept=".xlsx" onchange="importExcel(event, 'books')">
</div>

<!-- ××•×“×œ ×¢×¨×™×›×ª ×¡×¤×¨ -->
<div id="editBookModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%;">
    <h3>×¢×¨×™×›×ª ×¤×¨×˜×™ ×¡×¤×¨</h3>
    <label>×©× ×”×¡×¤×¨ <input id="editBookName" type="text"></label>
    <label>××§×¦×•×¢ <input id="editBookSubject" type="text"></label>
    <label>×©×›×‘×ª ×’×™×œ <input id="editBookGrade" type="text"></label>
    <label>×¨××ª ×œ×™××•×“
      <select id="editBookLevel">
        <option value="×›×œ×œ×™">×›×œ×œ×™</option>
        <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
        <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
        <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
      </select>
    </label>
    <label>×›×¨×š
      <select id="editBookVolume">
        <option value="×™×—×™×“">×™×—×™×“</option>
        <option value="×">×</option>
        <option value="×‘">×‘</option>
        <option value="×’">×’</option>
        <option value="×“">×“</option>
      </select>
    </label>
    <label>×©× ×”×•×¦××” <input id="editBookPublisher" type="text"></label>
    <label>×¡×•×’ ×”×¡×¤×¨
      <select id="editBookType">
        <option value="×¡×¤×¨">×¡×¤×¨</option>
        <option value="×—×•×‘×¨×ª">×—×•×‘×¨×ª</option>
        <option value="×—×•×‘×¨×ª ×¤× ×™××™×ª">×—×•×‘×¨×ª ×¤× ×™××™×ª</option>
      </select>
    </label>

    <div style="margin-top: 15px; text-align: left;">
      <button onclick="saveEditedBook()">ğŸ’¾ ×©××•×¨</button>
      <button onclick="closeEditBookModal()">âŒ ×‘×˜×œ</button>
    </div>
  </div>
</div>


<div class="container">
  <h2>ğŸ“š ×¨×©×™××ª ×¡×¤×¨×™×</h2>

  <label>×¡×™× ×•×Ÿ ×¡×¤×¨×™×:
    <input id="bookTableSearch" placeholder="×¡× ×Ÿ ×œ×¤×™ ×©×/××§×¦×•×¢/×©×›×‘×”/×”×•×¦××”/×¡×•×’/×›×¨×š">
  </label>

  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
    <label>×¨××”:
      <select id="bookLevelFilter" onchange="renderBookTable()">
        <option value="">×”×›×œ</option>
        <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
        <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
        <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
        <option value="×›×œ×œ×™">×›×œ×œ×™</option>
      </select>
    </label>

    <label>×›×¨×š:
      <select id="bookVolumeFilter" onchange="renderBookTable()">
        <option value="">×”×›×œ</option>
        <option value="×™×—×™×“">×™×—×™×“</option>
        <option value="×">×</option>
        <option value="×‘">×‘</option>
        <option value="×’">×’</option>
        <option value="×“">×“</option>
      </select>
    </label>

    <label>×”×•×¦××”:
      <input id="bookPublisherFilter" type="text" oninput="renderBookTable()" placeholder="×”×§×œ×“ ×©× ×”×•×¦××”">
    </label>

    <label>×¡×•×’ ×¡×¤×¨:
      <select id="bookTypeFilter" onchange="renderBookTable()">
        <option value="">×”×›×œ</option>
        <option value="×¡×¤×¨">×¡×¤×¨</option>
        <option value="×—×•×‘×¨×ª">×—×•×‘×¨×ª</option>
        <option value="×—×•×‘×¨×ª ×¤× ×™××™×ª">×—×•×‘×¨×ª ×¤× ×™××™×ª</option>
      </select>
    </label>
  </div>

  <table id="bookTable">
    <thead>
      <tr>
        <th style="text-align: right;">×©×</th>
        <th style="text-align: right;">××§×¦×•×¢</th>
        <th style="text-align: center;">×©×›×‘×”</th>
        <th style="text-align: center;">×¨××”</th>
        <th style="text-align: center;">×›×¨×š</th>
        <th style="text-align: center;">×”×•×¦××”</th>
        <th style="text-align: center;">×¡×•×’</th>
        <th style="text-align: center;">×¤×¢×•×œ×•×ª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="deleteFilteredBooks()">××—×§ ××ª ×›×œ ×”×¡×¤×¨×™× ×©×‘×ª×¦×•×’×”</button>
</div>

   </div>

<!-- ×”×©××œ×ª ×¡×¤×¨×™× -->
   <div id="borrowTab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="borrowTab">
<div class="container">
  <h2>×”×©××œ×ª\×¨×›×™×©×ª ×¡×¤×¨×™×</h2>
  <label class="bolded">×—×¤×© ×ª×œ××™×“ <input id="searchStudentInput" oninput="filterStudents()"></label>
  <select id="filteredStudentsSelect"></select>

 <label class="bolded">×—×¤×© ×¡×¤×¨ <input id="searchBookInput" oninput="filterBooks()"></label>
 <label class="bolded">×¡× ×Ÿ ×œ×¤×™ ×¨××ª ×œ×™××•×“:</label>
<select id="levelFilter" onchange="filterBooks()">
  <option value="">×”×›×œ</option>
  <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
  <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
  <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
</select>
<label>×¡× ×Ÿ ×œ×¤×™ ×›×¨×š:
  <select id="volumeFilter" onchange="filterBooks()">
    <option value="">×”×›×œ</option>
    <option value="×™×—×™×“">×™×—×™×“</option>
    <option value="×">×</option>
    <option value="×‘">×‘</option>
    <option value="×’">×’</option>
    <option value="×“">×“</option>
  </select>
</label>

<label>×¡× ×Ÿ ×œ×¤×™ ×”×•×¦××”:
  <input id="publisherFilter" type="text" oninput="filterBooks()" placeholder="×”×§×œ×“ ×©× ×”×•×¦××”">
</label>

<label>×¡× ×Ÿ ×œ×¤×™ ×¡×•×’:
  <select id="typeFilter" onchange="filterBooks()">
    <option value="">×”×›×œ</option>
    <option value="×¡×¤×¨">×¡×¤×¨</option>
    <option value="×—×•×‘×¨×ª">×—×•×‘×¨×ª</option>
    <option value="×—×•×‘×¨×ª ×¤× ×™××™×ª">×—×•×‘×¨×ª ×¤× ×™××™×ª</option>
  </select>
</label>
 <h5>×¡×¤×¨×™× ×œ×”×©××œ×”</h5>
<div id="filteredBooksSelect" class="checkbox-list"></div>
<br>
<button onclick="selectAllCheckboxes('filteredBooksSelect', true)">×‘×—×¨ ××ª ×›×œ ×”×¡×¤×¨×™× ×œ×”×©××œ×”</button>
<hr>
<button id="btnBorrow" onclick="openConfirmModal('×”×©××œ×”')">ğŸ“¥ ×”×©××œ</button>
<button id="btnPurchase" style="display:none;" onclick="openConfirmModal('×¨×›×™×©×”')">ğŸ›’ ×¨×›×™×©×”</button>

</div>
</div>

<div id="returnTab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="returnTab">
  <h2>×”×—×–×¨×ª\×—×™×•×‘ ×¡×¤×¨×™×</h2>
  <label class="bolded">×—×¤×© ×ª×œ××™×“ <input id="searchStudentInputReturn" oninput="filterStudentsReturn()"></label>
  <select id="filteredStudentsSelectReturn"></select>

  <label class="bolded">×—×¤×© ×¡×¤×¨ <input id="searchBookInputReturn" oninput="filterBooksReturn()"></label> <!-- ×”×•×¡×¤×” ×—×©×•×‘×” -->

  <label class="bolded">×¡× ×Ÿ ×œ×¤×™ ×¨××ª ×œ×™××•×“:</label>
  <select id="levelFilterReturn" onchange="filterBooksReturn()">
    <option value="">×”×›×œ</option>
    <option value="3 ×™×—×œ">3 ×™×—"×œ</option>
    <option value="4 ×™×—×œ">4 ×™×—"×œ</option>
    <option value="5 ×™×—×œ">5 ×™×—"×œ</option>
  </select>
  <label>×¡× ×Ÿ ×œ×¤×™ ×›×¨×š:
  <select id="volumeFilter" onchange="filterBooks()">
    <option value="">×”×›×œ</option>
    <option value="×™×—×™×“">×™×—×™×“</option>
    <option value="×">×</option>
    <option value="×‘">×‘</option>
    <option value="×’">×’</option>
    <option value="×“">×“</option>
  </select>
</label>

<label>×¡× ×Ÿ ×œ×¤×™ ×”×•×¦××”:
  <input id="publisherFilter" type="text" oninput="filterBooks()" placeholder="×”×§×œ×“ ×©× ×”×•×¦××”">
</label>

<label>×¡× ×Ÿ ×œ×¤×™ ×¡×•×’:
  <select id="typeFilter" onchange="filterBooks()">
    <option value="">×”×›×œ</option>
    <option value="×¡×¤×¨">×¡×¤×¨</option>
    <option value="×—×•×‘×¨×ª">×—×•×‘×¨×ª</option>
    <option value="×—×•×‘×¨×ª ×¤× ×™××™×ª">×—×•×‘×¨×ª ×¤× ×™××™×ª</option>
  </select>
</label>

  <h5>×¡×¤×¨×™× ×œ×”×—×–×¨×”</h5>
  <div id="returnBooksSelect" class="checkbox-list"></div>

  <br>
  <button onclick="selectAllCheckboxes('returnBooksSelect', true)">×‘×—×¨ ××ª ×›×œ ×”×¡×¤×¨×™× ×œ×”×—×–×¨×”</button>
  <br>
  <hr>
  <br>
  <button onclick="returnBook()">ğŸ“¤ ×”×—×–×¨</button>
  <button onclick="openChargeModal()">×—×™×•×‘ ×¢×‘×•×¨ ×‘×œ××™\××•×‘×“×Ÿ </button>

  <div id="chargeModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
      <h3>ğŸ’¸ ×—×™×•×‘ ×ª×œ××™×“ ×¢×‘×•×¨ ×¡×¤×¨×™× ×¤×’×•××™× ××• ××‘×•×“×™×</h3>
      <div id="chargeBooksList" class="checkbox-list"></div>
      <div style="text-align:left; margin-top:20px;">
        <button onclick="confirmCharge()">âœ”ï¸ ×—×™×™×‘ ×ª×œ××™×“</button>
        <button onclick="document.getElementById('chargeModal').style.display='none'">âŒ ×‘×˜×œ</button>
      </div>
    </div>
  </div>
</div>


<script>
  // ×¡×™× ×•×Ÿ ×ª×œ××™×“×™× ×‘×œ×©×•× ×™×ª ×”×—×–×¨×”

  const ITEMS_PER_PAGE = 50;

let currentStudentPage = 1;
let currentBookPage = 1;

function filterStudentsReturn() {
  const levelSelect = document.getElementById('levelFilterReturn');
  if (!levelSelect) {
    console.warn("Missing element: levelFilterReturn");
    return;
  }

  const levelFilter = levelSelect.value;
  const select = document.getElementById('filteredStudentsSelectReturn');
  if (!select) {
    console.warn("Missing element: filteredStudentsSelectReturn");
    return;
  }

  select.innerHTML = '';

  const filtered = borrowed.filter(b =>
    !returned.some(r => r.id === b.id) &&
    (!levelFilter || b.book.level === levelFilter)
  );

  const uniqueStudents = Array.from(new Set(filtered.map(b => b.student.id)))
    .map(id => students.find(s => s.id === id));

  uniqueStudents.forEach((student, i) => {
    const option = document.createElement('option');
    option.value = students.indexOf(student);
    option.textContent = student.name;
    select.appendChild(option);
  });

  if (select.options.length > 0) {
    updateReturnBooks(select.value);
  } else {
    const container = document.getElementById('returnBooksSelect');
    if (container) container.innerHTML = '<p>××™×Ÿ ×¡×¤×¨×™× ×œ×”×—×–×¨×”</p>';
  }
}



  // ×¡×™× ×•×Ÿ ×¡×¤×¨×™× ×œ×”×—×–×¨×” ×‘×˜××‘ ×”×—×–×¨×”
  function filterBooksReturn() {
    const searchInput = document.getElementById('searchBookInputReturn');
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const selectedLevel = document.getElementById('levelFilterReturn').value;
    const studentIdx = document.getElementById('filteredStudentsSelectReturn').value;
    const container = document.getElementById('returnBooksSelect');
    container.innerHTML = '';

    if (studentIdx === '') return;
    const student = students[studentIdx];
    if (!student) return;

    borrowed.forEach((b, i) => {
      const values = [b.book.name, b.book.subject, b.book.grade].map(x => (x || '').toLowerCase());

      const alreadyReturned = returned.some(r => r.id === b.id);

      if (
        b.student.id === student.id &&
        !alreadyReturned &&
        (selectedLevel === '' || b.book.level === selectedLevel) &&
        values.some(x => x.includes(search))
      ) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = b.id;  // ×©×™××•×© ×‘××–×”×” ×”×”×©××œ×”
        checkbox.id = 'return_' + i;

        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = `${b.book.name} (${b.book.subject}, ×©×›×‘×ª ${b.book.grade}${b.book.level ? `, ×¨××” ${b.book.level}` : ''})`;
        label.prepend(checkbox);

        container.appendChild(label);
      }
    });
  }

  // ×××–×™× ×™× ×œ××™×¨×•×¢×™× ×‘×œ×©×•× ×™×ª ×”×—×–×¨×”
  document.getElementById('searchStudentInputReturn').addEventListener('input', filterStudentsReturn);
  document.getElementById('filteredStudentsSelectReturn').addEventListener('change', filterBooksReturn);
  document.getElementById('searchBookInputReturn').addEventListener('input', filterBooksReturn);
  document.getElementById('levelFilterReturn').addEventListener('change', filterBooksReturn);

  // ×§×¨×™××” ×¨××©×•× ×™×ª ×œ×˜×¢×™× ×ª ×ª×œ××™×“×™× ×‘×œ×©×•× ×™×ª ×”×—×–×¨×”
  window.addEventListener('DOMContentLoaded', () => {
    filterStudentsReturn();
  });

  // ×¤×•× ×§×¦×™×” ×œ×‘×—×™×¨×ª ×›×œ ×ª×™×‘×•×ª ×”×¡×™××•×Ÿ
  function selectAllCheckboxes(containerId, checked) {
    const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
    checkboxes.forEach(cb => cb.checked = checked);
  }
</script>


<div id="studentDetailModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
    <h3>ğŸ“‹ ×¤×¨×˜×™ ×ª×œ××™×“</h3>
    <div id="studentDetailContent" style="text-align:right; line-height:1.8;"></div>
<div style="text-align:left; margin-top:20px;">
  <button onclick="closeStudentModal()">âŒ ×¡×’×•×¨</button>
</div>

  </div>
</div>
<button onclick="scrollToTop()" id="scrollTopBtn" title="×œ××¢×œ×”">â†‘</button>
<br>
<br>
  <footer>
    <b>Â© 2025 Aviv Ben-Amar. All rights reserved<br>

This software and its source code, including all associated files, designs, and data structures, are the intellectual property of Aviv Ben-Amar and are protected under applicable copyright laws<br>

Unauthorized copying, distribution, modification, or use of any part of this system is strictly prohibited without prior written consent
<br>
Violations may result in civil and/or criminal liability</b>
</footer>

<style>
.blink-highlight {
  animation: blink 0.5s ease-in-out 0s 2;
  outline: 3px solid #ff9800;
  outline-offset: 2px;
}
@keyframes blink {
  0% { outline-color: #ff9800; }
  50% { outline-color: transparent; }
  100% { outline-color: #ff9800; }
}
</style>



<script>
  
let students = [];
let books = [];
let borrowed = [];
let returned = [];
let returnToChargeMode = false;


function selectAllFilteredBulkBooks() {
  const checkboxes = document.querySelectorAll('#bulkBooksSelect input[type=checkbox]');
  checkboxes.forEach(cb => {
    cb.checked = true;
    selectedBulkBookIds.add(cb.value);
  });
}


window.addEventListener("DOMContentLoaded", () => {
  loadData().then(() => {
    console.log("âœ… ×›×œ ×”× ×ª×•× ×™× × ×˜×¢× ×•");
    renderStudentTable();  // ğŸŸ¢ ×¨×§ ×›××Ÿ ××•×ª×¨
    renderBookTable();
  });
});


let bulkCanvas, bulkCtx;

function openBulkLendModal() {
  selectedBulkBookIds = new Set();
  document.getElementById('bulkLendModal').style.display = 'flex';
  setTimeout(() => {
    bulkCanvas = document.getElementById('bulkSignaturePad');
    bulkCtx = bulkCanvas.getContext('2d');
    bulkCanvas.width = bulkCanvas.offsetWidth;
    bulkCanvas.height = bulkCanvas.offsetHeight;

    bulkCtx.clearRect(0, 0, bulkCanvas.width, bulkCanvas.height);
    bulkCtx.beginPath();

    bulkCanvas.addEventListener('pointerdown', e => {
      bulkCtx.moveTo(e.offsetX, e.offsetY);
      bulkCanvas.setPointerCapture(e.pointerId);
      bulkCanvas.isDrawing = true;
    });

    bulkCanvas.addEventListener('pointermove', e => {
      if (bulkCanvas.isDrawing) {
        bulkCtx.lineTo(e.offsetX, e.offsetY);
        bulkCtx.stroke();
      }
    });

    ['pointerup', 'pointerleave'].forEach(evt =>
      bulkCanvas.addEventListener(evt, () => (bulkCanvas.isDrawing = false))
    );

    filterBulkBooks();
  }, 100);
}

function clearBulkSignature() {
  if (bulkCtx) {
    bulkCtx.clearRect(0, 0, bulkCanvas.width, bulkCanvas.height);
    bulkCtx.beginPath(); // ××•×¡×™×£ ××™×¤×•×¡ ×××™×ª×™
  }
}

function isBulkSignatureEmpty() {
  const blank = document.createElement('canvas');
  blank.width = bulkCanvas.width;
  blank.height = bulkCanvas.height;
  return bulkCanvas.toDataURL() === blank.toDataURL();
}

function openConfirmModal(actionType) {
  const modal = document.getElementById('confirmBorrowModal');
  const title = modal.querySelector('h3');
  const confirmBtn = modal.querySelector('button[onclick="finalizeBorrow()"]');

  // ×©×™× ×•×™ ×”×˜×§×¡×˜×™× ×œ×¤×™ ×”×¤×¢×•×œ×”
  if (actionType === '×”×©××œ×”') {
    title.textContent = 'ğŸ“‹ ××™×©×•×¨ ×”×©××œ×”';
    confirmBtn.textContent = 'âœ”ï¸ ××©×¨';
  } else if (actionType === '×¨×›×™×©×”') {
    title.textContent = 'ğŸ“‹ ××™×©×•×¨ ×”×¨×›×™×©×”';
    confirmBtn.textContent = 'âœ”ï¸ ××©×¨ ×¨×›×™×©×”';
  }

  modal.style.display = 'flex';
  window.currentActionType = actionType;
}


function filterBulkBooks() {
  const container = document.getElementById('bulkBooksSelect');
  container.innerHTML = '';

  const search = document.getElementById('bulkSearchBookInput').value.toLowerCase();
  const subject = document.getElementById('bulkSubjectFilter').value.toLowerCase();
  const level = document.getElementById('bulkLevelFilter').value;
  const grade = document.getElementById('bulkGradeFilter').value;

  books.forEach((b, i) => {
    const nameMatch = !search || (b.name || '').toLowerCase().includes(search);
    const subjectMatch = !subject || (b.subject || '').toLowerCase().includes(subject);
    const levelMatch = !level || b.level === level;
    const gradeMatch = !grade || b.grade === grade;

    if (nameMatch && subjectMatch && levelMatch && gradeMatch) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = b.id; // ×©×™××•×© ×‘Ö¾id ×‘××§×•× index
      checkbox.id = 'bulk_' + b.id;
      checkbox.checked = selectedBulkBookIds.has(b.id); // ×©××™×¨×ª ×¡×™××•×Ÿ

      checkbox.addEventListener('change', e => {
        if (e.target.checked) {
          selectedBulkBookIds.add(b.id);
        } else {
          selectedBulkBookIds.delete(b.id);
        }
      });

      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = `${b.name} (${b.subject}, ×©×›×‘×ª ${b.grade})`;
      label.prepend(checkbox);

      container.appendChild(label);
    }
  });
}

function printStudentCard(index) {
  const student = students[index];
  if (!student) return;

  const studentUnreturned = borrowed.filter(b =>
    b.student.id === student.id &&
    !returned.some(r => r.id === b.id) &&
    !charges.some(c => c.studentId === student.id && c.borrowId === b.id)
  );

  const unpaidCharges = charges.filter(c => c.studentId === student.id && !c.paid);
  const logoPath = 'katzir-logo.jpeg';

  const content = `
    <div style="font-family: Arial; direction: rtl; padding: 20px; text-align: center;">
      <img src="${logoPath}" alt="×¡××œ ×‘×™×ª ×¡×¤×¨" style="width: 100px;">
      <h2 style="margin: 5px 0;">×›×¨×˜×™×¡ ×ª×œ××™×“</h2>
      <p><b>×©×:</b> ${student.name}</p>
      <p><b>×ª"×–:</b> ${student.id}</p>
      <p><b>×›×™×ª×”:</b> ${student.classroom} | <b>×‘×™"×¡:</b> ${student.school}</p>

      ${
        (studentUnreturned.length > 0 || unpaidCharges.length > 0)
        ? `
          ${studentUnreturned.length > 0 ? `
            <h4 style="margin-top: 15px;">×¡×¤×¨×™× ×©×˜×¨× ×”×•×—×–×¨×•:</h4>
            <ul style="text-align: right; font-size: 14px;">
              ${studentUnreturned.map(b => `<li>${b.book.name} (${b.book.subject})</li>`).join('')}
            </ul>
          ` : ''}
          ${unpaidCharges.length > 0 ? `
            <h4 style="margin-top: 15px;">×¡×¤×¨×™× ×©×—×•×™×‘×• (×œ× ×©×•×œ×):</h4>
            <ul style="text-align: right; font-size: 14px;">
              ${unpaidCharges.map(c => `<li>${c.bookName} (${c.type})</li>`).join('')}
            </ul>
          ` : ''}
        `
        : `<p style="margin-top: 15px; font-size: 16px; color: green;"><b>×”×—×–×™×¨/×” ×”×›×œ</b></p>`
      }
    </div>
  `;

  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html lang="he" dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>×›×¨×˜×™×¡ ×ª×œ××™×“</title>
      <style>
        @media print {
          body { width: 105mm; height: 148mm; margin: 0; } /* A6 */
        }
      </style>
    </head>
    <body>
      ${content}
      <script>
        window.onload = () => window.print();
      <\/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}



function confirmBulkLend() {
  if (!document.getElementById('bulkConfirmCheckbox').checked)
    return alert("×™×© ×œ××©×¨ ××ª ×”×”×¦×”×¨×”");

  if (isBulkSignatureEmpty())
    return alert("×—×ª×™××” × ×“×¨×©×ª");

const selectedBooks = Array.from(document.querySelectorAll('#bulkBooksSelect input[type=checkbox]:checked'))
  .map(cb => books.find(b => b.id === cb.value))
  .filter(Boolean); // ××¡× ×Ÿ undefined ×× ×™×© ×‘×¢×™×”
  if (selectedBooks.length === 0) return alert("×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×¨ ××—×“");

  const filteredStudents = students.filter((s, i) => {
    const search = document.getElementById('studentTableSearch').value.toLowerCase();
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());
    return values.some(v => v.includes(search) || search === '');
  });

  const now = new Date().toISOString();
  const signatureData = bulkCanvas.toDataURL();
  let count = 0;
  const bulkId = crypto.randomUUID(); // ××–×”×” ×§×‘×•×¦×ª ×”×”×©××œ×”

  filteredStudents.forEach(student => {
    selectedBooks.forEach(book => {
      const already = borrowed.some(b =>
        b.student.id === student.id &&
        b.book.id === book.id &&
        !returned.some(r => r.id === b.id)
      );

      if (!already) {
borrowed.push({
  id: crypto.randomUUID(),
  student,
  book,
  date: now,
  signature: signatureData,
  bulkId: bulkId
});
        count++;
      }
    });
  });

  if (count === 0) {
    alert("×›×œ ×”×¡×¤×¨×™× ×©× ×‘×—×¨×• ×›×‘×¨ ×”×•×©××œ×• ×œ×›×œ ×”×ª×œ××™×“×™×");
  } else {
    saveData();
    showSuccess(`×”×•×©××œ×• ${count} ×¡×¤×¨×™× ×œ×ª×œ××™×“×™×`);
  }

  document.getElementById('bulkLendModal').style.display = 'none';
  filterBooks();
  renderStudentTable();
}

    function selectAllCheckboxes(containerId, checked) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  checkboxes.forEach(cb => cb.checked = checked);
}

function renderStudentTable(page = 1) {
  currentStudentPage = page;

  const tbody = document.querySelector('#studentTable tbody');
  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  const filterGrade = document.getElementById('filterGrade').value;
  const filterClassroom = document.getElementById('filterClassroom').value.toLowerCase();
  const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
  const filterLevel = document.getElementById('filterLevel').value;
  const filterInLoanProject = document.getElementById('filterInLoanProject')?.value || '';

  tbody.innerHTML = '';

  // ×¡×™× ×•×Ÿ ×”×ª×œ××™×“×™× ×œ×¤×™ ×”×§×¨×™×˜×¨×™×•× ×™×
  const filteredStudents = students.filter(s => {
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());

    const chargedBorrowIds = new Set(
      charges.filter(c => c.studentId === s.id && !c.paid).map(c => c.borrowId)
    );

    const passSearch = values.some(v => v.includes(search)) || search === '';
    const passGrade = !filterGrade || s.classroom?.startsWith(filterGrade);
    const passClassroom = !filterClassroom || (s.classroom || '').toLowerCase() === filterClassroom;

    const hasMatchingBook = borrowed.some(b => {
      if (b.student.id !== s.id) return false;

      const subjectMatch = !filterSubject || (b.book.subject || '').toLowerCase().trim().includes(filterSubject.trim());
      const levelMatch =
        !filterLevel ||
        b.book.level === filterLevel ||
        (!b.book.level && filterLevel === '') ||
        (b.book.level === '×›×œ×œ×™' && filterLevel === '');

      const notChargedOrPaid = !chargedBorrowIds.has(b.id);

      return subjectMatch && levelMatch && notChargedOrPaid;
    });

    const passSubjectAndLevel = (!filterSubject && !filterLevel) || hasMatchingBook;

    const passInLoanProject =
      filterInLoanProject === '' ||
      (filterInLoanProject === 'true' && s.inLoanProject === true) ||
      (filterInLoanProject === 'false' && s.inLoanProject === false);

    return passSearch && passGrade && passClassroom && passSubjectAndLevel && passInLoanProject;
  });

  const totalPages = Math.ceil(filteredStudents.length / ITEMS_PER_PAGE);
  if (page > totalPages) currentStudentPage = 1;

  const pagedStudents = filteredStudents.slice((currentStudentPage - 1) * ITEMS_PER_PAGE, currentStudentPage * ITEMS_PER_PAGE);

  pagedStudents.forEach((s, i) => {
    const actualIndex = (currentStudentPage - 1) * ITEMS_PER_PAGE + i;

    const chargedBorrowIds = new Set(
      charges.filter(c => c.studentId === s.id && !c.paid).map(c => c.borrowId)
    );

    // ×”×•×¡×¤×ª×™ ×›×¨×š ×‘×¡×•×’×¨×™×™× ×œ×¦×“ ×”××§×¦×•×¢
    const borrowedBooks = borrowed
      .filter(b => b.student.id === s.id && !returned.some(r => r.id === b.id) && !chargedBorrowIds.has(b.id))
      .map(b => `${b.book.name} (${b.book.subject}, ×›×¨×š ${b.book.volume})`);

    // ×›×œ ×¡×¤×¨ ×‘Ö¾div × ×¤×¨×“ ×œ×”×¤×¨×“×” ×•×©×•×¨×•×ª ×‘×¨×•×¨×•×ª
    const borrowedListHTML = borrowedBooks.length > 0
      ? borrowedBooks.map(book => `<div style="padding: 2px 0;">${book}</div>`).join('')
      : "<div style='color: green;'>×”×—×–×™×¨ ×”×›×œ</div>";

    const nameStyleColor = s.inLoanProject ? 'green' : 'red';

    // ×œ×”×¡×¨×ª ×›×¤×™×œ×•×™×•×ª ×©×œ bulkId ×‘×ª××¨×™×›×™ ×”×©××œ×”
    const seenBulkIds = new Set();
    const borrowTimes = borrowed
      .filter(b => b.student.id === s.id)
      .filter(b => {
        if (b.bulkId && seenBulkIds.has(b.bulkId)) return false;
        if (b.bulkId) {
          seenBulkIds.add(b.bulkId);
          return true;
        }
        return true;
      })
      .map(b => new Date(b.date).toLocaleString('he-IL'));

    const borrowTimesText = borrowTimes.length > 0 ? borrowTimes.join('<br>') : '××™×Ÿ ×”×©××œ×•×ª';

    const seenReturnBulkIds = new Set();
    const returnTimes = returned
      .filter(r => r.student.id === s.id)
      .filter(r => {
        if (r.bulkId && seenReturnBulkIds.has(r.bulkId)) return false;
        if (r.bulkId) {
          seenReturnBulkIds.add(r.bulkId);
          return true;
        }
        return true;
      })
      .map(r => new Date(r.returnDate).toLocaleString('he-IL'));

    const returnTimesText = returnTimes.length > 0 ? returnTimes.join('<br>') : '××™×Ÿ ×”×—×–×¨×•×ª';

    const studentCharges = charges.filter(c => c.studentId === s.id);
    const unpaidCharges = studentCharges.filter(c => !c.paid);
    const totalDebt = unpaidCharges.length * 50;

    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #ddd';

    tr.innerHTML = `
      <td style="padding: 10px; max-width: 180px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: ${nameStyleColor}; vertical-align: top;" title="${s.name}">${s.name}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center; vertical-align: top;">${s.id}</td>
      <td style="padding: 10px; min-width: 60px; text-align: center; vertical-align: top;">${s.classroom}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center; vertical-align: top;">${s.school}</td>
      <td style="padding: 10px; min-width: 80px; text-align: center; vertical-align: top;">${totalDebt > 0 ? totalDebt + ' ×©"×—' : '×œ×œ×'}</td>

      <td class="borrowed-books-cell" style="vertical-align: top;">
        ${borrowedListHTML}
      </td>

      <td style="padding: 10px; min-width: 180px; text-align: center; vertical-align: top;">${borrowTimesText}</td>
      <td style="padding: 10px; min-width: 180px; text-align: center; vertical-align: top;">${returnTimesText}</td>
      <td style="padding: 10px; text-align: center; vertical-align: top;">
        <button onclick="editStudent(${actualIndex});" title="×¢×¨×™×›×ª ×¤×¨×˜×™ ×ª×œ××™×“"><i class="fas fa-pencil"></i></button>
        <button onclick="deleteStudentFromTable(${actualIndex})" title="××—×§ ×ª×œ××™×“"><i class="fas fa-trash"></i></button>
        <button onclick="exportSingleStudent(${actualIndex})" title="×™×™×¦× ×¤×¨×˜×™ ×ª×œ××™×“"><i class="fas fa-download"></i></button>
        <button onclick="viewStudentDetails(${actualIndex})" title="×¦×¤×™×™×” ×‘×¤×¨×˜×™ ×”×ª×œ××™×“"><i class="fas fa-eye"></i></button>
        ${totalDebt > 0 ? `<button onclick="clearStudentDebt('${s.id}')" title="× ×™×§×•×™ ×—×•×‘ ×”×ª×œ××™×“"><i class="fas fa-dollar-sign"></i></button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });

  renderStudentPagination(totalPages);
}

function renderStudentPagination(totalPages) {
  let paginationContainer = document.getElementById('studentPagination');
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'studentPagination';
    document.getElementById('studentTable').parentNode.insertBefore(paginationContainer, document.getElementById('studentTable').nextSibling);
  }
  paginationContainer.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.classList.toggle('active', i === currentStudentPage);
    btn.disabled = (i === currentStudentPage);
    btn.onclick = () => renderStudentTable(i);
    paginationContainer.appendChild(btn);
  }
}

 
  const tbody = document.querySelector('#studentTable tbody');
  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  tbody.innerHTML = '';

  const filterGrade = document.getElementById('filterGrade').value;
  const filterClassroom = document.getElementById('filterClassroom').value.toLowerCase();
  const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
  const filterLevel = document.getElementById('filterLevel').value;

  students.forEach((s, i) => {
    const values = [s.name, s.id, s.classroom, s.school];

    const hasMatchingBook = borrowed.some(b => {
      if (b.student.id !== s.id) return false;

      const subjectMatch = !filterSubject || (b.book.subject || '').toLowerCase().trim().includes(filterSubject.trim());
      const levelMatch =
        !filterLevel ||
        b.book.level === filterLevel ||
        (!b.book.level && filterLevel === '') ||
        (b.book.level === '×›×œ×œ×™' && filterLevel === '');

      return subjectMatch && levelMatch;
    });

    const passSearch = values.some(v => (v || '').toLowerCase().includes(search)) || search === '';
    const passGrade = !filterGrade || s.classroom?.startsWith(filterGrade);
    const passClassroom = !filterClassroom || (s.classroom || '').toLowerCase() === filterClassroom;
    const passSubjectAndLevel = (!filterSubject && !filterLevel) || hasMatchingBook;

    if (passSearch && passGrade && passClassroom && passSubjectAndLevel) {
      const tr = document.createElement('tr');

      const borrowedBooks = borrowed
        .filter(b => b.student.id === s.id && !returned.some(r => r.id === b.id))
        .map(b => `${b.book.name} (${b.book.subject})`);

      const borrowedText = borrowedBooks.length > 0 ? borrowedBooks.join(', ') : "×”×—×–×™×¨ ×”×›×œ";

      // âœ… ×ª×™×§×•×Ÿ: ×œ× ××¦×™×’×™× ×ª××¨×™×›×™× ×›×¤×•×œ×™× ×‘××•×ª×” ×”×©××œ×” ××¨×•×›×–×ª (bulkId)
      const seenBulkIds = new Set();
      const borrowTimes = borrowed
        .filter(b => b.student.id === s.id)
        .filter(b => {
          if (b.bulkId && seenBulkIds.has(b.bulkId)) return false;
          if (b.bulkId) {
            seenBulkIds.add(b.bulkId);
            return true;
          }
          return true; // ×”×¦×’ ×’× ×× ××™×Ÿ bulkId
        })
        .map(b => new Date(b.date).toLocaleString('he-IL'));

      const borrowTimesText = borrowTimes.length > 0 ? borrowTimes.join('<br>') : '××™×Ÿ ×”×©××œ×•×ª';

const seenReturnBulkIds = new Set();
const returnTimes = returned
  .filter(r => r.student.id === s.id)
  .filter(r => {
    if (r.bulkId && seenReturnBulkIds.has(r.bulkId)) return false;
    if (r.bulkId) {
      seenReturnBulkIds.add(r.bulkId);
      return true;
    }
    return true; // ×”×¦×’ ×’× ×× ××™×Ÿ bulkId
  })
  .map(r => new Date(r.returnDate).toLocaleString('he-IL'));


      const returnTimesText = returnTimes.length > 0 ? returnTimes.join('<br>') : '××™×Ÿ ×”×—×–×¨×•×ª';

      tr.innerHTML = `
<td style="padding: 10px; max-width: 180px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${s.name}">${s.name}</td>
<td style="padding: 10px; min-width: 100px; text-align: center;">${s.id}</td>
<td style="padding: 10px; min-width: 60px; text-align: center;">${s.classroom}</td>
<td style="padding: 10px; min-width: 100px; text-align: center;">${s.school}</td>
<td style="padding: 10px; max-width: 200px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${borrowedText}">${borrowedText}</td>
<td style="padding: 10px; min-width: 180px; text-align: center;">${borrowTimesText}</td>
<td style="padding: 10px; min-width: 180px; text-align: center;">${returnTimesText}</td>
<td style="padding: 10px; text-align: center;">
  <button onclick="selectStudent(${i}); scrollToSection('borrowSection')">×”×©××œ</button>
  <button onclick="selectStudent(${i}); scrollToSection('borrowSection')">×”×—×–×¨</button>
  <button onclick="deleteStudentFromTable(${i})">××—×§</button>
  <button onclick="exportSingleStudent(${i})">×™×™×¦×</button>
  <button onclick="viewStudentDetails(${i})">×¦×¤×™×™×”</button>
</td>
      `;

      tr.style.borderBottom = '1px solid #ddd';
      tbody.appendChild(tr);
    }
  });

function exportFilteredStudents() {
  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  const filterInLoanProject = document.getElementById('filterInLoanProject').value;

  const filtered = students.filter(s => {
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());

    const passInLoanProject =
      filterInLoanProject === '' ||
      (filterInLoanProject === 'true' && s.inLoanProject === true) ||
      (filterInLoanProject === 'false' && s.inLoanProject === false);

    return values.some(v => v.includes(search) || search === '') && passInLoanProject;
  });

  const headers = [
    "×©× ××œ×",
    "×ª×¢×•×“×ª ×–×”×•×ª",
    "×‘×™×ª ×¡×¤×¨",
    "×›×™×ª×”",
    "××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜ ×”×©××œ×ª ×¡×¤×¨×™×",  // ×”×•×¡×¤×”
    "×¡×¤×¨×™× ×©×”×•×©××œ×•",
    "×¡×¤×¨×™× ×©×—×•×™×‘×•",
    "×—×•×‘ ×›×•×œ×œ (â‚ª)"
  ];

  const rows = filtered.map(student => {
    const borrowedBooks = borrowed
      .filter(b => b.student.id === student.id && !returned.some(r => r.id === b.id))
      .map(b => `${b.book.name} (${b.book.subject})`)
      .join(', ') || "××™×Ÿ";

    const unpaidCharges = charges.filter(c => c.studentId === student.id && !c.paid);
    const chargedBooks = unpaidCharges.map(c => `${c.bookName} (${c.type})`).join(', ') || "××™×Ÿ";
    const totalDebt = unpaidCharges.length * 50;

    return [
      student.name,
      student.id,
      student.school,
      student.classroom,
      student.inLoanProject ? "×›×Ÿ" : "×œ×",  // ×”×•×¡×¤×”
      borrowedBooks,
      chargedBooks,
      totalDebt > 0 ? totalDebt : "0"
    ];
  });

  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '×ª×œ××™×“×™×');
  XLSX.writeFile(wb, 'filtered_students.xlsx');
}

function exportSingleStudent(index) {
  const student = students[index];
  if (!student) return;

  const studentBorrows = borrowed.filter(b => b.student.id === student.id && !returned.some(r => r.id === b.id));
  const studentCharges = charges.filter(c => c.studentId === student.id);
  const unpaidCharges = studentCharges.filter(c => !c.paid);
  const totalDebt = unpaidCharges.length * 50;

  const borrowedBooks = studentBorrows.map(b => `${b.book.name} (${b.book.subject})`).join(', ') || "××™×Ÿ";
  const chargedBooks = unpaidCharges.map(c => `${c.bookName} (${c.type})`).join(', ') || "××™×Ÿ";

  const headers = [
    "×©× ××œ×",
    "×ª×¢×•×“×ª ×–×”×•×ª",
    "×‘×™×ª ×¡×¤×¨",
    "×›×™×ª×”",
    "××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜ ×”×©××œ×ª ×¡×¤×¨×™×", // ×”×•×¡×¤×”
    "×¡×¤×¨×™× ××•×©××œ×™×",
    "×¡×¤×¨×™× ×©×—×•×™×‘×•",
    "×—×•×‘ ×›×•×œ×œ (â‚ª)"
  ];

  const row = [
    student.name,
    student.id,
    student.school,
    student.classroom,
    student.inLoanProject ? "×›×Ÿ" : "×œ×",  // ×”×•×¡×¤×”
    borrowedBooks,
    chargedBooks,
    totalDebt > 0 ? totalDebt : "0"
  ];

  const ws = XLSX.utils.aoa_to_sheet([headers, row]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '×ª×œ××™×“');
  XLSX.writeFile(wb, `student_${student.id}.xlsx`);
}

function renderBookTable(page = 1) {
  currentBookPage = page;

  const tbody = document.querySelector('#bookTable tbody');
  const search = document.getElementById('bookTableSearch').value.toLowerCase();

  const selectedLevel = document.getElementById('bookLevelFilter').value;
  const selectedVolume = document.getElementById('bookVolumeFilter').value;
  const selectedPublisher = document.getElementById('bookPublisherFilter').value.toLowerCase();
  const selectedType = document.getElementById('bookTypeFilter').value;

  tbody.innerHTML = '';

  const filteredBooks = books.filter(b => {
    const values = [
      b.name,
      b.subject,
      b.grade,
      b.level,
      b.volume,
      b.publisher,
      b.type
    ].map(x => (x || '').toLowerCase());

    const matchesSearch = values.some(v => v.includes(search)) || search === '';
    const matchesLevel = !selectedLevel || b.level === selectedLevel;
    const matchesVolume = !selectedVolume || b.volume === selectedVolume;
    const matchesPublisher = !selectedPublisher || (b.publisher || '').toLowerCase().includes(selectedPublisher);
    const matchesType = !selectedType || b.type === selectedType;

    return matchesSearch && matchesLevel && matchesVolume && matchesPublisher && matchesType;
  });

  const totalPages = Math.ceil(filteredBooks.length / ITEMS_PER_PAGE);
  if (page > totalPages) currentBookPage = 1;

  const pagedBooks = filteredBooks.slice((currentBookPage - 1) * ITEMS_PER_PAGE, currentBookPage * ITEMS_PER_PAGE);

  pagedBooks.forEach((b, i) => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td style="padding: 10px; min-width: 200px; text-align: right;">${b.name}</td>
      <td style="padding: 10px; min-width: 150px; text-align: right;">${b.subject}</td>
      <td style="padding: 10px; min-width: 80px; text-align: center;">${b.grade}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center;">${b.level || '×›×œ×œ×™'}</td>
      <td style="padding: 10px; min-width: 60px; text-align: center;">${b.volume}</td>
      <td style="padding: 10px; min-width: 150px; text-align: center;">${b.publisher}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center;">${b.type}</td>
      <td style="padding: 10px; text-align: center;">
        <button onclick="editBook(${i})" title="×¢×¨×•×š ×¡×¤×¨"><i class="fas fa-pencil"></i></button>
        <button onclick="deleteBookFromTable(${i})" title="××—×§ ×¡×¤×¨"><i class="fas fa-trash"></i></button>
      </td>
    `;

    tr.style.borderBottom = '1px solid #ddd';
    tbody.appendChild(tr);
  });

  renderBookPagination(totalPages);
}

function renderBookPagination(totalPages) {
  let paginationContainer = document.getElementById('bookPagination');
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'bookPagination';
    document.getElementById('bookTable').parentNode.insertBefore(paginationContainer, document.getElementById('bookTable').nextSibling);
  }
  paginationContainer.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.classList.toggle('active', i === currentBookPage);
    btn.disabled = (i === currentBookPage);
    btn.onclick = () => renderBookTable(i);
    paginationContainer.appendChild(btn);
  }
}


function deleteStudentFromTable(index) {
  if (!confirm('×”×× ×œ××—×•×§ ×ª×œ××™×“ ×–×”?')) return;
  students.splice(index, 1);
  borrowed = borrowed.filter(b => b.student.id !== students[index]?.id);
  saveData();
  renderStudentTable();
  filterStudents();
  showSuccess('×ª×œ××™×“ × ××—×§');
}

function deleteBookFromTable(index) {
  if (!confirm('×”×× ×œ××—×•×§ ×¡×¤×¨ ×–×”?')) return;
  books.splice(index, 1);
  saveData();
  renderBookTable();
  filterBooks();
  showSuccess('×¡×¤×¨ × ××—×§');
}

function selectStudent(index) {
  const sel = document.getElementById('filteredStudentsSelect');
  sel.value = index;
  filterBooks();
  updateReturnBooks(index);
}

function scrollToSection(anchor) {
  const target = document.getElementById('filteredStudentsSelect');
  if (target) {
    const offset = target.getBoundingClientRect().top + window.pageYOffset - 100;
    window.scrollTo({ top: offset, behavior: 'smooth' });
    target.classList.add('blink-highlight');
    setTimeout(() => target.classList.remove('blink-highlight'), 1000);
  }
}

document.getElementById('studentTableSearch').addEventListener('input', renderStudentTable);
document.getElementById('bookTableSearch').addEventListener('input', renderBookTable);

window.addEventListener("DOMContentLoaded", () => {
  loadData().then(() => {
    console.log("âœ… × ×ª×•× ×™× × ×˜×¢× ×• â€“ ××•×›×Ÿ ×œ×©×™××•×©");
    // ××œ ×ª×§×¨× ×œ-saveData() ×›××Ÿ!
  });
});
renderStudentTable();
renderBookTable();
</script>

<script>
const userIdHeader = { 'x-user-id': 'some-user-id' };

async function loadData() {
  try {
    students = await fetch(yearKey('students'), { headers: userIdHeader }).then(res => res.json());
    books = await fetch(yearKey('books'), { headers: userIdHeader }).then(res => res.json());
    borrowed = await fetch(yearKey('borrowed'), { headers: userIdHeader }).then(res => res.json());
    returned = await fetch(yearKey('returned'), { headers: userIdHeader }).then(res => res.json());
    charges = await fetch(yearKey('charges'), { headers: userIdHeader }).then(res => res.json());

    filterStudents();
    filterBooks();
  } catch (error) {
    console.error("Error loading data:", error);
    // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×‘××™×“×ª ×”×¦×•×¨×š
  }
}

async function saveData() {
  if (!students.length && !books.length && !borrowed.length && !returned.length && !charges.length) return;

  try {
    await Promise.all([
      fetch(yearKey('students'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(students) }),
      fetch(yearKey('books'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(books) }),
      fetch(yearKey('borrowed'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(borrowed) }),
      fetch(yearKey('returned'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(returned) }),
      fetch(yearKey('charges'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(charges) }),
    ]);
  } catch (error) {
    console.error("Error saving data:", error);
  }
}


function showSuccess(msg) {
  const el = document.getElementById('successMsg');
  el.textContent = "âœ… " + msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

function isValidIsraeliID(id) {
  // ×”×¡×¨×ª ×¨×•×•×—×™× ×•×ª×•×•×™× ×œ× ××¡×¤×¨×™×™×
  id = id.trim();
  if (!/^\d{5,9}$/.test(id)) return false; // ×—×™×™×‘ ×œ×”×™×•×ª ×‘×™×Ÿ 5 ×œ-9 ×¡×¤×¨×•×ª

  // ×”×•×¡×¤×ª ××¤×¡×™× ××•×‘×™×œ×™× ×¢×“ 9 ×¡×¤×¨×•×ª
  id = id.padStart(9, '0');

  let sum = 0;
  for (let i = 0; i < 9; i++) {
    let digit = parseInt(id.charAt(i), 10);
    let factor = (i % 2) + 1; // 1 ××• 2 ×œ×¡×™×¨×•×’×™×Ÿ ×”×—×œ ××”×¡×¤×¨×” ×”×¨××©×•× ×”

    let multiplied = digit * factor;
    // ×× ×”××›×¤×œ×” ×“×•-×¡×¤×¨×ª×™×ª, ×—×™×‘×•×¨ ×”×¡×¤×¨×•×ª (×œ×“×•×’××” 12 => 1 + 2 = 3)
    if (multiplied > 9) multiplied -= 9;

    sum += multiplied;
  }

  // ×× ×¡×›×•× ×”×¡×¤×¨×•×ª ××ª×—×œ×§ ×‘-10, ×”×ª×¢×•×“×” ×ª×§×™× ×”
  return sum % 10 === 0;
}

function addStudent() {
  const name = document.getElementById('studentName').value.trim();
  const id = document.getElementById('studentID').value.trim();
  const school = document.getElementById('studentSchool').value;
  const classroom = document.getElementById('studentClass').value.trim();
  const inLoanProjectValue = document.getElementById('studentInLoanProject').value;

  if (!name || !id || !classroom || inLoanProjectValue === '') {
    return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×•×œ×œ ×”×× ××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜');
  }

    if (!isValidIsraeliID(id)) {
    return alert('×ª×¢×•×“×ª ×–×”×•×ª ×œ× ×ª×§×™× ×”');
  }

  if (students.some(s => s.id === id)) {
    alert("×ª×œ××™×“ ×¢× ×ª×¢×•×“×ª ×–×”×•×ª ×–×• ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª");
    return;
  }

  const inLoanProject = inLoanProjectValue === 'true';

  students.push({ name, id, school, classroom, inLoanProject });
  saveData();
  showSuccess("×ª×œ××™×“ × ×•×¡×£");
  filterStudents();

  // ××™×¤×•×¡ ×˜×•×¤×¡ (×¨×©×•×ª)
  document.getElementById('studentName').value = '';
  document.getElementById('studentID').value = '';
  document.getElementById('studentClass').value = '';
  document.getElementById('studentInLoanProject').value = '';
}

function addBook() {
  const name = document.getElementById('bookName').value.trim();
  const subject = document.getElementById('bookSubject').value.trim();
  const grade = document.getElementById('bookGrade').value.trim();
  const level = document.getElementById('bookLevel').value;
  const volume = document.getElementById('bookVolume').value;
  const publisher = document.getElementById('bookPublisher').value.trim();
  const type = document.getElementById('bookType').value;

  if (!name || !subject || !grade || !level || !volume || !publisher || !type) {
    return alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×—×•×‘×” ×œ×¡×¤×¨');
  }

  // ×‘×“×™×§×” ×× ×§×™×™× ×¡×¤×¨ ×¢× ××•×ª×• ×©× ×•×¢× ××•×ª×• ×›×¨×š
  const exists = books.some(b =>
    b.name === name &&
    b.volume === volume
  );

  if (exists) {
    alert("×¡×¤×¨ ×¢× ××•×ª×• ×©× ×•×¢× ××•×ª×• ×›×¨×š ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª");
    return;
  }

  books.push({
    id: crypto.randomUUID(),
    name,
    subject,
    grade,
    level,
    volume,
    publisher,
    type
  });

  saveData();
  showSuccess("×¡×¤×¨ × ×•×¡×£");
  filterBooks();

  // ××™×¤×•×¡ ×˜×•×¤×¡ (×¨×©×•×ª)
  document.getElementById('bookName').value = '';
  document.getElementById('bookSubject').value = '';
  document.getElementById('bookGrade').value = '';
  document.getElementById('bookLevel').value = '×›×œ×œ×™';
  document.getElementById('bookVolume').value = '';
  document.getElementById('bookPublisher').value = '';
  document.getElementById('bookType').value = '';
}

function filterStudents() {
  const search = document.getElementById('searchStudentInput').value.toLowerCase();
  const select = document.getElementById('filteredStudentsSelect');
  select.innerHTML = '';

  students.forEach((s, i) => {
    const values = [s.name, s.id, s.classroom, s.school].map(x => (x || '').toLowerCase());
    if (values.some(x => x.includes(search))) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${s.name} (${s.classroom}, ${s.school})`;
      select.appendChild(option);
    }
  });

  // ×‘×—×¨ ××ª ×”×¨××©×•×Ÿ ××•×˜×•××˜×™×ª ×× ×™×© ××¤×©×¨×•×™×•×ª
  if (select.options.length > 0) {
    select.selectedIndex = 0;
  }

  updateBorrowPurchaseButtons();

  filterBooks();
}

window.onscroll = function () {
  const btn = document.getElementById('scrollTopBtn');
  if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
    btn.style.display = "block";
  } else {
    btn.style.display = "none";
  }
};

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ "×”×©××œ" ×•"×¨×›×™×©×”" ×œ×¤×™ ×¡×˜×˜×•×¡ ×”×©×ª×ª×¤×•×ª ×‘×¤×¨×•×™×§×˜
function updateBorrowPurchaseButtons() {
  const select = document.getElementById('filteredStudentsSelect');
  const selectedIndex = select.value;
  const student = students[selectedIndex];

  const btnBorrow = document.getElementById('btnBorrow');
  const btnPurchase = document.getElementById('btnPurchase');

  if (student && student.inLoanProject) {
    btnBorrow.style.display = 'inline-block';
    btnPurchase.style.display = 'none';
  } else {
    btnBorrow.style.display = 'none';
    btnPurchase.style.display = 'inline-block';
  }
}

// ×××–×™×Ÿ ×œ×©×™× ×•×™ ×”×‘×—×™×¨×” ×‘Ö¾select, ×™×¢×“×›×Ÿ ××ª ×”×›×¤×ª×•×¨×™× ×‘×–××Ÿ ×××ª
document.getElementById('filteredStudentsSelect').addEventListener('change', () => {
  updateBorrowPurchaseButtons();
  filterBooks();
});

function filterBooks() {
  const search = document.getElementById('searchBookInput').value.toLowerCase();
  const selectedLevel = document.getElementById('levelFilter').value;
  const selectedVolume = document.getElementById('volumeFilter').value; // ×—×“×©
  const selectedPublisher = document.getElementById('publisherFilter').value.toLowerCase(); // ×—×“×©
  const selectedType = document.getElementById('typeFilter').value; // ×—×“×©
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  const container = document.getElementById('filteredBooksSelect');
  container.innerHTML = '';

  if (studentIdx === '') return;
  const student = students[studentIdx];
  const grade = student?.classroom?.[0];

  books.forEach((b, i) => {
    const values = [b.name, b.subject, b.grade, b.volume, b.publisher, b.type].map(x => (x || '').toLowerCase());

    const alreadyBorrowedAndNotReturned = borrowed.some(br =>
      br.student.id === student.id &&
      br.book.id === b.id &&
      !returned.some(r => r.id === br.id)
    );

    const matchesSearch = values.some(x => x.includes(search));
    const matchesLevel = selectedLevel === '' || b.level === selectedLevel;
    const matchesVolume = selectedVolume === '' || b.volume === selectedVolume;
    const matchesPublisher = selectedPublisher === '' || (b.publisher || '').toLowerCase().includes(selectedPublisher);
    const matchesType = selectedType === '' || b.type === selectedType;

    if (
      b.grade === grade &&
      matchesLevel &&
      matchesVolume &&
      matchesPublisher &&
      matchesType &&
      matchesSearch &&
      !alreadyBorrowedAndNotReturned
    ) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = i;
      checkbox.id = 'book_' + i;

      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = `${b.name} (${b.subject}, ${b.grade})`;
      label.prepend(checkbox);

      container.appendChild(label);
    }
  });

  updateReturnBooks(studentIdx);
}

let pendingChargeStudent = null;
let charges = [];

function openChargeModal() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("×‘×—×¨ ×ª×œ××™×“");
  const student = students[studentIdx];
  pendingChargeStudent = student;

  const container = document.getElementById('chargeBooksList');
  container.innerHTML = '';

const stillBorrowed = borrowed.filter(b =>
  b.student.id === student.id &&
  !returned.some(r => r.id === b.id) && // ×œ× ×”×•×—×–×¨
  !charges.some(c => c.studentId === student.id && c.borrowId === b.id) // ×œ× ×—×•×™×‘ ×›×‘×¨
);


  stillBorrowed.forEach((entry, i) => {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '10px';

    const label = document.createElement('label');
    label.textContent = `${entry.book.name} (${entry.book.subject})`;

    const select = document.createElement('select');
    select.dataset.bookId = entry.id;
    select.innerHTML = `
      <option value="">×œ×œ× ×—×™×•×‘</option>
      <option value="××‘×“">××‘×“</option>
      <option value="×‘×œ××™">×‘×œ××™</option>
    `;

    wrapper.appendChild(label);
    wrapper.appendChild(select);
    container.appendChild(wrapper);
  });

  document.getElementById('chargeModal').style.display = 'flex';
}

function confirmCharge() {
  const selects = document.querySelectorAll('#chargeBooksList select');
  let count = 0;

  selects.forEach(sel => {
    const type = sel.value;
    if (type && pendingChargeStudent) {
      const bookEntry = borrowed.find(b =>
        b.id === sel.dataset.bookId && b.student.id === pendingChargeStudent.id
      );

      if (bookEntry) {
        charges.push({
          studentId: pendingChargeStudent.id,
          bookName: bookEntry.book.name,
          type: type,
          date: new Date().toISOString(),
          paid: false,
          borrowId: bookEntry.id // â† ×”×©×“×” ×”×§×¨×™×˜×™
        });
        count++;
      }
    }
  });

  if (count === 0) return alert("×œ× × ×‘×—×¨×• ×¡×¤×¨×™× ×œ×—×™×•×‘");

  const confirmed = confirm("×”×× ××ª\\×” ×‘×˜×•×—\\×” ×©×¡×™×™××ª ×œ×—×™×™×‘ ××ª ×›×œ ×”×¡×¤×¨×™× ×”× ×“×¨×©×™×?");
  if (!confirmed) return; // âŒ ×¢×¦×•×¨ ×× ×”××©×ª××© ×œ×—×¥ '×‘×™×˜×•×œ'

  saveData();
  showSuccess(`${count} ×¡×¤×¨×™× ×—×•×™×‘×•`);
  document.getElementById('chargeModal').style.display = 'none';

  const idx = students.findIndex(s => s.id === pendingChargeStudent?.id);
  if (idx !== -1) {
    viewStudentDetails(idx);
    updateReturnBooks(idx);
    filterBooks();
  }

  renderStudentTable();
  pendingChargeStudent = null;
}

function deleteFilteredStudents() {
  if (!confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”×ª×œ××™×“×™× ×”××•×¤×™×¢×™× ×‘×ª×¦×•×’×”? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) return;

  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  const filterGrade = document.getElementById('filterGrade').value;
  const filterClassroom = document.getElementById('filterClassroom').value.toLowerCase();
  const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
  const filterLevel = document.getElementById('filterLevel').value;
  const filterInLoanProject = document.getElementById('filterInLoanProject').value;

  // ××™×ª×•×¨ ×›×œ ×”×ª×œ××™×“×™× ×©×¢×•××“×™× ×‘×ª× ××™ ×”×¡×™× ×•×Ÿ
  const studentsToDelete = students.filter(s => {
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());

    const chargedBorrowIds = new Set(
      charges.filter(c => c.studentId === s.id && !c.paid).map(c => c.borrowId)
    );

    const passSearch = values.some(v => v.includes(search)) || search === '';
    const passGrade = !filterGrade || s.classroom?.startsWith(filterGrade);
    const passClassroom = !filterClassroom || (s.classroom || '').toLowerCase() === filterClassroom;

    const hasMatchingBook = borrowed.some(b => {
      if (b.student.id !== s.id) return false;

      const subjectMatch = !filterSubject || (b.book.subject || '').toLowerCase().trim().includes(filterSubject.trim());
      const levelMatch =
        !filterLevel ||
        b.book.level === filterLevel ||
        (!b.book.level && filterLevel === '') ||
        (b.book.level === '×›×œ×œ×™' && filterLevel === '');

      const notChargedOrPaid = !chargedBorrowIds.has(b.id);

      return subjectMatch && levelMatch && notChargedOrPaid;
    });

    const passSubjectAndLevel = (!filterSubject && !filterLevel) || hasMatchingBook;

    const passInLoanProject =
      filterInLoanProject === '' ||
      (filterInLoanProject === 'true' && s.inLoanProject === true) ||
      (filterInLoanProject === 'false' && s.inLoanProject === false);

    return passSearch && passGrade && passClassroom && passSubjectAndLevel && passInLoanProject;
  });

  if (studentsToDelete.length === 0) {
    alert('××™×Ÿ ×ª×œ××™×“×™× ×œ××—×™×§×” ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™');
    return;
  }

  // ××—×™×§×ª ×›×œ ×”×ª×œ××™×“×™× ×©× ×‘×—×¨×•
  const idsToDelete = new Set(studentsToDelete.map(s => s.id));
  students = students.filter(s => !idsToDelete.has(s.id));

  // ××—×™×§×ª ×”×©××œ×•×ª ×•×”×”×—×–×¨×•×ª ×©×œ×”×
  borrowed = borrowed.filter(b => !idsToDelete.has(b.student.id));
  returned = returned.filter(r => !idsToDelete.has(r.student.id));
  charges = charges.filter(c => !idsToDelete.has(c.studentId));

  saveData();
  showSuccess(`× ××—×§×• ${studentsToDelete.length} ×ª×œ××™×“×™×`);

  renderStudentTable();
  filterStudents();
}

function deleteFilteredBooks() {
  if (!confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”×¡×¤×¨×™× ×”××•×¤×™×¢×™× ×‘×ª×¦×•×’×”? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) return;

  const search = document.getElementById('bookTableSearch').value.toLowerCase();
  const selectedLevel = document.getElementById('bookLevelFilter').value;
  const selectedVolume = document.getElementById('bookVolumeFilter').value;
  const selectedPublisher = document.getElementById('bookPublisherFilter').value.toLowerCase();
  const selectedType = document.getElementById('bookTypeFilter').value;

  // ××™×ª×•×¨ ×›×œ ×”×¡×¤×¨×™× ×©×¢×•××“×™× ×‘×ª× ××™ ×”×¡×™× ×•×Ÿ
  const booksToDelete = books.filter(b => {
    const values = [
      b.name,
      b.subject,
      b.grade,
      b.level,
      b.volume,
      b.publisher,
      b.type
    ].map(x => (x || '').toLowerCase());

    const matchesSearch = values.some(v => v.includes(search)) || search === '';
    const matchesLevel = !selectedLevel || b.level === selectedLevel;
    const matchesVolume = !selectedVolume || b.volume === selectedVolume;
    const matchesPublisher = !selectedPublisher || (b.publisher || '').toLowerCase().includes(selectedPublisher);
    const matchesType = !selectedType || b.type === selectedType;

    return matchesSearch && matchesLevel && matchesVolume && matchesPublisher && matchesType;
  });

  if (booksToDelete.length === 0) {
    alert('××™×Ÿ ×¡×¤×¨×™× ×œ××—×™×§×” ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™');
    return;
  }

  const idsToDelete = new Set(booksToDelete.map(b => b.id));
  books = books.filter(b => !idsToDelete.has(b.id));

  // ××—×™×§×ª ×”×©××œ×•×ª ×•×”×”×—×–×¨×•×ª ×©×œ ×”×¡×¤×¨×™×
  borrowed = borrowed.filter(b => !idsToDelete.has(b.book.id));
  returned = returned.filter(r => !idsToDelete.has(r.book.id));
  charges = charges.filter(c => !idsToDelete.has(c.bookId));

  saveData();
  showSuccess(`× ××—×§×• ${booksToDelete.length} ×¡×¤×¨×™×`);

  renderBookTable();
  filterBooks();
}


function clearStudentDebt(studentId) {
  charges.forEach(c => {
    if (c.studentId === studentId && !c.paid) {
      c.paid = true;
      c.paidDate = new Date().toISOString();
    }
  });

  saveData();
  showSuccess("×”×—×•×‘ ×¡×•××Ÿ ×›××©×•×œ×");

  const idx = students.findIndex(s => s.id === studentId);
  if (idx !== -1) {
    updateReturnBooks(idx);
    filterBooks();
    viewStudentDetails(idx);
    renderStudentTable(); // ×¢×“×›×•×Ÿ ×”×˜×‘×œ×” ×œ××—×¨ ×ª×©×œ×•× ×”×—×•×‘
  }
}

function viewStudentDetails(index) {
  const student = students[index];
  if (!student) return;

  const studentCharges = charges.filter(c => c.studentId === student.id);
  const studentPaidCharges = studentCharges.filter(c => c.paid);
  const studentUnpaidCharges = studentCharges.filter(c => !c.paid);

  // ×›×œ ××–×”×™ ×”×”×©××œ×•×ª ×©×—×•×™×‘×• (×œ×¡×™× ×•×Ÿ ××”×”×©××œ×•×ª)
  const chargedIds = new Set(
    studentCharges.map(c => c.borrowId).filter(Boolean)
  );

  const studentBorrows = borrowed.filter(b =>
    b.student.id === student.id && !chargedIds.has(b.id)
  );
  const studentReturns = returned.filter(r =>
    r.student.id === student.id && !chargedIds.has(r.id)
  );

  // ×¡×¤×¨×™× ×©×˜×¨× ×”×•×—×–×¨×• (×”×©××œ×•×ª ×‘×œ×™ ×”×—×–×¨×•×ª)
  const booksStillBorrowed = studentBorrows.filter(b =>
    !studentReturns.some(r => r.id === b.id)
  );

  // ×¡×¤×¨×™× ×©×”×•×—×–×¨×• (×¨×©×•××•×ª ×”×—×–×¨×” ×œ×œ× ×”×©××œ×” ×—×“×©×” ×œ××—×¨ ××›×Ÿ)
  const booksReturned = studentReturns.filter(returnEntry => {
    return !borrowed.some(b =>
      b.student.id === student.id &&
      b.book.id === returnEntry.book.id &&
      b.id !== returnEntry.id &&
      new Date(b.date) > new Date(returnEntry.returnDate) &&
      !returned.some(r => r.id === b.id)
    );
  });

  const totalDebt = studentUnpaidCharges.length * 50;
  const totalPaid = studentPaidCharges.length * 50;

  let html = `
    <h4>${student.name}</h4>
    <p>×ª×¢×•×“×ª ×–×”×•×ª: ${student.id}</p>
    <p>×›×™×ª×”: ${student.classroom}</p>
    <p>×‘×™×ª ×¡×¤×¨: ${student.school}</p>
  `;

  if (totalDebt > 0) {
    html += `<p><b style="color: red;">×—×•×‘:</b> ${totalDebt} ×©"×—</p>`;
    html += `<p><b style="color: red;">×¡×¤×¨×™× ×©×—×•×™×‘×•:</b><ul>`;
    studentUnpaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      html += `<li style="color: red;">${c.bookName} (${c.type}) - ×—×•×™×‘ ×‘Ö¾${chargedAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (totalPaid > 0) {
    html += `<p><b style="color: green;">×©×•×œ×:</b> ${totalPaid} ×©"×—</p>`;
    html += `<p><b style="color: green;">×¡×¤×¨×™× ×©×—×•×™×‘×• ×•×©×•×œ××•:</b><ul>`;
    studentPaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      const paidAt = c.paidDate ? new Date(c.paidDate).toLocaleString('he-IL') : '---';
      html += `<li style="color: green;">${c.bookName} (${c.type}) - ×—×•×™×‘ ×‘Ö¾${chargedAt}, ×©×•×œ× ×‘Ö¾${paidAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksStillBorrowed.length > 0) {
    html += `<p><b>×¡×¤×¨×™× ×©×˜×¨× ×”×•×—×–×¨×•:</b><ul>`;
    booksStillBorrowed.forEach(b => {
      html += `<li>${b.book.name} (${b.book.subject}) - ×”×•×©××œ ×‘Ö¾${new Date(b.date).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksReturned.length > 0) {
    html += `<p><b>×¡×¤×¨×™× ×©×”×•×—×–×¨×•:</b><ul>`;
    booksReturned.forEach(r => {
      html += `<li>${r.book.name} (${r.book.subject}) - ×”×•×—×–×¨ ×‘Ö¾${new Date(r.returnDate).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  // ===== ×”×¦×’×ª ×—×ª×™××•×ª ×¢× ×©× ×•×¡×•×’ ×”×—×•×ª× =====
  // ×§×™×‘×•×¥ ×œ×¤×™ bulkId ×•-date (×§×‘×•×¦×” ××—×ª ×œ×›×œ ×—×ª×™××”)
  const groupedBySignature = {};

  studentBorrows.forEach(b => {
    // key ×™×™×—×•×“×™ ×œ×¤×™ bulkId (××• id ×× ××™×Ÿ) ×•×ª××¨×™×š
    const key = (b.bulkId || b.id) + '|' + b.date;

    if (!groupedBySignature[key]) {
      groupedBySignature[key] = {
        date: b.date,
        signature: b.signature,
        borrowerType: b.borrowerType || '×œ× ×™×“×•×¢',
        borrowerName: b.borrowerName || '×œ× ×™×“×•×¢'
      };
    }
  });

  const groupedEntries = Object.values(groupedBySignature);
  if (groupedEntries.length > 0) {
    html += `<p><b>×—×ª×™××•×ª ×¢×œ ×”×©××œ×•×ª:</b></p>`;
    groupedEntries.forEach(g => {
      const dateStr = new Date(g.date).toLocaleString('he-IL');
      let signerInfo = '';

      if (g.borrowerType === 'student') {
        signerInfo = `×ª×œ××™×“: ${g.borrowerName}`;
      } else if (g.borrowerType === 'parent') {
        signerInfo = `×”×•×¨×”/×—×‘×¨: ${g.borrowerName}`;
      } else if (g.borrowerType === 'staff') {
        signerInfo = `×‘×¢×œ ×ª×¤×§×™×“: ${g.borrowerName}`;
      } else {
        signerInfo = `×—×•×ª×: ${g.borrowerName}`;
      }

      html += `
        <div style="margin:10px 0; text-align: right;">
          <p style="margin:0;"><b>${dateStr} - ${signerInfo}</b></p>
          <img src="${g.signature}" alt="×—×ª×™××”" style="border:1px solid #ccc; max-width:100%; height:auto; margin-top:5px;" />
        </div>
      `;
    });
  }

  html += `<button onclick="printStudentCard(${index})">ğŸ–¨ï¸ ×”×“×¤×¡ ×›×¨×˜×™×¡</button>`;
  document.getElementById('studentDetailContent').innerHTML = html;
  document.getElementById('studentDetailModal').style.display = 'flex';
}

function returnToCharge() {
  returnToChargeMode = false;
  document.getElementById('studentDetailModal').style.display = 'none';
  if (pendingChargeStudent) {
    openChargeModal(pendingChargeStudent.id);
  }
}

function purchaseBook() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("×‘×—×¨ ×ª×œ××™×“");
  const student = students[studentIdx];

  const checkboxes = document.querySelectorAll('#filteredBooksSelect input[type=checkbox]:checked');
  if (checkboxes.length === 0) return alert("×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×¨ ××—×“ ×œ×¨×›×™×©×”");

  const list = document.getElementById('borrowBookList');
  list.innerHTML = '';
  checkboxes.forEach(cb => {
    const b = books[cb.value];
    const li = document.createElement('li');
    li.textContent = `${b.name} (${b.subject}, ×©×›×‘×ª ${b.grade}${b.level ? `, ×¨××” ${b.level}` : ''})`;
    list.appendChild(li);
  });

  document.getElementById('confirmBorrowCheckbox').checked = false;

  // ×¤×•×ª×— ××ª ×”××•×“×œ ×¢× ×˜×§×¡×˜×™× ×©×œ ×¨×›×™×©×”
  openConfirmModal('×¨×›×™×©×”');
}
function borrowBook() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("×‘×—×¨ ×ª×œ××™×“");
  const student = students[studentIdx];

  const checkboxes = document.querySelectorAll('#filteredBooksSelect input[type=checkbox]:checked');
  if (checkboxes.length === 0) return alert("×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×¨ ××—×“ ×œ×”×©××œ×”");

  const list = document.getElementById('borrowBookList');
  list.innerHTML = '';
  checkboxes.forEach(cb => {
    const b = books[cb.value];
    const li = document.createElement('li');
    li.textContent = `${b.name} (${b.subject}, ×©×›×‘×ª ${b.grade}${b.level ? `, ×¨××” ${b.level}` : ''})`;
    list.appendChild(li);
  });

  document.getElementById('confirmBorrowCheckbox').checked = false;

  // ×¤×•×ª×— ××ª ×”××•×“×œ ×¢× ×˜×§×¡×˜×™× ×©×œ ×”×©××œ×”
  openConfirmModal('×”×©××œ×”');
}
let canvas, ctx, drawing=false;

window.onload = () => {
  // ×”×ª×—×œ×ª ×”×—×ª×™××”
  canvas = document.getElementById('signaturePad');
  ctx = canvas.getContext('2d');
  canvas.addEventListener('pointerdown', e => {
    drawing = true;
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    canvas.setPointerCapture(e.pointerId);
  });

  canvas.addEventListener('pointermove', e => {
    if (!drawing) return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  });

  ['pointerup', 'pointercancel', 'pointerleave'].forEach(event =>
    canvas.addEventListener(event, () => (drawing = false))
  );

  ['touchstart', 'touchmove', 'touchend', 'gesturestart'].forEach(evt =>
    canvas.addEventListener(evt, e => e.preventDefault(), { passive: false })
  );

  // × ×˜×¢× ×ª ×¨×§ ××—×¨×™ ×˜×¢×™× ×ª ×”×“×£ ×”××œ××”:
  window.addEventListener("DOMContentLoaded", () => {
  loadData().then(() => {
    console.log("âœ… × ×ª×•× ×™× × ×˜×¢× ×• â€“ ××•×›×Ÿ ×œ×©×™××•×©");
    // ××œ ×ª×§×¨× ×œ-saveData() ×›××Ÿ!
  });
});
  filterStudents();
  filterBooks();
  renderStudentTable();
  renderBookTable();
};

function viewStudentDetails(index) {
  const student = students[index];
  if (!student) return;

  const studentCharges = charges.filter(c => c.studentId === student.id);
  const studentPaidCharges = studentCharges.filter(c => c.paid);
  const studentUnpaidCharges = studentCharges.filter(c => !c.paid);

  const chargedIds = new Set(
    studentCharges.map(c => c.borrowId).filter(Boolean)
  );

  const studentBorrows = borrowed.filter(b =>
    b.student.id === student.id && !chargedIds.has(b.id)
  );
  const studentReturns = returned.filter(r =>
    r.student.id === student.id && !chargedIds.has(r.id)
  );

  const booksStillBorrowed = studentBorrows.filter(b =>
    !studentReturns.some(r => r.id === b.id)
  );

  const booksReturned = studentReturns.filter(returnEntry => {
    return !borrowed.some(b =>
      b.student.id === student.id &&
      b.book.id === returnEntry.book.id &&
      b.id !== returnEntry.id &&
      new Date(b.date) > new Date(returnEntry.returnDate) &&
      !returned.some(r => r.id === b.id)
    );
  });

  const totalDebt = studentUnpaidCharges.length * 50;
  const totalPaid = studentPaidCharges.length * 50;

  let html = `
    <h4>${student.name}</h4>
    <p>×ª×¢×•×“×ª ×–×”×•×ª: ${student.id}</p>
    <p>×›×™×ª×”: ${student.classroom}</p>
    <p>×‘×™×ª ×¡×¤×¨: ${student.school}</p>
  `;

  if (totalDebt > 0) {
    html += `<p><b style="color: red;">×—×•×‘:</b> ${totalDebt} ×©"×—</p>`;
    html += `<p><b style="color: red;">×¡×¤×¨×™× ×©×—×•×™×‘×•:</b><ul>`;
    studentUnpaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      html += `<li style="color: red;">${c.bookName} (${c.type}) - ×—×•×™×‘ ×‘Ö¾${chargedAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (totalPaid > 0) {
    html += `<p><b style="color: green;">×©×•×œ×:</b> ${totalPaid} ×©"×—</p>`;
    html += `<p><b style="color: green;">×¡×¤×¨×™× ×©×—×•×™×‘×• ×•×©×•×œ××•:</b><ul>`;
    studentPaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      const paidAt = c.paidDate ? new Date(c.paidDate).toLocaleString('he-IL') : '---';
      html += `<li style="color: green;">${c.bookName} (${c.type}) - ×—×•×™×‘ ×‘Ö¾${chargedAt}, ×©×•×œ× ×‘Ö¾${paidAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksStillBorrowed.length > 0) {
    html += `<p><b>×¡×¤×¨×™× ×©×˜×¨× ×”×•×—×–×¨×•:</b><ul>`;
    booksStillBorrowed.forEach(b => {
      html += `<li>${b.book.name} (${b.book.subject}) - ×”×•×©××œ ×‘Ö¾${new Date(b.date).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksReturned.length > 0) {
    html += `<p><b>×¡×¤×¨×™× ×©×”×•×—×–×¨×•:</b><ul>`;
    booksReturned.forEach(r => {
      html += `<li>${r.book.name} (${r.book.subject}) - ×”×•×—×–×¨ ×‘Ö¾${new Date(r.returnDate).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  // âœ… ×—×ª×™××•×ª ×©×œ ×”×ª×œ××™×“/×‘×¢×œ ×ª×¤×§×™×“ ×œ×¤×™ ×§×‘×•×¦×”
  const groupedBySignature = {};

  studentBorrows.forEach(b => {
    const key = b.bulkId + '|' + b.date;
    if (!groupedBySignature[key]) {
      groupedBySignature[key] = {
        date: b.date,
        signature: b.signature
      };
    }
  });

  const groupedEntries = Object.values(groupedBySignature);
  if (groupedEntries.length > 0) {
    html += `<p><b>×—×ª×™××•×ª ×¢×œ ×”×©××œ×•×ª:</b></p>`;
    groupedEntries.forEach(g => {
      const dateStr = new Date(g.date).toLocaleString('he-IL');
      html += `
        <div style="margin:10px 0;">
          <p style="margin:0;"><b>${dateStr}:</b></p>
          <img src="${g.signature}" alt="×—×ª×™××”" style="border:1px solid #ccc; max-width:100%; height:auto; margin-top:5px;" />
        </div>
      `;
    });
  }

  html += `<button onclick="printStudentCard(${index})">ğŸ–¨ï¸ ×”×“×¤×¡ ×›×¨×˜×™×¡</button>`;
  document.getElementById('studentDetailContent').innerHTML = html;
  document.getElementById('studentDetailModal').style.display = 'flex';
}

function closeStudentModal() {
  document.getElementById('studentDetailModal').style.display = 'none';
}


function fixCanvasDPI() {
  const dpi = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpi;
  canvas.height = rect.height * dpi;
  ctx.scale(dpi, dpi);
}

function openBorrowModal() {
  const modal = document.getElementById('confirmBorrowModal');
  modal.style.display = 'flex';

  setTimeout(() => {
    canvas = document.getElementById('signaturePad');
    ctx = canvas.getContext('2d');
    fixCanvasDPI();

    canvas.addEventListener('pointerdown', e => {
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      canvas.setPointerCapture(e.pointerId);
    });

    canvas.addEventListener('pointermove', e => {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    });

    ['pointerup', 'pointercancel', 'pointerleave'].forEach(event =>
      canvas.addEventListener(event, () => (drawing = false))
    );

  }, 100); // ××—×›×” ×˜×™×¤×” ××—×¨×™ ×©×”××•×“×œ ××•×¦×’
}


function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
}

function getSignatureImage() {
  return canvas.toDataURL(); // ××—×–×™×¨ ××ª ×”×—×ª×™××” ×›×ª××•× ×” ×‘×¤×•×¨××˜ base64
}


function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function isSignatureEmpty() {
  const blank = document.createElement('canvas');
  blank.width = canvas.width;
  blank.height = canvas.height;
  return canvas.toDataURL() === blank.toDataURL();
}

function finalizeBorrow() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("×‘×—×¨ ×ª×œ××™×“");
  const student = students[studentIdx];

  if (!document.getElementById('confirmBorrowCheckbox').checked)
    return alert("×™×© ×œ××©×¨ ××ª ×”×¦×”×¨×ª ×§×‘×œ×ª ×”×¡×¤×¨×™× ×”×ª×§×™× ×™×");

  if (isSignatureEmpty())
    return alert("× ×“×¨×©×ª ×—×ª×™××” ×œ×¤× ×™ ×”×©×œ××ª ×”×¤×¢×•×œ×”");

  const borrowerType = document.getElementById('borrowerTypeSelect').value;
  const borrowerName = document.getElementById('borrowerNameInput').value.trim();

  if ((borrowerType === 'parent' || borrowerType === 'staff') && !borrowerName) {
    return alert("× × ×œ××œ× ×©× ××œ× ×¢×‘×•×¨ ×”×•×¨×” ××• ×‘×¢×œ ×ª×¤×§×™×“");
  }

  const checkboxes = document.querySelectorAll('#filteredBooksSelect input[type=checkbox]:checked');
  if (checkboxes.length === 0) return alert("×‘×—×¨ ×œ×¤×—×•×ª ×¡×¤×¨ ××—×“");

  const signatureData = getSignatureImage();
  const now = new Date().toISOString();
  const bulkId = crypto.randomUUID(); // ××–×”×” ×§×‘×•×¦×ª×™ ×œ×¤×¢×•×œ×”

  let countAdded = 0;

  if (window.currentActionType === '×”×©××œ×”') {
    checkboxes.forEach(cb => {
      const book = books[cb.value];
      const alreadyBorrowed = borrowed.some(b =>
        b.student.id === student.id &&
        b.book.id === book.id &&
        !returned.some(r => r.id === b.id)
      );

      if (!alreadyBorrowed) {
        borrowed.push({
          id: crypto.randomUUID(),
          student,
          book,
          date: now,
          signature: signatureData,
          bulkId,
          borrowerType,    // ×©××™×¨×ª ×¡×•×’ ×”××©××™×œ
          borrowerName: borrowerType === 'student' ? student.name : borrowerName // ×©× ××œ× (×× ×ª×œ××™×“ - ×©××•)
        });
        countAdded++;
      }
    });

    if (countAdded === 0) {
      return alert("×›×œ ×”×¡×¤×¨×™× ×©× ×‘×—×¨×• ×›×‘×¨ ×”×•×©××œ×•");
    } else {
      showSuccess(`×”×•×©××œ×• ${countAdded} ×¡×¤×¨×™×`);
    }

  } else if (window.currentActionType === '×¨×›×™×©×”') {
    // ×“×•××” - ×¨×§ ×¡×™××•×Ÿ ×¨×›×™×©×”
    checkboxes.forEach(cb => {
      const book = books[cb.value];
      const alreadyPurchased = borrowed.some(b =>
        b.student.id === student.id &&
        b.book.id === book.id &&
        b.purchase === true
      );

      if (!alreadyPurchased) {
        borrowed.push({
          id: crypto.randomUUID(),
          student,
          book,
          date: now,
          signature: signatureData,
          purchase: true,
          bulkId,
          borrowerType,
          borrowerName: borrowerType === 'student' ? student.name : borrowerName
        });
        countAdded++;
      }
    });

    if (countAdded === 0) {
      return alert("×›×œ ×”×¡×¤×¨×™× ×©× ×‘×—×¨×• ×›×‘×¨ × ×§× ×•");
    } else {
      showSuccess(`× ×¨×›×©×• ${countAdded} ×¡×¤×¨×™×`);
    }
  } else {
    return alert("×©×’×™××”: ×¡×•×’ ×¤×¢×•×œ×” ×œ× ××•×’×“×¨");
  }

  saveData();
  filterBooks();
  closeBorrowModal();
}

function returnBook() {
  const selectedIds = Array.from(document.querySelectorAll('#returnBooksSelect input[type="checkbox"]:checked'))
    .map(cb => cb.value);

  if (selectedIds.length === 0) {
    showError("×‘×—×¨ ×¡×¤×¨×™× ×œ×”×—×–×¨×”");
    return;
  }

  const returnDate = new Date().toISOString();
  const bulkId = `return-${Date.now()}`;

  selectedIds.forEach(id => {
    const entry = borrowed.find(b => b.id === id);
    if (entry && !returned.some(r => r.id === entry.id)) {
      returned.push({ ...entry, returnDate, bulkId });
    }
  });

  saveData();
  showSuccess("×”×¡×¤×¨×™× ×”×•×—×–×¨×• ×‘×”×¦×œ×—×”");
  filterStudentsReturn();
}

function closeBorrowModal()
{
    document.getElementById('confirmBorrowModal').style.display = 'none';
}

function deleteStudentFromTable(index) {
  if (!confirm('×”×× ×œ××—×•×§ ×ª×œ××™×“ ×–×”?')) return;

  const deletedStudent = students[index]; // ×©×•××¨ ××ª ×”×ª×œ××™×“ ×œ×¤× ×™ ×”××—×™×§×”
  if (!deletedStudent?.id) return;

  students.splice(index, 1); // ××•×—×§ ××ª ×”×ª×œ××™×“

  // ××•×—×§ ××ª ×”×”×©××œ×•×ª ×•×”×”×—×–×¨×•×ª ×©×œ×• ×œ×¤×™ ×ª"×–
  borrowed = borrowed.filter(b => b.student.id !== deletedStudent.id);
  returned = returned.filter(r => r.student.id !== deletedStudent.id);

  saveData();
  renderStudentTable();
  filterStudents();
  showSuccess('×ª×œ××™×“ × ××—×§');
}

function deleteSelectedBook() {
  const idx = document.getElementById('filteredBooksSelect').value;
  if (idx === '') return alert("×‘×—×¨ ×¡×¤×¨ ×œ××—×™×§×”");
  if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¡×¤×¨?")) return;
  books.splice(idx, 1);
  saveData();
  showSuccess("×¡×¤×¨ × ××—×§");
  filterBooks();
}

function exportToExcel(data, type) {
  let rows = [];
  let headers = [];

  if (type === 'students') {
    headers = [
      "×©× ××œ×",
      "×ª×¢×•×“×ª ×–×”×•×ª",
      "×‘×™×ª ×¡×¤×¨",
      "×›×™×ª×”",
      "××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜ ×”×©××œ×ª ×¡×¤×¨×™×", // ×”×•×¡×¤×”
      "×¡×¤×¨×™× ×©×”×•×©××œ×•",
      "×¡×¤×¨×™× ×©×—×•×™×‘×•",
      "×—×•×‘ ×›×•×œ×œ (â‚ª)"
    ];

    rows = data.map(student => {
      const borrowedBooks = borrowed
        .filter(b => b.student.id === student.id && !returned.some(r => r.id === b.id))
        .map(b => `${b.book.name} (${b.book.subject})`)
        .join(', ') || "××™×Ÿ";

      const unpaidCharges = charges.filter(c => c.studentId === student.id && !c.paid);
      const chargedBooks = unpaidCharges.map(c => `${c.bookName} (${c.type})`).join(', ') || "××™×Ÿ";
      const totalDebt = unpaidCharges.length * 50;

      return [
        student.name,
        student.id,
        student.school,
        student.classroom,
        student.inLoanProject ? "×›×Ÿ" : "×œ×",  // ×”×•×¡×¤×”
        borrowedBooks,
        chargedBooks,
        totalDebt > 0 ? totalDebt : "0"
      ];
    });

  } else if (type === 'books') {
    headers = [
      "×©× ×”×¡×¤×¨",
      "××§×¦×•×¢",
      "×©×›×‘×ª ×’×™×œ",
      "×¨××ª ×œ×™××•×“",
      "×›×¨×š",
      "×©× ×”×•×¦××”",
      "×¡×•×’ ×¡×¤×¨"
    ];

    rows = data.map(book => [
      book.name,
      book.subject,
      book.grade,
      book.level || "×›×œ×œ×™",
      book.volume || "",
      book.publisher || "",
      book.type || ""
    ]);
  }

  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, type === 'students' ? '×ª×œ××™×“×™×' : '×¡×¤×¨×™×');
  XLSX.writeFile(wb, `${type}.xlsx`);
}

function importExcel(event, type) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const headers = rows[0];
    const dataRows = rows.slice(1);

    if (type === 'students') {
      const idx = {
        name: headers.indexOf("×©× ××œ×"),
        id: headers.indexOf("×ª×¢×•×“×ª ×–×”×•×ª"),
        school: headers.indexOf("×‘×™×ª ×¡×¤×¨"),
        classroom: headers.indexOf("×›×™×ª×”"),
        inLoanProject: headers.indexOf("××©×ª×ª×£ ×‘×¤×¨×•×™×§×˜ ×”×©××œ×ª ×¡×¤×¨×™×") // ×”×•×¡×¤×”
      };

      dataRows.forEach(row => {
        const name = row[idx.name]?.toString().trim();
        const id = row[idx.id]?.toString().trim();
        const school = row[idx.school]?.toString().trim();
        const classroom = row[idx.classroom]?.toString().trim();
        const inLoanProjectRaw = idx.inLoanProject !== -1 ? row[idx.inLoanProject]?.toString().trim() : null;
        const inLoanProject = inLoanProjectRaw === '×›×Ÿ' || inLoanProjectRaw === 'true';

        const alreadyExists = students.some(s => s.id === id);
        if (name && id && school && classroom && !alreadyExists) {
          students.push({ name, id, school, classroom, inLoanProject });
        }
      });

    } else if (type === 'books') {
      const idx = {
        name: headers.indexOf("×©× ×”×¡×¤×¨"),
        subject: headers.indexOf("××§×¦×•×¢"),
        grade: headers.indexOf("×©×›×‘×ª ×’×™×œ"),
        level: headers.indexOf("×¨××ª ×œ×™××•×“"),
        volume: headers.indexOf("×›×¨×š"),
        publisher: headers.indexOf("×©× ×”×•×¦××”"),
        type: headers.indexOf("×¡×•×’ ×¡×¤×¨")
      };

      dataRows.forEach(row => {
        const name = row[idx.name]?.toString().trim();
        const subject = row[idx.subject]?.toString().trim();
        const grade = row[idx.grade]?.toString().trim();
        const level = row[idx.level]?.toString().trim() || "×›×œ×œ×™";
        const volume = row[idx.volume]?.toString().trim() || "";
        const publisher = row[idx.publisher]?.toString().trim() || "";
        const typeValue = row[idx.type]?.toString().trim() || "";

        const alreadyExists = books.some(b =>
          b.name === name &&
          b.subject === subject &&
          b.grade === grade &&
          b.level === level &&
          b.volume === volume &&
          b.publisher === publisher &&
          b.type === typeValue
        );

        if (name && subject && grade && !alreadyExists) {
          books.push({
            id: crypto.randomUUID(),
            name,
            subject,
            grade,
            level,
            volume,
            publisher,
            type: typeValue
          });
        }
      });
    }

    saveData();
    showSuccess("×™×™×‘×•× ×”×¦×œ×™×—");
    filterStudents();
    filterBooks();
  };
  reader.readAsArrayBuffer(event.target.files[0]);
}

let selectedBulkBookIds = new Set(); // ğŸ§  ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×–×›×™×¨×ª ×¡×¤×¨×™× ×©× ×‘×—×¨×•

function selectAllFilteredBulkBooks() {
  const checkboxes = document.querySelectorAll('#bulkBooksSelect input[type=checkbox]');
  checkboxes.forEach(cb => {
    cb.checked = true;
    selectedBulkBookIds.add(cb.value);
  });
}

function deselectAllFilteredBulkBooks() {
  const checkboxes = document.querySelectorAll('#bulkBooksSelect input[type=checkbox]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    selectedBulkBookIds.delete(cb.value);
  });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function initializeCanvas(canvasId) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const dpi = window.devicePixelRatio || 1;

  canvas.width = rect.width * dpi;
  canvas.height = rect.height * dpi;
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpi, dpi);

  // ×× ×™×¢×ª ××—×•×•×ª swipe ×•×’×œ×™×œ×”
  canvas.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
  canvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
  canvas.addEventListener('touchend', e => e.preventDefault(), { passive: false });
}

function enableFullscreenOnCanvas(canvasId, containerId) {
  const container = document.getElementById(containerId);
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');

  canvas.addEventListener('mousedown', async () => {
    if (document.fullscreenElement) return;

    container.classList.add('fullscreen-signature');
    try {
      await container.requestFullscreen();
      setTimeout(() => resizeCanvasForFullscreen(canvas, ctx), 100);
    } catch (err) {
      console.warn('××¡×š ××œ× × ×›×©×œ:', err);
    }
  });

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      container.classList.remove('fullscreen-signature');
      resizeCanvasToDefault(canvas, ctx);
    }
  });

  function resizeCanvasForFullscreen(canvas, ctx) {
    const dpi = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpi;
    canvas.height = window.innerHeight * 0.6 * dpi;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpi, dpi);
  }

  function resizeCanvasToDefault(canvas, ctx) {
    const dataURL = canvas.toDataURL();
    const img = new Image();
    img.onload = () => {
      const rect = canvas.getBoundingClientRect();
      const dpi = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpi;
      canvas.height = rect.height * dpi;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(dpi, dpi);
      ctx.drawImage(img, 0, 0, rect.width, rect.height);
    };
    img.src = dataURL;
  }
}

window.addEventListener('DOMContentLoaded', () => {
  initializeCanvas('signaturePad');
  initializeCanvas('bulkSignaturePad');
  enableFullscreenOnCanvas('signaturePad', 'signatureContainer');
  enableFullscreenOnCanvas('bulkSignaturePad', 'bulkSignatureContainer');
});

document.getElementById('filteredStudentsSelect').addEventListener('change', (e) => {
  const index = e.target.value;
  filterBooks();           // ×œ×¢×“×›×•×Ÿ ×¨×©×™××ª ×¡×¤×¨×™× ×œ×”×©××œ×”
  updateReturnBooks(index); // ×œ×¢×“×›×•×Ÿ ×¨×©×™××ª ×¡×¤×¨×™× ×œ×”×—×–×¨×”
});

</script>

<script>
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
  button.addEventListener('click', () => {
    const tabId = button.getAttribute('data-tab');

    // ×©××™×¨×ª ×”×œ×©×•× ×™×ª ×”× ×‘×—×¨×ª ×‘-localStorage
    localStorage.setItem('activeTabId', tabId);

    // ×”×¡×ª×¨×ª ×›×œ ×”×˜××‘×™×
    tabContents.forEach(tc => tc.classList.remove('active'));
    // ×‘×™×˜×•×œ ×¡×œ×§×˜×™×‘ ×©×œ ×›×œ ×”×›×¤×ª×•×¨×™×
    tabButtons.forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });

    // ×”×¦×’×ª ×”×˜××‘ ×©× ×‘×—×¨
    document.getElementById(tabId).classList.add('active');
    button.classList.add('active');
    button.setAttribute('aria-selected', 'true');
  });
});

// ×˜×¢×™× ×ª ×”×˜××‘ ×”×¤×¢×™×œ ×-localStorage ×‘×¢×ª ×˜×¢×™× ×ª ×”×“×£
window.addEventListener('DOMContentLoaded', () => {
  const savedTabId = localStorage.getItem('activeTabId');
  if (savedTabId && document.getElementById(savedTabId)) {
    // ×”×¡×¨×ª ×”-active ××›×œ ×”×˜××‘×™× ×•×”×›×¤×ª×•×¨×™×
    tabContents.forEach(tc => tc.classList.remove('active'));
    tabButtons.forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });

    // ×”×¤×¢×œ×ª ×”×˜××‘ ×”×©××•×¨
    document.getElementById(savedTabId).classList.add('active');
    const btn = Array.from(tabButtons).find(b => b.getAttribute('data-tab') === savedTabId);
    if (btn) {
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
    }
  } else {
    // ××™×Ÿ ×˜××‘ ×©××•×¨, ×”×¤×¢×œ ××ª ×”×¨××©×•×Ÿ ×›×‘×¨×™×¨×ª ××—×“×œ
    tabButtons[0].click();
  }
});

function updateReturnBooks(studentIdx) {
  const container = document.getElementById('returnBooksSelect');
  container.innerHTML = '';

  if (!studentIdx) return;
  const student = students[studentIdx];
  if (!student) return;

  const sameStudentBorrowed = borrowed.filter(b => 
    b.student.id === student.id &&
    !returned.some(r => r.id === b.id) &&
    !charges.some(c => c.studentId === b.student.id && c.borrowId === b.id)
  );

  if (sameStudentBorrowed.length === 0) {
    container.innerHTML = '<p>××™×Ÿ ×¡×¤×¨×™× ×œ×”×—×–×¨×”</p>';
    return;
  }

  sameStudentBorrowed.forEach((b, i) => {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = b.id;
    checkbox.id = 'return_' + i;
    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.textContent = `${b.book.name} (${b.book.subject}) - ×¨××”: ${b.book.level || '×›×œ×œ×™'}`;
    label.prepend(checkbox);
    container.appendChild(label);
  });
}

// ×××–×™× ×™× ×œ××™×¨×•×¢×™× ×‘×œ×©×•× ×™×ª ×”×—×–×¨×” â€“ ×—×©×•×‘ ×××•×“ ×œ×”××–×™×Ÿ ×œ-SELECT ×”× ×›×•×Ÿ!
document.getElementById('searchStudentInputReturn').addEventListener('input', () => {
  filterStudentsReturn();
});
document.getElementById('filteredStudentsSelectReturn').addEventListener('change', (e) => {
  updateReturnBooks(e.target.value);
});
document.getElementById('searchBookInputReturn').addEventListener('input', () => {
  // ×›××Ÿ × ×¢×“×›×Ÿ ×¢× ×”×¤×¨××˜×¨ ×”××—×¨×•×Ÿ ×©× ×‘×—×¨ ×‘-select
  const select = document.getElementById('filteredStudentsSelectReturn');
  updateReturnBooks(select ? select.value : '');
});
document.getElementById('levelFilterReturn').addEventListener('change', () => {
  const select = document.getElementById('filteredStudentsSelectReturn');
  updateReturnBooks(select ? select.value : '');
});

// ×§×¨×™××” ×¨××©×•× ×™×ª ×œ×˜×¢×™× ×ª ×”×ª×œ××™×“×™× ×‘×œ×©×•× ×™×ª ×”×—×–×¨×”
window.addEventListener('DOMContentLoaded', () => {
  loadData().then(() => {
    filterStudentsReturn();
  });
});


document.getElementById('studentTableSearch').addEventListener('input', () => renderStudentTable(1));
document.getElementById('filterGrade').addEventListener('change', () => renderStudentTable(1));
document.getElementById('filterClassroom').addEventListener('input', () => renderStudentTable(1));
document.getElementById('filterSubject').addEventListener('input', () => renderStudentTable(1));
document.getElementById('filterLevel').addEventListener('change', () => renderStudentTable(1));
document.getElementById('filterInLoanProject').addEventListener('change', () => renderStudentTable(1));

document.getElementById('bookTableSearch').addEventListener('input', () => renderBookTable(1));
document.getElementById('bookLevelFilter').addEventListener('change', () => renderBookTable(1));
document.getElementById('bookVolumeFilter').addEventListener('change', () => renderBookTable(1));
document.getElementById('bookPublisherFilter').addEventListener('input', () => renderBookTable(1));
document.getElementById('bookTypeFilter').addEventListener('change', () => renderBookTable(1));

// ×§×¨×™××•×ª ×”×ª×—×œ×ª×™×•×ª (×× ×™×©)
renderStudentTable();
renderBookTable();
</script>


</body>
</html>