<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>

  <meta charset="UTF-8">
  <title>📘 מערכת השאלת ספרים - קציר</title>
  <style>
    body { font-family: Arial; direction: rtl; background: #f9f9f9; padding: 20px; }
    .container { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    label, input, select, button { display: block; margin: 10px 0; }
    input, select { padding: 8px; width: 100%; }
    button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #studentTable {
  width: 100%;
  border-collapse: collapse;
}
#studentTable th {
  background-color: #f0f0f0;
  padding: 12px;
  text-align: center;
}
#studentTable td {
  font-size: 14px;
}
    #successMsg {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    footer{
        text-align: left; color: #888; font-size: 12px; margin-top: 40px;
    }
  #bookTable {
    width: 100%;
    border-collapse: collapse;
  }
  #bookTable th {
    background-color: #f0f0f0;
    padding: 12px;
    text-align: center;
  }

#signaturePad {
  touch-action: none;
  will-change: transform;
}

  #bookTable td {
    font-size: 14px;
  }

    .bolded
    {
        font-weight: bold;
    }
      .checkbox-list label {
    display: block;
    margin: 5px 0;
    cursor: pointer;
  }
.checkbox-list input[type="checkbox"] {
  width: 16px;
  height: 16px;
  margin-left: 4px; /* או אפילו פחות */
  transform: none; /* הסר את ההגדלה */
  vertical-align: middle; /* לכיוון יישור טוב יותר עם הטקסט */
  cursor: pointer;
}


  .checkbox-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.checkbox-list label {
  background: #f1f1f1;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
}

.book-disabled {
  background-color: #eee !important;
  color: #888;
  border: 1px solid #ccc;
  text-decoration: line-through;
}

#signaturePad {
  border: 1px solid #ccc;
  width: 100%;
  height: 200px;
  touch-action: none; /* מבטל pinch/scroll */
  background-color: white;
  display: block;
  margin-bottom: 10px;
}
canvas {
  pointer-events: auto;
}
body {
  touch-action: auto;
}

html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden; /* מונע גלילה לרוחב בלבד */
}

#signaturePad {
  touch-action: none; /* מונע swipe/pinch רק כאן */
  user-select: none;
  -webkit-user-drag: none;
}

#confirmBorrowModal {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  overflow: auto; /* מאפשר גלילה אם התוכן ארוך מדי */
}

#scrollTopBtn {
  display: none;
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 99;
  width: 48px;
  height: 48px;
  font-size: 24px;
  border: none;
  outline: none;
  background-color: #007bff;
  color: white;
  cursor: pointer;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  line-height: 48px;
  text-align: center;
  padding: 0;
}

#scrollTopBtn:hover {
  background-color: #0056b3;
}


.tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      color:black;
    }
    .tab-button {
      padding: 10px 20px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      font-weight: bold;
      user-select: none;
      color:#000;
    }
    .tab-button.active {
      background: white;
      border-bottom: 2px solid white;
      box-shadow: 0 -2px 0 #007bff inset;
      color: #007bff;
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

#confirmBorrowModal > div {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

#signaturePad {
  width: 100%;
  height: 200px;
  border: 1px solid #ccc;
  touch-action: none;
  background-color: white;
}

.fullscreen-signature {
  background: white;
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 20px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.fullscreen-signature canvas {
  border: 2px solid #000;
  width: 90vw !important;
  height: 60vh !important;
}
.fullscreen-signature button {
  margin-top: 10px;
  font-size: 16px;
  padding: 10px 20px;

}

.borrowed-books-cell {
  max-height: 7.5em; /* 5 שורות בגובה שורה 1.5em */
  overflow-y: auto;
  padding-right: 5px;
  word-break: break-word;
  white-space: normal;
  vertical-align: top; /* חשוב! שורה תתחיל מלמעלה */
}

.borrowed-books-cell > div {
  padding: 2px 0;
  line-height: 1.5em; /* גובה שורה אחיד */
}

#studentPagination, #bookPagination {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin: 12px 0;
}
#studentPagination button,
#bookPagination button {
  padding: 6px 10px;
  border: 1px solid #007bff;
  background: white;
  color: #007bff;
  border-radius: 4px;
  cursor: pointer;
}
#studentPagination button.active,
#bookPagination button.active {
  background: #007bff;
  color: white;
}
#studentPagination button:disabled,
#bookPagination button:disabled {
  opacity: 0.6;
  cursor: default;
}


  </style>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
  <h1 id="yearHeader">📘 מערכת השאלת ספרים - קציר רחובות - שנה: <span id="currentYearDisplay"></span></h1>
<input
  type="number"
  min="2026"
  id="yearSelect"
  style="
    width: 80px;
    height: 24px;
    cursor: pointer;
    vertical-align: middle;
    background: transparent;
    margin-left: 10px;
    margin-top: 4px;
    display: inline-block;
    font-size: 12px;
  "
  oninput="
    this.style.background = 'linear-gradient(to right, #007bff 0%, #007bff ' + 
    ((this.value - this.min) / (this.max - this.min)) * 100 + '%, #ccc ' +
    ((this.value - this.min) / (this.max - this.min)) * 100 + '%, #ccc 100%)';
  "
  onchange="
    this.dispatchEvent(new Event('input'));
  "
></div>

<div id="loadingOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.5);
  color: white;
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  padding-top: 40vh;
  z-index: 9999;
">טוען...</div>

<div id="editStudentModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%;">
    <h3>עריכת פרטי תלמיד</h3>
    <label>שם מלא <input id="editStudentName" type="text"></label>
    <label>תעודת זהות <input id="editStudentID" type="text" disabled></label>
    <label>בית ספר
      <select id="editStudentSchool">
        <option value="קציר א">קציר א</option>
        <option value="קציר ב">קציר ב</option>
        <option value="תיכון">תיכון</option>
      </select>
    </label>
    <label>כיתה <input id="editStudentClass" type="text"></label>
    <label>משתתף בפרויקט השאלת ספרים:
      <select id="editStudentInLoanProject">
        <option value="true">כן</option>
        <option value="false">לא</option>
      </select>
    </label>
    <div style="margin-top: 15px; text-align: left;">
      <button onclick="saveEditedStudent()">💾 שמור</button>
      <button onclick="closeEditStudentModal()">❌ בטל</button>
    </div>
  </div>
</div>

<script>
  let currentEditIndex = null;

function editStudent(index) {
  currentEditIndex = index;
  const student = students[index];
  if (!student) return alert("התלמיד לא נמצא");

  document.getElementById('editStudentName').value = student.name;
  document.getElementById('editStudentID').value = student.id; // לא לערוך
  document.getElementById('editStudentSchool').value = student.school || 'קציר א';
  document.getElementById('editStudentClass').value = student.classroom || '';
  document.getElementById('editStudentInLoanProject').value = student.inLoanProject ? 'true' : 'false';

  document.getElementById('editStudentModal').style.display = 'flex';
}

function closeEditStudentModal() {
  currentEditIndex = null;
  document.getElementById('editStudentModal').style.display = 'none';
}

function saveEditedStudent() {
  if (currentEditIndex === null) return;

  const name = document.getElementById('editStudentName').value.trim();
  const school = document.getElementById('editStudentSchool').value;
  const classroom = document.getElementById('editStudentClass').value.trim();
  const inLoanProjectValue = document.getElementById('editStudentInLoanProject').value;

  if (!name || !classroom || inLoanProjectValue === '') {
    return alert('נא למלא את כל השדות');
  }

  students[currentEditIndex].name = name;
  students[currentEditIndex].school = school;
  students[currentEditIndex].classroom = classroom;
  students[currentEditIndex].inLoanProject = (inLoanProjectValue === 'true');

  saveData();
  showSuccess("פרטי התלמיד עודכנו");
  closeEditStudentModal();
  renderStudentTable();
  filterStudents();
}


let currentEditBookIndex = null;

function editBook(index) {
  currentEditBookIndex = index;
  const book = books[index];
  if (!book) return alert("הספר לא נמצא");

  document.getElementById('editBookName').value = book.name || '';
  document.getElementById('editBookSubject').value = book.subject || '';
  document.getElementById('editBookGrade').value = book.grade || '';
  document.getElementById('editBookLevel').value = book.level || 'כללי';
  document.getElementById('editBookVolume').value = book.volume || 'יחיד';
  document.getElementById('editBookPublisher').value = book.publisher || '';
  document.getElementById('editBookType').value = book.type || 'ספר';

  document.getElementById('editBookModal').style.display = 'flex';
}

function closeEditBookModal() {
  currentEditBookIndex = null;
  document.getElementById('editBookModal').style.display = 'none';
}

function saveEditedBook() {
  if (currentEditBookIndex === null) return;

  const name = document.getElementById('editBookName').value.trim();
  const subject = document.getElementById('editBookSubject').value.trim();
  const grade = document.getElementById('editBookGrade').value.trim();
  const level = document.getElementById('editBookLevel').value;
  const volume = document.getElementById('editBookVolume').value;
  const publisher = document.getElementById('editBookPublisher').value.trim();
  const type = document.getElementById('editBookType').value;

  if (!name || !subject || !grade || !level || !volume || !publisher || !type) {
    return alert('נא למלא את כל השדות חובה לספר');
  }

  books[currentEditBookIndex].name = name;
  books[currentEditBookIndex].subject = subject;
  books[currentEditBookIndex].grade = grade;
  books[currentEditBookIndex].level = level;
  books[currentEditBookIndex].volume = volume;
  books[currentEditBookIndex].publisher = publisher;
  books[currentEditBookIndex].type = type;

  saveData();
  showSuccess("פרטי הספר עודכנו");
  closeEditBookModal();
  renderBookTable();
  filterBooks();
}

</script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const yearInput = document.getElementById('yearSelect');  // שדה הקלט מסוג number
    const yearDisplay = document.getElementById('currentYearDisplay');
    const minYear = 2026;

    // טען את השנה מ־localStorage, או הגדר מינימום
    let selectedYear = parseInt(localStorage.getItem('selectedYear'), 10);
    if (isNaN(selectedYear) || selectedYear < minYear) {
      selectedYear = minYear;
      localStorage.setItem('selectedYear', selectedYear.toString());
    }

    // עדכן את שדה הקלט והתצוגה
    yearInput.value = selectedYear;
    yearDisplay.textContent = selectedYear;

    // מאזין לשינויים בקלט (input) – רק אם הערך חוקי
    yearInput.addEventListener('input', () => {
      let val = parseInt(yearInput.value, 10);

      if (isNaN(val) || val < minYear) {
        yearDisplay.textContent = 'ערך לא חוקי';
        return;
      }

      localStorage.setItem('selectedYear', val.toString());
      yearDisplay.textContent = val;

      loadDataForYear(val);  // טען מחדש את הנתונים לפי השנה
    });

    // טען את הנתונים בתחילה לפי השנה שהוגדרה
    loadDataForYear(selectedYear);
  });

  function loadDataForYear(year) {
    console.log("טוען נתונים לשנה", year);
    loadData(); // פונקציה קיימת שמטענת את הנתונים שלך
  }

  function yearKey(file) {
    const minYear = 2026;
    const maxYear = new Date().getFullYear() + 1;
    let year = parseInt(localStorage.getItem('selectedYear'), 10);

    if (isNaN(year) || year < minYear) year = minYear;
    if (year > maxYear) year = maxYear;

    return `/api/${year}/${file}`;
  }
</script>

 <div class="tabs" role="tablist" aria-label="ניהול מערכת">
    <button class="tab-button active" data-tab="studentsTab" role="tab" aria-selected="true" aria-controls="studentsTab">ניהול תלמידים</button>
    <button class="tab-button" data-tab="booksTab" role="tab" aria-selected="false" aria-controls="booksTab">ניהול ספרים</button>
    <button class="tab-button" data-tab="borrowTab" role="tab" aria-selected="false" aria-controls="borrowTab">ניהול השאלות ורכישות</button>
    <button class="tab-button" data-tab="returnTab" role="tab" aria-selected="false" aria-controls="returnTab">ניהול החזרות וחיובים</button>
  </div>

<div id="successMsg"></div>
<div id="confirmBorrowModal" style="display:none; position:fixed; top:0; right:0; bottom:0; left:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:500px; width:90%;">
    <h3>📋 אישור השאלה</h3>
    <ul id="borrowBookList" style="text-align:right; padding-right:20px;"></ul>

    <label for="borrowerTypeSelect" style="display:block; margin-top:10px;">
  מי משאיל?
  <select id="borrowerTypeSelect" style="width: 100%; margin-top: 5px;">
    <option value="student">תלמיד</option>
    <option value="parent">הורה\חבר</option>
    <option value="staff">בעל תפקיד</option>
  </select>
</label>

<label for="borrowerNameInput" style="display:none; margin-top:10px;">
  שם מלא (ל'הורה\חבר' ו'בעל תפקיד')
  <input id="borrowerNameInput" type="text" style="width: 100%;" placeholder="הקלד שם מלא">
</label>

    <label style="display:block; margin-top:10px;">
      <input type="checkbox" id="confirmBorrowCheckbox">
      אני מאשר/ת שקיבלתי את כל ספרי הלימוד המצוינים לעיל, במצב תקין
    </label>

    <div style="margin-top:15px;">
      <p style="margin-bottom:5px;">✍️ חתימה:</p>
      <div id="signatureContainer">
<canvas id="signaturePad"></canvas>
      <button onclick="clearSignature()" style="margin-top:5px;">🧹 נקה חתימה</button>
      </div>
    </div>

    <div style="margin-top:15px; text-align:left;">
      <button onclick="finalizeBorrow()" style="margin-left:10px;">✔️ אשר</button>
      <button onclick="closeBorrowModal()">❌ בטל</button>
    </div>
  </div>
</div>

<script>
  document.getElementById('borrowerTypeSelect').addEventListener('change', e => {
  const val = e.target.value;
  const nameInputLabel = document.getElementById('borrowerNameInput').parentElement;
  if (val === 'student') {
    nameInputLabel.style.display = 'none';
    document.getElementById('borrowerNameInput').value = '';
  } else {
    nameInputLabel.style.display = 'block';
  }
});
</script>

<div id="bulkLendModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
    <h3>📦 השאלה מרוכזת</h3>

    <p>בחר ספרים להשאלה לכל התלמידים שברשימה:</p>

    <input id="bulkSearchBookInput" placeholder="🔍 חפש לפי שם ספר" oninput="filterBulkBooks()">
    <input id="bulkSubjectFilter" placeholder="🔍 סינון לפי מקצוע" oninput="filterBulkBooks()">
    
    <select id="bulkLevelFilter" onchange="filterBulkBooks()">
      <option value="">רמת לימוד</option>
      <option value="3 יחל">3 יח"ל</option>
      <option value="4 יחל">4 יח"ל</option>
      <option value="5 יחל">5 יח"ל</option>
    </select>

    <select id="bulkGradeFilter" onchange="filterBulkBooks()">
      <option value="">שכבת גיל</option>
      <option value="ז">ז</option>
      <option value="ח">ח</option>
      <option value="ט">ט</option>
      <option value="י">י</option>
      <option value="יא">יא</option>
      <option value="יב">יב</option>
    </select>

    <div id="bulkBooksSelect" class="checkbox-list" style="margin: 10px 0;">

    </div>

    <div id="bulkBooksSelectOptions">
      <button onclick="selectAllFilteredBulkBooks()">בחר את כל הספרים המוצגים</button>
      <button onclick="selectedBulkBookIds.clear(); filterBulkBooks();">בטל את כל הבחירות</button>
    </div>
    <label><input type="checkbox" id="bulkConfirmCheckbox"> אני מאשר/ת השאלה מרוכזת בשם כל התלמידים</label>
    
    <p>✍️ חתימת בעל תפקיד:</p>
    <div id="bulkSignatureContainer">
    <canvas id="bulkSignaturePad" style="border:2px solid #007bff; background-color:#f0f8ff; width:100%; height:150px;"></canvas>
    <button onclick="clearBulkSignature()">🧹 נקה חתימה</button>
    </div>
    <div style="text-align:left; margin-top:20px;">
      <button onclick="confirmBulkLend()">✔️ אשר</button>
      <button onclick="document.getElementById('bulkLendModal').style.display='none'">❌ בטל</button>
    </div>
  </div>
</div>


<!-- אזור ניהול תלמידים -->
   <div id="studentsTab" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="studentsTab">
<div class="container">
  <h2>➕ הוספת תלמיד</h2>
  <label>שם מלא <input id="studentName"></label>
  <label>תעודת זהות <input id="studentID"></label>
  <label>בית ספר
    <select id="studentSchool">
      <option value="קציר א">קציר א</option>
      <option value="קציר ב">קציר ב</option>
      <option value="תיכון">תיכון</option>
    </select>
  </label>
  <label>כיתה (למשל: י1) <input id="studentClass"></label>
    <label>משתתף בפרויקט השאלת ספרים:
  <select id="studentInLoanProject" required>
    <option value="" disabled selected>בחר</option>
    <option value="true">כן</option>
    <option value="false">לא</option>
  </select>
</label>
  <button onclick="addStudent()">הוסף תלמיד</button>
  <label class="bolded">ייבוא</label><input type="file" accept=".xlsx" onchange="importExcel(event, 'students')">

</div>

  <div class="container">
  <h2>✏️ רשימת תלמידים</h2>
  <button onclick="openBulkLendModal()">📚 השאלה מרוכזת לכל התלמידים ברשימה</button>
  <label> סינון תלמידים:
    <input id="studentTableSearch" placeholder="סנן לפי שם/ת\"ז/כיתה/בי"ס">
  </label>
  <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px;">
  <label>סנן לפי שכבה:
    <select id="filterGrade" onchange="renderStudentTable()">
      <option value="">הכל</option>
      <option value="ז">ז</option>
      <option value="ח">ח</option>
      <option value="ט">ט</option>
      <option value="י">י</option>
      <option value="יא">יא</option>
      <option value="יב">יב</option>
    </select>
  </label>

  <label>סנן לפי כיתה (למשל י3):
    <input id="filterClassroom" oninput="renderStudentTable()" placeholder="כגון: י3" />
  </label>

  <label>מקצוע לסינון ספרים:
    <input id="filterSubject" oninput="renderStudentTable()" placeholder="כגון: מתמטיקה" />
  </label>

  <label>רמת לימוד:
    <select id="filterLevel" onchange="renderStudentTable()">
      <option value="">הכל</option>
      <option value="3 יחל">3 יח"ל</option>
      <option value="4 יחל">4 יח"ל</option>
      <option value="5 יחל">5 יח"ל</option>
    </select>
  </label>

  <label>סינון לפי השתתפות בפרויקט:
  <select id="filterInLoanProject" onchange="renderStudentTable()">
    <option value="">הכל</option>
    <option value="true">כן</option>
    <option value="false">לא</option>
  </select>
</label>
</div>


  <table id="studentTable">
<thead>
  <tr>
    <th style="text-align: right;">שם</th>
    <th style="text-align: center;">ת"ז</th>
    <th style="text-align: center;">כיתה</th>
    <th style="text-align: center;">בי"ס</th>
    <th style="text-align: center;">חוב</th>
    <th style="text-align: right;">ספרים מושאלים</th>
    <th style="text-align: center;">זמני השאלה</th>
    <th style="text-align: center;">זמני החזרה\תשלום</th>
    <th style="text-align: center;">פעולות</th>
  </tr>
</thead>
    <tbody></tbody>
  </table>
<br>
<button onclick="deleteFilteredStudents()">מחק את כל התלמידים שבתצוגה</button>
<button onclick="exportFilteredStudents()">ייצא את כל התלמידים שבתצוגה</button>
</div>
   </div>

<!-- אזור ניהול ספרים -->
   <div id="booksTab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="booksTab">
<div class="container">
  <h2>📚 הוספת ספר</h2>
 <label>שם הספר <input id="bookName"></label>
<label>מקצוע <input id="bookSubject"></label>
<label>שכבת גיל <input id="bookGrade"></label>
<label>רמת לימוד
  <select id="bookLevel">
    <option value="כללי">כללי</option>
    <option value="3 יחל">3 יח"ל</option>
    <option value="4 יחל">4 יח"ל</option>
    <option value="5 יחל">5 יח"ל</option>
  </select>
</label>

<label>כרך
  <select id="bookVolume" required>
    <option value="" disabled selected>בחר כרך</option>
    <option value="יחיד">יחיד</option>
    <option value="א">א</option>
    <option value="ב">ב</option>
    <option value="ג">ג</option>
    <option value="ד">ד</option>
  </select>
</label>

<label>שם הוצאה <input id="bookPublisher" required></label>

<label>סוג הספר
  <select id="bookType" required>
    <option value="" disabled selected>בחר סוג ספר</option>
    <option value="ספר">ספר</option>
    <option value="חוברת">חוברת</option>
    <option value="חוברת פנימית">חוברת פנימית</option>
  </select>
</label>

<button onclick="addBook()">הוסף ספר</button>

  <button onclick="exportToExcel(books, 'books')">📤 ייצוא ספרים</button>
  <input type="file" accept=".xlsx" onchange="importExcel(event, 'books')">
</div>

<!-- מודל עריכת ספר -->
<div id="editBookModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%;">
    <h3>עריכת פרטי ספר</h3>
    <label>שם הספר <input id="editBookName" type="text"></label>
    <label>מקצוע <input id="editBookSubject" type="text"></label>
    <label>שכבת גיל <input id="editBookGrade" type="text"></label>
    <label>רמת לימוד
      <select id="editBookLevel">
        <option value="כללי">כללי</option>
        <option value="3 יחל">3 יח"ל</option>
        <option value="4 יחל">4 יח"ל</option>
        <option value="5 יחל">5 יח"ל</option>
      </select>
    </label>
    <label>כרך
      <select id="editBookVolume">
        <option value="יחיד">יחיד</option>
        <option value="א">א</option>
        <option value="ב">ב</option>
        <option value="ג">ג</option>
        <option value="ד">ד</option>
      </select>
    </label>
    <label>שם הוצאה <input id="editBookPublisher" type="text"></label>
    <label>סוג הספר
      <select id="editBookType">
        <option value="ספר">ספר</option>
        <option value="חוברת">חוברת</option>
        <option value="חוברת פנימית">חוברת פנימית</option>
      </select>
    </label>

    <div style="margin-top: 15px; text-align: left;">
      <button onclick="saveEditedBook()">💾 שמור</button>
      <button onclick="closeEditBookModal()">❌ בטל</button>
    </div>
  </div>
</div>


<div class="container">
  <h2>📚 רשימת ספרים</h2>

  <label>סינון ספרים:
    <input id="bookTableSearch" placeholder="סנן לפי שם/מקצוע/שכבה/הוצאה/סוג/כרך">
  </label>

  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
    <label>רמה:
      <select id="bookLevelFilter" onchange="renderBookTable()">
        <option value="">הכל</option>
        <option value="3 יחל">3 יח"ל</option>
        <option value="4 יחל">4 יח"ל</option>
        <option value="5 יחל">5 יח"ל</option>
        <option value="כללי">כללי</option>
      </select>
    </label>

    <label>כרך:
      <select id="bookVolumeFilter" onchange="renderBookTable()">
        <option value="">הכל</option>
        <option value="יחיד">יחיד</option>
        <option value="א">א</option>
        <option value="ב">ב</option>
        <option value="ג">ג</option>
        <option value="ד">ד</option>
      </select>
    </label>

    <label>הוצאה:
      <input id="bookPublisherFilter" type="text" oninput="renderBookTable()" placeholder="הקלד שם הוצאה">
    </label>

    <label>סוג ספר:
      <select id="bookTypeFilter" onchange="renderBookTable()">
        <option value="">הכל</option>
        <option value="ספר">ספר</option>
        <option value="חוברת">חוברת</option>
        <option value="חוברת פנימית">חוברת פנימית</option>
      </select>
    </label>
  </div>

  <table id="bookTable">
    <thead>
      <tr>
        <th style="text-align: right;">שם</th>
        <th style="text-align: right;">מקצוע</th>
        <th style="text-align: center;">שכבה</th>
        <th style="text-align: center;">רמה</th>
        <th style="text-align: center;">כרך</th>
        <th style="text-align: center;">הוצאה</th>
        <th style="text-align: center;">סוג</th>
        <th style="text-align: center;">פעולות</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="deleteFilteredBooks()">מחק את כל הספרים שבתצוגה</button>
</div>

   </div>

<!-- השאלת ספרים -->
   <div id="borrowTab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="borrowTab">
<div class="container">
  <h2>השאלת\רכישת ספרים</h2>
  <label class="bolded">חפש תלמיד <input id="searchStudentInput" oninput="filterStudents()"></label>
  <select id="filteredStudentsSelect"></select>

 <label class="bolded">חפש ספר <input id="searchBookInput" oninput="filterBooks()"></label>
 <label class="bolded">סנן לפי רמת לימוד:</label>
<select id="levelFilter" onchange="filterBooks()">
  <option value="">הכל</option>
  <option value="3 יחל">3 יח"ל</option>
  <option value="4 יחל">4 יח"ל</option>
  <option value="5 יחל">5 יח"ל</option>
</select>
<label>סנן לפי כרך:
  <select id="volumeFilter" onchange="filterBooks()">
    <option value="">הכל</option>
    <option value="יחיד">יחיד</option>
    <option value="א">א</option>
    <option value="ב">ב</option>
    <option value="ג">ג</option>
    <option value="ד">ד</option>
  </select>
</label>

<label>סנן לפי הוצאה:
  <input id="publisherFilter" type="text" oninput="filterBooks()" placeholder="הקלד שם הוצאה">
</label>

<label>סנן לפי סוג:
  <select id="typeFilter" onchange="filterBooks()">
    <option value="">הכל</option>
    <option value="ספר">ספר</option>
    <option value="חוברת">חוברת</option>
    <option value="חוברת פנימית">חוברת פנימית</option>
  </select>
</label>
 <h5>ספרים להשאלה</h5>
<div id="filteredBooksSelect" class="checkbox-list"></div>
<br>
<button onclick="selectAllCheckboxes('filteredBooksSelect', true)">בחר את כל הספרים להשאלה</button>
<hr>
<button id="btnBorrow" onclick="openConfirmModal('השאלה')">📥 השאל</button>
<button id="btnPurchase" style="display:none;" onclick="openConfirmModal('רכישה')">🛒 רכישה</button>

</div>
</div>

<div id="returnTab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="returnTab">
  <h2>החזרת\חיוב ספרים</h2>
  <label class="bolded">חפש תלמיד <input id="searchStudentInputReturn" oninput="filterStudentsReturn()"></label>
  <select id="filteredStudentsSelectReturn"></select>

  <label class="bolded">חפש ספר <input id="searchBookInputReturn" oninput="filterBooksReturn()"></label> <!-- הוספה חשובה -->

  <label class="bolded">סנן לפי רמת לימוד:</label>
  <select id="levelFilterReturn" onchange="filterBooksReturn()">
    <option value="">הכל</option>
    <option value="3 יחל">3 יח"ל</option>
    <option value="4 יחל">4 יח"ל</option>
    <option value="5 יחל">5 יח"ל</option>
  </select>
  <label>סנן לפי כרך:
  <select id="volumeFilter" onchange="filterBooks()">
    <option value="">הכל</option>
    <option value="יחיד">יחיד</option>
    <option value="א">א</option>
    <option value="ב">ב</option>
    <option value="ג">ג</option>
    <option value="ד">ד</option>
  </select>
</label>

<label>סנן לפי הוצאה:
  <input id="publisherFilter" type="text" oninput="filterBooks()" placeholder="הקלד שם הוצאה">
</label>

<label>סנן לפי סוג:
  <select id="typeFilter" onchange="filterBooks()">
    <option value="">הכל</option>
    <option value="ספר">ספר</option>
    <option value="חוברת">חוברת</option>
    <option value="חוברת פנימית">חוברת פנימית</option>
  </select>
</label>

  <h5>ספרים להחזרה</h5>
  <div id="returnBooksSelect" class="checkbox-list"></div>

  <br>
  <button onclick="selectAllCheckboxes('returnBooksSelect', true)">בחר את כל הספרים להחזרה</button>
  <br>
  <hr>
  <br>
  <button onclick="returnBook()">📤 החזר</button>
  <button onclick="openChargeModal()">חיוב עבור בלאי\אובדן </button>

  <div id="chargeModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
      <h3>💸 חיוב תלמיד עבור ספרים פגומים או אבודים</h3>
      <div id="chargeBooksList" class="checkbox-list"></div>
      <div style="text-align:left; margin-top:20px;">
        <button onclick="confirmCharge()">✔️ חייב תלמיד</button>
        <button onclick="document.getElementById('chargeModal').style.display='none'">❌ בטל</button>
      </div>
    </div>
  </div>
</div>


<script>
  // סינון תלמידים בלשונית החזרה

  const ITEMS_PER_PAGE = 50;

let currentStudentPage = 1;
let currentBookPage = 1;

function filterStudentsReturn() {
  const levelSelect = document.getElementById('levelFilterReturn');
  if (!levelSelect) {
    console.warn("Missing element: levelFilterReturn");
    return;
  }

  const levelFilter = levelSelect.value;
  const select = document.getElementById('filteredStudentsSelectReturn');
  if (!select) {
    console.warn("Missing element: filteredStudentsSelectReturn");
    return;
  }

  select.innerHTML = '';

  const filtered = borrowed.filter(b =>
    !returned.some(r => r.id === b.id) &&
    (!levelFilter || b.book.level === levelFilter)
  );

  const uniqueStudents = Array.from(new Set(filtered.map(b => b.student.id)))
    .map(id => students.find(s => s.id === id));

  uniqueStudents.forEach((student, i) => {
    const option = document.createElement('option');
    option.value = students.indexOf(student);
    option.textContent = student.name;
    select.appendChild(option);
  });

  if (select.options.length > 0) {
    updateReturnBooks(select.value);
  } else {
    const container = document.getElementById('returnBooksSelect');
    if (container) container.innerHTML = '<p>אין ספרים להחזרה</p>';
  }
}



  // סינון ספרים להחזרה בטאב החזרה
  function filterBooksReturn() {
    const searchInput = document.getElementById('searchBookInputReturn');
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const selectedLevel = document.getElementById('levelFilterReturn').value;
    const studentIdx = document.getElementById('filteredStudentsSelectReturn').value;
    const container = document.getElementById('returnBooksSelect');
    container.innerHTML = '';

    if (studentIdx === '') return;
    const student = students[studentIdx];
    if (!student) return;

    borrowed.forEach((b, i) => {
      const values = [b.book.name, b.book.subject, b.book.grade].map(x => (x || '').toLowerCase());

      const alreadyReturned = returned.some(r => r.id === b.id);

      if (
        b.student.id === student.id &&
        !alreadyReturned &&
        (selectedLevel === '' || b.book.level === selectedLevel) &&
        values.some(x => x.includes(search))
      ) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = b.id;  // שימוש במזהה ההשאלה
        checkbox.id = 'return_' + i;

        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = `${b.book.name} (${b.book.subject}, שכבת ${b.book.grade}${b.book.level ? `, רמה ${b.book.level}` : ''})`;
        label.prepend(checkbox);

        container.appendChild(label);
      }
    });
  }

  // מאזינים לאירועים בלשונית החזרה
  document.getElementById('searchStudentInputReturn').addEventListener('input', filterStudentsReturn);
  document.getElementById('filteredStudentsSelectReturn').addEventListener('change', filterBooksReturn);
  document.getElementById('searchBookInputReturn').addEventListener('input', filterBooksReturn);
  document.getElementById('levelFilterReturn').addEventListener('change', filterBooksReturn);

  // קריאה ראשונית לטעינת תלמידים בלשונית החזרה
  window.addEventListener('DOMContentLoaded', () => {
    filterStudentsReturn();
  });

  // פונקציה לבחירת כל תיבות הסימון
  function selectAllCheckboxes(containerId, checked) {
    const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
    checkboxes.forEach(cb => cb.checked = checked);
  }
</script>


<div id="studentDetailModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
    <h3>📋 פרטי תלמיד</h3>
    <div id="studentDetailContent" style="text-align:right; line-height:1.8;"></div>
<div style="text-align:left; margin-top:20px;">
  <button onclick="closeStudentModal()">❌ סגור</button>
</div>

  </div>
</div>
<button onclick="scrollToTop()" id="scrollTopBtn" title="למעלה">↑</button>
<br>
<br>
  <footer>
    <b>© 2025 Aviv Ben-Amar. All rights reserved<br>

This software and its source code, including all associated files, designs, and data structures, are the intellectual property of Aviv Ben-Amar and are protected under applicable copyright laws<br>

Unauthorized copying, distribution, modification, or use of any part of this system is strictly prohibited without prior written consent
<br>
Violations may result in civil and/or criminal liability</b>
</footer>

<style>
.blink-highlight {
  animation: blink 0.5s ease-in-out 0s 2;
  outline: 3px solid #ff9800;
  outline-offset: 2px;
}
@keyframes blink {
  0% { outline-color: #ff9800; }
  50% { outline-color: transparent; }
  100% { outline-color: #ff9800; }
}
</style>



<script>
  
let students = [];
let books = [];
let borrowed = [];
let returned = [];
let returnToChargeMode = false;


function selectAllFilteredBulkBooks() {
  const checkboxes = document.querySelectorAll('#bulkBooksSelect input[type=checkbox]');
  checkboxes.forEach(cb => {
    cb.checked = true;
    selectedBulkBookIds.add(cb.value);
  });
}


window.addEventListener("DOMContentLoaded", () => {
  loadData().then(() => {
    console.log("✅ כל הנתונים נטענו");
    renderStudentTable();  // 🟢 רק כאן מותר
    renderBookTable();
  });
});


let bulkCanvas, bulkCtx;

function openBulkLendModal() {
  selectedBulkBookIds = new Set();
  document.getElementById('bulkLendModal').style.display = 'flex';
  setTimeout(() => {
    bulkCanvas = document.getElementById('bulkSignaturePad');
    bulkCtx = bulkCanvas.getContext('2d');
    bulkCanvas.width = bulkCanvas.offsetWidth;
    bulkCanvas.height = bulkCanvas.offsetHeight;

    bulkCtx.clearRect(0, 0, bulkCanvas.width, bulkCanvas.height);
    bulkCtx.beginPath();

    bulkCanvas.addEventListener('pointerdown', e => {
      bulkCtx.moveTo(e.offsetX, e.offsetY);
      bulkCanvas.setPointerCapture(e.pointerId);
      bulkCanvas.isDrawing = true;
    });

    bulkCanvas.addEventListener('pointermove', e => {
      if (bulkCanvas.isDrawing) {
        bulkCtx.lineTo(e.offsetX, e.offsetY);
        bulkCtx.stroke();
      }
    });

    ['pointerup', 'pointerleave'].forEach(evt =>
      bulkCanvas.addEventListener(evt, () => (bulkCanvas.isDrawing = false))
    );

    filterBulkBooks();
  }, 100);
}

function clearBulkSignature() {
  if (bulkCtx) {
    bulkCtx.clearRect(0, 0, bulkCanvas.width, bulkCanvas.height);
    bulkCtx.beginPath(); // מוסיף איפוס אמיתי
  }
}

function isBulkSignatureEmpty() {
  const blank = document.createElement('canvas');
  blank.width = bulkCanvas.width;
  blank.height = bulkCanvas.height;
  return bulkCanvas.toDataURL() === blank.toDataURL();
}

function openConfirmModal(actionType) {
  const modal = document.getElementById('confirmBorrowModal');
  const title = modal.querySelector('h3');
  const confirmBtn = modal.querySelector('button[onclick="finalizeBorrow()"]');

  // שינוי הטקסטים לפי הפעולה
  if (actionType === 'השאלה') {
    title.textContent = '📋 אישור השאלה';
    confirmBtn.textContent = '✔️ אשר';
  } else if (actionType === 'רכישה') {
    title.textContent = '📋 אישור הרכישה';
    confirmBtn.textContent = '✔️ אשר רכישה';
  }

  modal.style.display = 'flex';
  window.currentActionType = actionType;
}


function filterBulkBooks() {
  const container = document.getElementById('bulkBooksSelect');
  container.innerHTML = '';

  const search = document.getElementById('bulkSearchBookInput').value.toLowerCase();
  const subject = document.getElementById('bulkSubjectFilter').value.toLowerCase();
  const level = document.getElementById('bulkLevelFilter').value;
  const grade = document.getElementById('bulkGradeFilter').value;

  books.forEach((b, i) => {
    const nameMatch = !search || (b.name || '').toLowerCase().includes(search);
    const subjectMatch = !subject || (b.subject || '').toLowerCase().includes(subject);
    const levelMatch = !level || b.level === level;
    const gradeMatch = !grade || b.grade === grade;

    if (nameMatch && subjectMatch && levelMatch && gradeMatch) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = b.id; // שימוש ב־id במקום index
      checkbox.id = 'bulk_' + b.id;
      checkbox.checked = selectedBulkBookIds.has(b.id); // שמירת סימון

      checkbox.addEventListener('change', e => {
        if (e.target.checked) {
          selectedBulkBookIds.add(b.id);
        } else {
          selectedBulkBookIds.delete(b.id);
        }
      });

      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = `${b.name} (${b.subject}, שכבת ${b.grade})`;
      label.prepend(checkbox);

      container.appendChild(label);
    }
  });
}

function printStudentCard(index) {
  const student = students[index];
  if (!student) return;

  const studentUnreturned = borrowed.filter(b =>
    b.student.id === student.id &&
    !returned.some(r => r.id === b.id) &&
    !charges.some(c => c.studentId === student.id && c.borrowId === b.id)
  );

  const unpaidCharges = charges.filter(c => c.studentId === student.id && !c.paid);
  const logoPath = 'katzir-logo.jpeg';

  const content = `
    <div style="font-family: Arial; direction: rtl; padding: 20px; text-align: center;">
      <img src="${logoPath}" alt="סמל בית ספר" style="width: 100px;">
      <h2 style="margin: 5px 0;">כרטיס תלמיד</h2>
      <p><b>שם:</b> ${student.name}</p>
      <p><b>ת"ז:</b> ${student.id}</p>
      <p><b>כיתה:</b> ${student.classroom} | <b>בי"ס:</b> ${student.school}</p>

      ${
        (studentUnreturned.length > 0 || unpaidCharges.length > 0)
        ? `
          ${studentUnreturned.length > 0 ? `
            <h4 style="margin-top: 15px;">ספרים שטרם הוחזרו:</h4>
            <ul style="text-align: right; font-size: 14px;">
              ${studentUnreturned.map(b => `<li>${b.book.name} (${b.book.subject})</li>`).join('')}
            </ul>
          ` : ''}
          ${unpaidCharges.length > 0 ? `
            <h4 style="margin-top: 15px;">ספרים שחויבו (לא שולם):</h4>
            <ul style="text-align: right; font-size: 14px;">
              ${unpaidCharges.map(c => `<li>${c.bookName} (${c.type})</li>`).join('')}
            </ul>
          ` : ''}
        `
        : `<p style="margin-top: 15px; font-size: 16px; color: green;"><b>החזיר/ה הכל</b></p>`
      }
    </div>
  `;

  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html lang="he" dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>כרטיס תלמיד</title>
      <style>
        @media print {
          body { width: 105mm; height: 148mm; margin: 0; } /* A6 */
        }
      </style>
    </head>
    <body>
      ${content}
      <script>
        window.onload = () => window.print();
      <\/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}



function confirmBulkLend() {
  if (!document.getElementById('bulkConfirmCheckbox').checked)
    return alert("יש לאשר את ההצהרה");

  if (isBulkSignatureEmpty())
    return alert("חתימה נדרשת");

const selectedBooks = Array.from(document.querySelectorAll('#bulkBooksSelect input[type=checkbox]:checked'))
  .map(cb => books.find(b => b.id === cb.value))
  .filter(Boolean); // מסנן undefined אם יש בעיה
  if (selectedBooks.length === 0) return alert("בחר לפחות ספר אחד");

  const filteredStudents = students.filter((s, i) => {
    const search = document.getElementById('studentTableSearch').value.toLowerCase();
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());
    return values.some(v => v.includes(search) || search === '');
  });

  const now = new Date().toISOString();
  const signatureData = bulkCanvas.toDataURL();
  let count = 0;
  const bulkId = crypto.randomUUID(); // מזהה קבוצת ההשאלה

  filteredStudents.forEach(student => {
    selectedBooks.forEach(book => {
      const already = borrowed.some(b =>
        b.student.id === student.id &&
        b.book.id === book.id &&
        !returned.some(r => r.id === b.id)
      );

      if (!already) {
borrowed.push({
  id: crypto.randomUUID(),
  student,
  book,
  date: now,
  signature: signatureData,
  bulkId: bulkId
});
        count++;
      }
    });
  });

  if (count === 0) {
    alert("כל הספרים שנבחרו כבר הושאלו לכל התלמידים");
  } else {
    saveData();
    showSuccess(`הושאלו ${count} ספרים לתלמידים`);
  }

  document.getElementById('bulkLendModal').style.display = 'none';
  filterBooks();
  renderStudentTable();
}

    function selectAllCheckboxes(containerId, checked) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  checkboxes.forEach(cb => cb.checked = checked);
}

function renderStudentTable(page = 1) {
  currentStudentPage = page;

  const tbody = document.querySelector('#studentTable tbody');
  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  const filterGrade = document.getElementById('filterGrade').value;
  const filterClassroom = document.getElementById('filterClassroom').value.toLowerCase();
  const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
  const filterLevel = document.getElementById('filterLevel').value;
  const filterInLoanProject = document.getElementById('filterInLoanProject')?.value || '';

  tbody.innerHTML = '';

  // סינון התלמידים לפי הקריטריונים
  const filteredStudents = students.filter(s => {
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());

    const chargedBorrowIds = new Set(
      charges.filter(c => c.studentId === s.id && !c.paid).map(c => c.borrowId)
    );

    const passSearch = values.some(v => v.includes(search)) || search === '';
    const passGrade = !filterGrade || s.classroom?.startsWith(filterGrade);
    const passClassroom = !filterClassroom || (s.classroom || '').toLowerCase() === filterClassroom;

    const hasMatchingBook = borrowed.some(b => {
      if (b.student.id !== s.id) return false;

      const subjectMatch = !filterSubject || (b.book.subject || '').toLowerCase().trim().includes(filterSubject.trim());
      const levelMatch =
        !filterLevel ||
        b.book.level === filterLevel ||
        (!b.book.level && filterLevel === '') ||
        (b.book.level === 'כללי' && filterLevel === '');

      const notChargedOrPaid = !chargedBorrowIds.has(b.id);

      return subjectMatch && levelMatch && notChargedOrPaid;
    });

    const passSubjectAndLevel = (!filterSubject && !filterLevel) || hasMatchingBook;

    const passInLoanProject =
      filterInLoanProject === '' ||
      (filterInLoanProject === 'true' && s.inLoanProject === true) ||
      (filterInLoanProject === 'false' && s.inLoanProject === false);

    return passSearch && passGrade && passClassroom && passSubjectAndLevel && passInLoanProject;
  });

  const totalPages = Math.ceil(filteredStudents.length / ITEMS_PER_PAGE);
  if (page > totalPages) currentStudentPage = 1;

  const pagedStudents = filteredStudents.slice((currentStudentPage - 1) * ITEMS_PER_PAGE, currentStudentPage * ITEMS_PER_PAGE);

  pagedStudents.forEach((s, i) => {
    const actualIndex = (currentStudentPage - 1) * ITEMS_PER_PAGE + i;

    const chargedBorrowIds = new Set(
      charges.filter(c => c.studentId === s.id && !c.paid).map(c => c.borrowId)
    );

    // הוספתי כרך בסוגריים לצד המקצוע
    const borrowedBooks = borrowed
      .filter(b => b.student.id === s.id && !returned.some(r => r.id === b.id) && !chargedBorrowIds.has(b.id))
      .map(b => `${b.book.name} (${b.book.subject}, כרך ${b.book.volume})`);

    // כל ספר ב־div נפרד להפרדה ושורות ברורות
    const borrowedListHTML = borrowedBooks.length > 0
      ? borrowedBooks.map(book => `<div style="padding: 2px 0;">${book}</div>`).join('')
      : "<div style='color: green;'>החזיר הכל</div>";

    const nameStyleColor = s.inLoanProject ? 'green' : 'red';

    // להסרת כפילויות של bulkId בתאריכי השאלה
    const seenBulkIds = new Set();
    const borrowTimes = borrowed
      .filter(b => b.student.id === s.id)
      .filter(b => {
        if (b.bulkId && seenBulkIds.has(b.bulkId)) return false;
        if (b.bulkId) {
          seenBulkIds.add(b.bulkId);
          return true;
        }
        return true;
      })
      .map(b => new Date(b.date).toLocaleString('he-IL'));

    const borrowTimesText = borrowTimes.length > 0 ? borrowTimes.join('<br>') : 'אין השאלות';

    const seenReturnBulkIds = new Set();
    const returnTimes = returned
      .filter(r => r.student.id === s.id)
      .filter(r => {
        if (r.bulkId && seenReturnBulkIds.has(r.bulkId)) return false;
        if (r.bulkId) {
          seenReturnBulkIds.add(r.bulkId);
          return true;
        }
        return true;
      })
      .map(r => new Date(r.returnDate).toLocaleString('he-IL'));

    const returnTimesText = returnTimes.length > 0 ? returnTimes.join('<br>') : 'אין החזרות';

    const studentCharges = charges.filter(c => c.studentId === s.id);
    const unpaidCharges = studentCharges.filter(c => !c.paid);
    const totalDebt = unpaidCharges.length * 50;

    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #ddd';

    tr.innerHTML = `
      <td style="padding: 10px; max-width: 180px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: ${nameStyleColor}; vertical-align: top;" title="${s.name}">${s.name}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center; vertical-align: top;">${s.id}</td>
      <td style="padding: 10px; min-width: 60px; text-align: center; vertical-align: top;">${s.classroom}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center; vertical-align: top;">${s.school}</td>
      <td style="padding: 10px; min-width: 80px; text-align: center; vertical-align: top;">${totalDebt > 0 ? totalDebt + ' ש"ח' : 'ללא'}</td>

      <td class="borrowed-books-cell" style="vertical-align: top;">
        ${borrowedListHTML}
      </td>

      <td style="padding: 10px; min-width: 180px; text-align: center; vertical-align: top;">${borrowTimesText}</td>
      <td style="padding: 10px; min-width: 180px; text-align: center; vertical-align: top;">${returnTimesText}</td>
      <td style="padding: 10px; text-align: center; vertical-align: top;">
        <button onclick="editStudent(${actualIndex});" title="עריכת פרטי תלמיד"><i class="fas fa-pencil"></i></button>
        <button onclick="deleteStudentFromTable(${actualIndex})" title="מחק תלמיד"><i class="fas fa-trash"></i></button>
        <button onclick="exportSingleStudent(${actualIndex})" title="ייצא פרטי תלמיד"><i class="fas fa-download"></i></button>
        <button onclick="viewStudentDetails(${actualIndex})" title="צפייה בפרטי התלמיד"><i class="fas fa-eye"></i></button>
        ${totalDebt > 0 ? `<button onclick="clearStudentDebt('${s.id}')" title="ניקוי חוב התלמיד"><i class="fas fa-dollar-sign"></i></button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });

  renderStudentPagination(totalPages);
}

function renderStudentPagination(totalPages) {
  let paginationContainer = document.getElementById('studentPagination');
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'studentPagination';
    document.getElementById('studentTable').parentNode.insertBefore(paginationContainer, document.getElementById('studentTable').nextSibling);
  }
  paginationContainer.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.classList.toggle('active', i === currentStudentPage);
    btn.disabled = (i === currentStudentPage);
    btn.onclick = () => renderStudentTable(i);
    paginationContainer.appendChild(btn);
  }
}

 
  const tbody = document.querySelector('#studentTable tbody');
  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  tbody.innerHTML = '';

  const filterGrade = document.getElementById('filterGrade').value;
  const filterClassroom = document.getElementById('filterClassroom').value.toLowerCase();
  const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
  const filterLevel = document.getElementById('filterLevel').value;

  students.forEach((s, i) => {
    const values = [s.name, s.id, s.classroom, s.school];

    const hasMatchingBook = borrowed.some(b => {
      if (b.student.id !== s.id) return false;

      const subjectMatch = !filterSubject || (b.book.subject || '').toLowerCase().trim().includes(filterSubject.trim());
      const levelMatch =
        !filterLevel ||
        b.book.level === filterLevel ||
        (!b.book.level && filterLevel === '') ||
        (b.book.level === 'כללי' && filterLevel === '');

      return subjectMatch && levelMatch;
    });

    const passSearch = values.some(v => (v || '').toLowerCase().includes(search)) || search === '';
    const passGrade = !filterGrade || s.classroom?.startsWith(filterGrade);
    const passClassroom = !filterClassroom || (s.classroom || '').toLowerCase() === filterClassroom;
    const passSubjectAndLevel = (!filterSubject && !filterLevel) || hasMatchingBook;

    if (passSearch && passGrade && passClassroom && passSubjectAndLevel) {
      const tr = document.createElement('tr');

      const borrowedBooks = borrowed
        .filter(b => b.student.id === s.id && !returned.some(r => r.id === b.id))
        .map(b => `${b.book.name} (${b.book.subject})`);

      const borrowedText = borrowedBooks.length > 0 ? borrowedBooks.join(', ') : "החזיר הכל";

      // ✅ תיקון: לא מציגים תאריכים כפולים באותה השאלה מרוכזת (bulkId)
      const seenBulkIds = new Set();
      const borrowTimes = borrowed
        .filter(b => b.student.id === s.id)
        .filter(b => {
          if (b.bulkId && seenBulkIds.has(b.bulkId)) return false;
          if (b.bulkId) {
            seenBulkIds.add(b.bulkId);
            return true;
          }
          return true; // הצג גם אם אין bulkId
        })
        .map(b => new Date(b.date).toLocaleString('he-IL'));

      const borrowTimesText = borrowTimes.length > 0 ? borrowTimes.join('<br>') : 'אין השאלות';

const seenReturnBulkIds = new Set();
const returnTimes = returned
  .filter(r => r.student.id === s.id)
  .filter(r => {
    if (r.bulkId && seenReturnBulkIds.has(r.bulkId)) return false;
    if (r.bulkId) {
      seenReturnBulkIds.add(r.bulkId);
      return true;
    }
    return true; // הצג גם אם אין bulkId
  })
  .map(r => new Date(r.returnDate).toLocaleString('he-IL'));


      const returnTimesText = returnTimes.length > 0 ? returnTimes.join('<br>') : 'אין החזרות';

      tr.innerHTML = `
<td style="padding: 10px; max-width: 180px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${s.name}">${s.name}</td>
<td style="padding: 10px; min-width: 100px; text-align: center;">${s.id}</td>
<td style="padding: 10px; min-width: 60px; text-align: center;">${s.classroom}</td>
<td style="padding: 10px; min-width: 100px; text-align: center;">${s.school}</td>
<td style="padding: 10px; max-width: 200px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${borrowedText}">${borrowedText}</td>
<td style="padding: 10px; min-width: 180px; text-align: center;">${borrowTimesText}</td>
<td style="padding: 10px; min-width: 180px; text-align: center;">${returnTimesText}</td>
<td style="padding: 10px; text-align: center;">
  <button onclick="selectStudent(${i}); scrollToSection('borrowSection')">השאל</button>
  <button onclick="selectStudent(${i}); scrollToSection('borrowSection')">החזר</button>
  <button onclick="deleteStudentFromTable(${i})">מחק</button>
  <button onclick="exportSingleStudent(${i})">ייצא</button>
  <button onclick="viewStudentDetails(${i})">צפייה</button>
</td>
      `;

      tr.style.borderBottom = '1px solid #ddd';
      tbody.appendChild(tr);
    }
  });

function exportFilteredStudents() {
  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  const filterInLoanProject = document.getElementById('filterInLoanProject').value;

  const filtered = students.filter(s => {
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());

    const passInLoanProject =
      filterInLoanProject === '' ||
      (filterInLoanProject === 'true' && s.inLoanProject === true) ||
      (filterInLoanProject === 'false' && s.inLoanProject === false);

    return values.some(v => v.includes(search) || search === '') && passInLoanProject;
  });

  const headers = [
    "שם מלא",
    "תעודת זהות",
    "בית ספר",
    "כיתה",
    "משתתף בפרויקט השאלת ספרים",  // הוספה
    "ספרים שהושאלו",
    "ספרים שחויבו",
    "חוב כולל (₪)"
  ];

  const rows = filtered.map(student => {
    const borrowedBooks = borrowed
      .filter(b => b.student.id === student.id && !returned.some(r => r.id === b.id))
      .map(b => `${b.book.name} (${b.book.subject})`)
      .join(', ') || "אין";

    const unpaidCharges = charges.filter(c => c.studentId === student.id && !c.paid);
    const chargedBooks = unpaidCharges.map(c => `${c.bookName} (${c.type})`).join(', ') || "אין";
    const totalDebt = unpaidCharges.length * 50;

    return [
      student.name,
      student.id,
      student.school,
      student.classroom,
      student.inLoanProject ? "כן" : "לא",  // הוספה
      borrowedBooks,
      chargedBooks,
      totalDebt > 0 ? totalDebt : "0"
    ];
  });

  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'תלמידים');
  XLSX.writeFile(wb, 'filtered_students.xlsx');
}

function exportSingleStudent(index) {
  const student = students[index];
  if (!student) return;

  const studentBorrows = borrowed.filter(b => b.student.id === student.id && !returned.some(r => r.id === b.id));
  const studentCharges = charges.filter(c => c.studentId === student.id);
  const unpaidCharges = studentCharges.filter(c => !c.paid);
  const totalDebt = unpaidCharges.length * 50;

  const borrowedBooks = studentBorrows.map(b => `${b.book.name} (${b.book.subject})`).join(', ') || "אין";
  const chargedBooks = unpaidCharges.map(c => `${c.bookName} (${c.type})`).join(', ') || "אין";

  const headers = [
    "שם מלא",
    "תעודת זהות",
    "בית ספר",
    "כיתה",
    "משתתף בפרויקט השאלת ספרים", // הוספה
    "ספרים מושאלים",
    "ספרים שחויבו",
    "חוב כולל (₪)"
  ];

  const row = [
    student.name,
    student.id,
    student.school,
    student.classroom,
    student.inLoanProject ? "כן" : "לא",  // הוספה
    borrowedBooks,
    chargedBooks,
    totalDebt > 0 ? totalDebt : "0"
  ];

  const ws = XLSX.utils.aoa_to_sheet([headers, row]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'תלמיד');
  XLSX.writeFile(wb, `student_${student.id}.xlsx`);
}

function renderBookTable(page = 1) {
  currentBookPage = page;

  const tbody = document.querySelector('#bookTable tbody');
  const search = document.getElementById('bookTableSearch').value.toLowerCase();

  const selectedLevel = document.getElementById('bookLevelFilter').value;
  const selectedVolume = document.getElementById('bookVolumeFilter').value;
  const selectedPublisher = document.getElementById('bookPublisherFilter').value.toLowerCase();
  const selectedType = document.getElementById('bookTypeFilter').value;

  tbody.innerHTML = '';

  const filteredBooks = books.filter(b => {
    const values = [
      b.name,
      b.subject,
      b.grade,
      b.level,
      b.volume,
      b.publisher,
      b.type
    ].map(x => (x || '').toLowerCase());

    const matchesSearch = values.some(v => v.includes(search)) || search === '';
    const matchesLevel = !selectedLevel || b.level === selectedLevel;
    const matchesVolume = !selectedVolume || b.volume === selectedVolume;
    const matchesPublisher = !selectedPublisher || (b.publisher || '').toLowerCase().includes(selectedPublisher);
    const matchesType = !selectedType || b.type === selectedType;

    return matchesSearch && matchesLevel && matchesVolume && matchesPublisher && matchesType;
  });

  const totalPages = Math.ceil(filteredBooks.length / ITEMS_PER_PAGE);
  if (page > totalPages) currentBookPage = 1;

  const pagedBooks = filteredBooks.slice((currentBookPage - 1) * ITEMS_PER_PAGE, currentBookPage * ITEMS_PER_PAGE);

  pagedBooks.forEach((b, i) => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td style="padding: 10px; min-width: 200px; text-align: right;">${b.name}</td>
      <td style="padding: 10px; min-width: 150px; text-align: right;">${b.subject}</td>
      <td style="padding: 10px; min-width: 80px; text-align: center;">${b.grade}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center;">${b.level || 'כללי'}</td>
      <td style="padding: 10px; min-width: 60px; text-align: center;">${b.volume}</td>
      <td style="padding: 10px; min-width: 150px; text-align: center;">${b.publisher}</td>
      <td style="padding: 10px; min-width: 100px; text-align: center;">${b.type}</td>
      <td style="padding: 10px; text-align: center;">
        <button onclick="editBook(${i})" title="ערוך ספר"><i class="fas fa-pencil"></i></button>
        <button onclick="deleteBookFromTable(${i})" title="מחק ספר"><i class="fas fa-trash"></i></button>
      </td>
    `;

    tr.style.borderBottom = '1px solid #ddd';
    tbody.appendChild(tr);
  });

  renderBookPagination(totalPages);
}

function renderBookPagination(totalPages) {
  let paginationContainer = document.getElementById('bookPagination');
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'bookPagination';
    document.getElementById('bookTable').parentNode.insertBefore(paginationContainer, document.getElementById('bookTable').nextSibling);
  }
  paginationContainer.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.classList.toggle('active', i === currentBookPage);
    btn.disabled = (i === currentBookPage);
    btn.onclick = () => renderBookTable(i);
    paginationContainer.appendChild(btn);
  }
}


function deleteStudentFromTable(index) {
  if (!confirm('האם למחוק תלמיד זה?')) return;
  students.splice(index, 1);
  borrowed = borrowed.filter(b => b.student.id !== students[index]?.id);
  saveData();
  renderStudentTable();
  filterStudents();
  showSuccess('תלמיד נמחק');
}

function deleteBookFromTable(index) {
  if (!confirm('האם למחוק ספר זה?')) return;
  books.splice(index, 1);
  saveData();
  renderBookTable();
  filterBooks();
  showSuccess('ספר נמחק');
}

function selectStudent(index) {
  const sel = document.getElementById('filteredStudentsSelect');
  sel.value = index;
  filterBooks();
  updateReturnBooks(index);
}

function scrollToSection(anchor) {
  const target = document.getElementById('filteredStudentsSelect');
  if (target) {
    const offset = target.getBoundingClientRect().top + window.pageYOffset - 100;
    window.scrollTo({ top: offset, behavior: 'smooth' });
    target.classList.add('blink-highlight');
    setTimeout(() => target.classList.remove('blink-highlight'), 1000);
  }
}

document.getElementById('studentTableSearch').addEventListener('input', renderStudentTable);
document.getElementById('bookTableSearch').addEventListener('input', renderBookTable);

window.addEventListener("DOMContentLoaded", () => {
  loadData().then(() => {
    console.log("✅ נתונים נטענו – מוכן לשימוש");
    // אל תקרא ל-saveData() כאן!
  });
});
renderStudentTable();
renderBookTable();
</script>

<script>
const userIdHeader = { 'x-user-id': 'some-user-id' };

async function loadData() {
  try {
    students = await fetch(yearKey('students'), { headers: userIdHeader }).then(res => res.json());
    books = await fetch(yearKey('books'), { headers: userIdHeader }).then(res => res.json());
    borrowed = await fetch(yearKey('borrowed'), { headers: userIdHeader }).then(res => res.json());
    returned = await fetch(yearKey('returned'), { headers: userIdHeader }).then(res => res.json());
    charges = await fetch(yearKey('charges'), { headers: userIdHeader }).then(res => res.json());

    filterStudents();
    filterBooks();
  } catch (error) {
    console.error("Error loading data:", error);
    // טיפול בשגיאות במידת הצורך
  }
}

async function saveData() {
  if (!students.length && !books.length && !borrowed.length && !returned.length && !charges.length) return;

  try {
    await Promise.all([
      fetch(yearKey('students'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(students) }),
      fetch(yearKey('books'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(books) }),
      fetch(yearKey('borrowed'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(borrowed) }),
      fetch(yearKey('returned'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(returned) }),
      fetch(yearKey('charges'), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...userIdHeader }, body: JSON.stringify(charges) }),
    ]);
  } catch (error) {
    console.error("Error saving data:", error);
  }
}


function showSuccess(msg) {
  const el = document.getElementById('successMsg');
  el.textContent = "✅ " + msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

function isValidIsraeliID(id) {
  // הסרת רווחים ותווים לא מספריים
  id = id.trim();
  if (!/^\d{5,9}$/.test(id)) return false; // חייב להיות בין 5 ל-9 ספרות

  // הוספת אפסים מובילים עד 9 ספרות
  id = id.padStart(9, '0');

  let sum = 0;
  for (let i = 0; i < 9; i++) {
    let digit = parseInt(id.charAt(i), 10);
    let factor = (i % 2) + 1; // 1 או 2 לסירוגין החל מהספרה הראשונה

    let multiplied = digit * factor;
    // אם המכפלה דו-ספרתית, חיבור הספרות (לדוגמה 12 => 1 + 2 = 3)
    if (multiplied > 9) multiplied -= 9;

    sum += multiplied;
  }

  // אם סכום הספרות מתחלק ב-10, התעודה תקינה
  return sum % 10 === 0;
}

function addStudent() {
  const name = document.getElementById('studentName').value.trim();
  const id = document.getElementById('studentID').value.trim();
  const school = document.getElementById('studentSchool').value;
  const classroom = document.getElementById('studentClass').value.trim();
  const inLoanProjectValue = document.getElementById('studentInLoanProject').value;

  if (!name || !id || !classroom || inLoanProjectValue === '') {
    return alert('נא למלא את כל השדות כולל האם משתתף בפרויקט');
  }

    if (!isValidIsraeliID(id)) {
    return alert('תעודת זהות לא תקינה');
  }

  if (students.some(s => s.id === id)) {
    alert("תלמיד עם תעודת זהות זו כבר קיים במערכת");
    return;
  }

  const inLoanProject = inLoanProjectValue === 'true';

  students.push({ name, id, school, classroom, inLoanProject });
  saveData();
  showSuccess("תלמיד נוסף");
  filterStudents();

  // איפוס טופס (רשות)
  document.getElementById('studentName').value = '';
  document.getElementById('studentID').value = '';
  document.getElementById('studentClass').value = '';
  document.getElementById('studentInLoanProject').value = '';
}

function addBook() {
  const name = document.getElementById('bookName').value.trim();
  const subject = document.getElementById('bookSubject').value.trim();
  const grade = document.getElementById('bookGrade').value.trim();
  const level = document.getElementById('bookLevel').value;
  const volume = document.getElementById('bookVolume').value;
  const publisher = document.getElementById('bookPublisher').value.trim();
  const type = document.getElementById('bookType').value;

  if (!name || !subject || !grade || !level || !volume || !publisher || !type) {
    return alert('נא למלא את כל השדות חובה לספר');
  }

  // בדיקה אם קיים ספר עם אותו שם ועם אותו כרך
  const exists = books.some(b =>
    b.name === name &&
    b.volume === volume
  );

  if (exists) {
    alert("ספר עם אותו שם ועם אותו כרך כבר קיים במערכת");
    return;
  }

  books.push({
    id: crypto.randomUUID(),
    name,
    subject,
    grade,
    level,
    volume,
    publisher,
    type
  });

  saveData();
  showSuccess("ספר נוסף");
  filterBooks();

  // איפוס טופס (רשות)
  document.getElementById('bookName').value = '';
  document.getElementById('bookSubject').value = '';
  document.getElementById('bookGrade').value = '';
  document.getElementById('bookLevel').value = 'כללי';
  document.getElementById('bookVolume').value = '';
  document.getElementById('bookPublisher').value = '';
  document.getElementById('bookType').value = '';
}

function filterStudents() {
  const search = document.getElementById('searchStudentInput').value.toLowerCase();
  const select = document.getElementById('filteredStudentsSelect');
  select.innerHTML = '';

  students.forEach((s, i) => {
    const values = [s.name, s.id, s.classroom, s.school].map(x => (x || '').toLowerCase());
    if (values.some(x => x.includes(search))) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${s.name} (${s.classroom}, ${s.school})`;
      select.appendChild(option);
    }
  });

  // בחר את הראשון אוטומטית אם יש אפשרויות
  if (select.options.length > 0) {
    select.selectedIndex = 0;
  }

  updateBorrowPurchaseButtons();

  filterBooks();
}

window.onscroll = function () {
  const btn = document.getElementById('scrollTopBtn');
  if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
    btn.style.display = "block";
  } else {
    btn.style.display = "none";
  }
};

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


// פונקציה לעדכון כפתורי "השאל" ו"רכישה" לפי סטטוס השתתפות בפרויקט
function updateBorrowPurchaseButtons() {
  const select = document.getElementById('filteredStudentsSelect');
  const selectedIndex = select.value;
  const student = students[selectedIndex];

  const btnBorrow = document.getElementById('btnBorrow');
  const btnPurchase = document.getElementById('btnPurchase');

  if (student && student.inLoanProject) {
    btnBorrow.style.display = 'inline-block';
    btnPurchase.style.display = 'none';
  } else {
    btnBorrow.style.display = 'none';
    btnPurchase.style.display = 'inline-block';
  }
}

// מאזין לשינוי הבחירה ב־select, יעדכן את הכפתורים בזמן אמת
document.getElementById('filteredStudentsSelect').addEventListener('change', () => {
  updateBorrowPurchaseButtons();
  filterBooks();
});

function filterBooks() {
  const search = document.getElementById('searchBookInput').value.toLowerCase();
  const selectedLevel = document.getElementById('levelFilter').value;
  const selectedVolume = document.getElementById('volumeFilter').value; // חדש
  const selectedPublisher = document.getElementById('publisherFilter').value.toLowerCase(); // חדש
  const selectedType = document.getElementById('typeFilter').value; // חדש
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  const container = document.getElementById('filteredBooksSelect');
  container.innerHTML = '';

  if (studentIdx === '') return;
  const student = students[studentIdx];
  const grade = student?.classroom?.[0];

  books.forEach((b, i) => {
    const values = [b.name, b.subject, b.grade, b.volume, b.publisher, b.type].map(x => (x || '').toLowerCase());

    const alreadyBorrowedAndNotReturned = borrowed.some(br =>
      br.student.id === student.id &&
      br.book.id === b.id &&
      !returned.some(r => r.id === br.id)
    );

    const matchesSearch = values.some(x => x.includes(search));
    const matchesLevel = selectedLevel === '' || b.level === selectedLevel;
    const matchesVolume = selectedVolume === '' || b.volume === selectedVolume;
    const matchesPublisher = selectedPublisher === '' || (b.publisher || '').toLowerCase().includes(selectedPublisher);
    const matchesType = selectedType === '' || b.type === selectedType;

    if (
      b.grade === grade &&
      matchesLevel &&
      matchesVolume &&
      matchesPublisher &&
      matchesType &&
      matchesSearch &&
      !alreadyBorrowedAndNotReturned
    ) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = i;
      checkbox.id = 'book_' + i;

      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = `${b.name} (${b.subject}, ${b.grade})`;
      label.prepend(checkbox);

      container.appendChild(label);
    }
  });

  updateReturnBooks(studentIdx);
}

let pendingChargeStudent = null;
let charges = [];

function openChargeModal() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("בחר תלמיד");
  const student = students[studentIdx];
  pendingChargeStudent = student;

  const container = document.getElementById('chargeBooksList');
  container.innerHTML = '';

const stillBorrowed = borrowed.filter(b =>
  b.student.id === student.id &&
  !returned.some(r => r.id === b.id) && // לא הוחזר
  !charges.some(c => c.studentId === student.id && c.borrowId === b.id) // לא חויב כבר
);


  stillBorrowed.forEach((entry, i) => {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '10px';

    const label = document.createElement('label');
    label.textContent = `${entry.book.name} (${entry.book.subject})`;

    const select = document.createElement('select');
    select.dataset.bookId = entry.id;
    select.innerHTML = `
      <option value="">ללא חיוב</option>
      <option value="אבד">אבד</option>
      <option value="בלאי">בלאי</option>
    `;

    wrapper.appendChild(label);
    wrapper.appendChild(select);
    container.appendChild(wrapper);
  });

  document.getElementById('chargeModal').style.display = 'flex';
}

function confirmCharge() {
  const selects = document.querySelectorAll('#chargeBooksList select');
  let count = 0;

  selects.forEach(sel => {
    const type = sel.value;
    if (type && pendingChargeStudent) {
      const bookEntry = borrowed.find(b =>
        b.id === sel.dataset.bookId && b.student.id === pendingChargeStudent.id
      );

      if (bookEntry) {
        charges.push({
          studentId: pendingChargeStudent.id,
          bookName: bookEntry.book.name,
          type: type,
          date: new Date().toISOString(),
          paid: false,
          borrowId: bookEntry.id // ← השדה הקריטי
        });
        count++;
      }
    }
  });

  if (count === 0) return alert("לא נבחרו ספרים לחיוב");

  const confirmed = confirm("האם את\\ה בטוח\\ה שסיימת לחייב את כל הספרים הנדרשים?");
  if (!confirmed) return; // ❌ עצור אם המשתמש לחץ 'ביטול'

  saveData();
  showSuccess(`${count} ספרים חויבו`);
  document.getElementById('chargeModal').style.display = 'none';

  const idx = students.findIndex(s => s.id === pendingChargeStudent?.id);
  if (idx !== -1) {
    viewStudentDetails(idx);
    updateReturnBooks(idx);
    filterBooks();
  }

  renderStudentTable();
  pendingChargeStudent = null;
}

function deleteFilteredStudents() {
  if (!confirm('האם למחוק את כל התלמידים המופיעים בתצוגה? פעולה זו אינה ניתנת לביטול.')) return;

  const search = document.getElementById('studentTableSearch').value.toLowerCase();
  const filterGrade = document.getElementById('filterGrade').value;
  const filterClassroom = document.getElementById('filterClassroom').value.toLowerCase();
  const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
  const filterLevel = document.getElementById('filterLevel').value;
  const filterInLoanProject = document.getElementById('filterInLoanProject').value;

  // איתור כל התלמידים שעומדים בתנאי הסינון
  const studentsToDelete = students.filter(s => {
    const values = [s.name, s.id, s.classroom, s.school].map(v => (v || '').toLowerCase());

    const chargedBorrowIds = new Set(
      charges.filter(c => c.studentId === s.id && !c.paid).map(c => c.borrowId)
    );

    const passSearch = values.some(v => v.includes(search)) || search === '';
    const passGrade = !filterGrade || s.classroom?.startsWith(filterGrade);
    const passClassroom = !filterClassroom || (s.classroom || '').toLowerCase() === filterClassroom;

    const hasMatchingBook = borrowed.some(b => {
      if (b.student.id !== s.id) return false;

      const subjectMatch = !filterSubject || (b.book.subject || '').toLowerCase().trim().includes(filterSubject.trim());
      const levelMatch =
        !filterLevel ||
        b.book.level === filterLevel ||
        (!b.book.level && filterLevel === '') ||
        (b.book.level === 'כללי' && filterLevel === '');

      const notChargedOrPaid = !chargedBorrowIds.has(b.id);

      return subjectMatch && levelMatch && notChargedOrPaid;
    });

    const passSubjectAndLevel = (!filterSubject && !filterLevel) || hasMatchingBook;

    const passInLoanProject =
      filterInLoanProject === '' ||
      (filterInLoanProject === 'true' && s.inLoanProject === true) ||
      (filterInLoanProject === 'false' && s.inLoanProject === false);

    return passSearch && passGrade && passClassroom && passSubjectAndLevel && passInLoanProject;
  });

  if (studentsToDelete.length === 0) {
    alert('אין תלמידים למחיקה לפי הסינון הנוכחי');
    return;
  }

  // מחיקת כל התלמידים שנבחרו
  const idsToDelete = new Set(studentsToDelete.map(s => s.id));
  students = students.filter(s => !idsToDelete.has(s.id));

  // מחיקת השאלות וההחזרות שלהם
  borrowed = borrowed.filter(b => !idsToDelete.has(b.student.id));
  returned = returned.filter(r => !idsToDelete.has(r.student.id));
  charges = charges.filter(c => !idsToDelete.has(c.studentId));

  saveData();
  showSuccess(`נמחקו ${studentsToDelete.length} תלמידים`);

  renderStudentTable();
  filterStudents();
}

function deleteFilteredBooks() {
  if (!confirm('האם למחוק את כל הספרים המופיעים בתצוגה? פעולה זו אינה ניתנת לביטול.')) return;

  const search = document.getElementById('bookTableSearch').value.toLowerCase();
  const selectedLevel = document.getElementById('bookLevelFilter').value;
  const selectedVolume = document.getElementById('bookVolumeFilter').value;
  const selectedPublisher = document.getElementById('bookPublisherFilter').value.toLowerCase();
  const selectedType = document.getElementById('bookTypeFilter').value;

  // איתור כל הספרים שעומדים בתנאי הסינון
  const booksToDelete = books.filter(b => {
    const values = [
      b.name,
      b.subject,
      b.grade,
      b.level,
      b.volume,
      b.publisher,
      b.type
    ].map(x => (x || '').toLowerCase());

    const matchesSearch = values.some(v => v.includes(search)) || search === '';
    const matchesLevel = !selectedLevel || b.level === selectedLevel;
    const matchesVolume = !selectedVolume || b.volume === selectedVolume;
    const matchesPublisher = !selectedPublisher || (b.publisher || '').toLowerCase().includes(selectedPublisher);
    const matchesType = !selectedType || b.type === selectedType;

    return matchesSearch && matchesLevel && matchesVolume && matchesPublisher && matchesType;
  });

  if (booksToDelete.length === 0) {
    alert('אין ספרים למחיקה לפי הסינון הנוכחי');
    return;
  }

  const idsToDelete = new Set(booksToDelete.map(b => b.id));
  books = books.filter(b => !idsToDelete.has(b.id));

  // מחיקת השאלות וההחזרות של הספרים
  borrowed = borrowed.filter(b => !idsToDelete.has(b.book.id));
  returned = returned.filter(r => !idsToDelete.has(r.book.id));
  charges = charges.filter(c => !idsToDelete.has(c.bookId));

  saveData();
  showSuccess(`נמחקו ${booksToDelete.length} ספרים`);

  renderBookTable();
  filterBooks();
}


function clearStudentDebt(studentId) {
  charges.forEach(c => {
    if (c.studentId === studentId && !c.paid) {
      c.paid = true;
      c.paidDate = new Date().toISOString();
    }
  });

  saveData();
  showSuccess("החוב סומן כמשולם");

  const idx = students.findIndex(s => s.id === studentId);
  if (idx !== -1) {
    updateReturnBooks(idx);
    filterBooks();
    viewStudentDetails(idx);
    renderStudentTable(); // עדכון הטבלה לאחר תשלום החוב
  }
}

function viewStudentDetails(index) {
  const student = students[index];
  if (!student) return;

  const studentCharges = charges.filter(c => c.studentId === student.id);
  const studentPaidCharges = studentCharges.filter(c => c.paid);
  const studentUnpaidCharges = studentCharges.filter(c => !c.paid);

  // כל מזהי ההשאלות שחויבו (לסינון מההשאלות)
  const chargedIds = new Set(
    studentCharges.map(c => c.borrowId).filter(Boolean)
  );

  const studentBorrows = borrowed.filter(b =>
    b.student.id === student.id && !chargedIds.has(b.id)
  );
  const studentReturns = returned.filter(r =>
    r.student.id === student.id && !chargedIds.has(r.id)
  );

  // ספרים שטרם הוחזרו (השאלות בלי החזרות)
  const booksStillBorrowed = studentBorrows.filter(b =>
    !studentReturns.some(r => r.id === b.id)
  );

  // ספרים שהוחזרו (רשומות החזרה ללא השאלה חדשה לאחר מכן)
  const booksReturned = studentReturns.filter(returnEntry => {
    return !borrowed.some(b =>
      b.student.id === student.id &&
      b.book.id === returnEntry.book.id &&
      b.id !== returnEntry.id &&
      new Date(b.date) > new Date(returnEntry.returnDate) &&
      !returned.some(r => r.id === b.id)
    );
  });

  const totalDebt = studentUnpaidCharges.length * 50;
  const totalPaid = studentPaidCharges.length * 50;

  let html = `
    <h4>${student.name}</h4>
    <p>תעודת זהות: ${student.id}</p>
    <p>כיתה: ${student.classroom}</p>
    <p>בית ספר: ${student.school}</p>
  `;

  if (totalDebt > 0) {
    html += `<p><b style="color: red;">חוב:</b> ${totalDebt} ש"ח</p>`;
    html += `<p><b style="color: red;">ספרים שחויבו:</b><ul>`;
    studentUnpaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      html += `<li style="color: red;">${c.bookName} (${c.type}) - חויב ב־${chargedAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (totalPaid > 0) {
    html += `<p><b style="color: green;">שולם:</b> ${totalPaid} ש"ח</p>`;
    html += `<p><b style="color: green;">ספרים שחויבו ושולמו:</b><ul>`;
    studentPaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      const paidAt = c.paidDate ? new Date(c.paidDate).toLocaleString('he-IL') : '---';
      html += `<li style="color: green;">${c.bookName} (${c.type}) - חויב ב־${chargedAt}, שולם ב־${paidAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksStillBorrowed.length > 0) {
    html += `<p><b>ספרים שטרם הוחזרו:</b><ul>`;
    booksStillBorrowed.forEach(b => {
      html += `<li>${b.book.name} (${b.book.subject}) - הושאל ב־${new Date(b.date).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksReturned.length > 0) {
    html += `<p><b>ספרים שהוחזרו:</b><ul>`;
    booksReturned.forEach(r => {
      html += `<li>${r.book.name} (${r.book.subject}) - הוחזר ב־${new Date(r.returnDate).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  // ===== הצגת חתימות עם שם וסוג החותם =====
  // קיבוץ לפי bulkId ו-date (קבוצה אחת לכל חתימה)
  const groupedBySignature = {};

  studentBorrows.forEach(b => {
    // key ייחודי לפי bulkId (או id אם אין) ותאריך
    const key = (b.bulkId || b.id) + '|' + b.date;

    if (!groupedBySignature[key]) {
      groupedBySignature[key] = {
        date: b.date,
        signature: b.signature,
        borrowerType: b.borrowerType || 'לא ידוע',
        borrowerName: b.borrowerName || 'לא ידוע'
      };
    }
  });

  const groupedEntries = Object.values(groupedBySignature);
  if (groupedEntries.length > 0) {
    html += `<p><b>חתימות על השאלות:</b></p>`;
    groupedEntries.forEach(g => {
      const dateStr = new Date(g.date).toLocaleString('he-IL');
      let signerInfo = '';

      if (g.borrowerType === 'student') {
        signerInfo = `תלמיד: ${g.borrowerName}`;
      } else if (g.borrowerType === 'parent') {
        signerInfo = `הורה/חבר: ${g.borrowerName}`;
      } else if (g.borrowerType === 'staff') {
        signerInfo = `בעל תפקיד: ${g.borrowerName}`;
      } else {
        signerInfo = `חותם: ${g.borrowerName}`;
      }

      html += `
        <div style="margin:10px 0; text-align: right;">
          <p style="margin:0;"><b>${dateStr} - ${signerInfo}</b></p>
          <img src="${g.signature}" alt="חתימה" style="border:1px solid #ccc; max-width:100%; height:auto; margin-top:5px;" />
        </div>
      `;
    });
  }

  html += `<button onclick="printStudentCard(${index})">🖨️ הדפס כרטיס</button>`;
  document.getElementById('studentDetailContent').innerHTML = html;
  document.getElementById('studentDetailModal').style.display = 'flex';
}

function returnToCharge() {
  returnToChargeMode = false;
  document.getElementById('studentDetailModal').style.display = 'none';
  if (pendingChargeStudent) {
    openChargeModal(pendingChargeStudent.id);
  }
}

function purchaseBook() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("בחר תלמיד");
  const student = students[studentIdx];

  const checkboxes = document.querySelectorAll('#filteredBooksSelect input[type=checkbox]:checked');
  if (checkboxes.length === 0) return alert("בחר לפחות ספר אחד לרכישה");

  const list = document.getElementById('borrowBookList');
  list.innerHTML = '';
  checkboxes.forEach(cb => {
    const b = books[cb.value];
    const li = document.createElement('li');
    li.textContent = `${b.name} (${b.subject}, שכבת ${b.grade}${b.level ? `, רמה ${b.level}` : ''})`;
    list.appendChild(li);
  });

  document.getElementById('confirmBorrowCheckbox').checked = false;

  // פותח את המודל עם טקסטים של רכישה
  openConfirmModal('רכישה');
}
function borrowBook() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("בחר תלמיד");
  const student = students[studentIdx];

  const checkboxes = document.querySelectorAll('#filteredBooksSelect input[type=checkbox]:checked');
  if (checkboxes.length === 0) return alert("בחר לפחות ספר אחד להשאלה");

  const list = document.getElementById('borrowBookList');
  list.innerHTML = '';
  checkboxes.forEach(cb => {
    const b = books[cb.value];
    const li = document.createElement('li');
    li.textContent = `${b.name} (${b.subject}, שכבת ${b.grade}${b.level ? `, רמה ${b.level}` : ''})`;
    list.appendChild(li);
  });

  document.getElementById('confirmBorrowCheckbox').checked = false;

  // פותח את המודל עם טקסטים של השאלה
  openConfirmModal('השאלה');
}
let canvas, ctx, drawing=false;

window.onload = () => {
  // התחלת החתימה
  canvas = document.getElementById('signaturePad');
  ctx = canvas.getContext('2d');
  canvas.addEventListener('pointerdown', e => {
    drawing = true;
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    canvas.setPointerCapture(e.pointerId);
  });

  canvas.addEventListener('pointermove', e => {
    if (!drawing) return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  });

  ['pointerup', 'pointercancel', 'pointerleave'].forEach(event =>
    canvas.addEventListener(event, () => (drawing = false))
  );

  ['touchstart', 'touchmove', 'touchend', 'gesturestart'].forEach(evt =>
    canvas.addEventListener(evt, e => e.preventDefault(), { passive: false })
  );

  // נטענת רק אחרי טעינת הדף המלאה:
  window.addEventListener("DOMContentLoaded", () => {
  loadData().then(() => {
    console.log("✅ נתונים נטענו – מוכן לשימוש");
    // אל תקרא ל-saveData() כאן!
  });
});
  filterStudents();
  filterBooks();
  renderStudentTable();
  renderBookTable();
};

function viewStudentDetails(index) {
  const student = students[index];
  if (!student) return;

  const studentCharges = charges.filter(c => c.studentId === student.id);
  const studentPaidCharges = studentCharges.filter(c => c.paid);
  const studentUnpaidCharges = studentCharges.filter(c => !c.paid);

  const chargedIds = new Set(
    studentCharges.map(c => c.borrowId).filter(Boolean)
  );

  const studentBorrows = borrowed.filter(b =>
    b.student.id === student.id && !chargedIds.has(b.id)
  );
  const studentReturns = returned.filter(r =>
    r.student.id === student.id && !chargedIds.has(r.id)
  );

  const booksStillBorrowed = studentBorrows.filter(b =>
    !studentReturns.some(r => r.id === b.id)
  );

  const booksReturned = studentReturns.filter(returnEntry => {
    return !borrowed.some(b =>
      b.student.id === student.id &&
      b.book.id === returnEntry.book.id &&
      b.id !== returnEntry.id &&
      new Date(b.date) > new Date(returnEntry.returnDate) &&
      !returned.some(r => r.id === b.id)
    );
  });

  const totalDebt = studentUnpaidCharges.length * 50;
  const totalPaid = studentPaidCharges.length * 50;

  let html = `
    <h4>${student.name}</h4>
    <p>תעודת זהות: ${student.id}</p>
    <p>כיתה: ${student.classroom}</p>
    <p>בית ספר: ${student.school}</p>
  `;

  if (totalDebt > 0) {
    html += `<p><b style="color: red;">חוב:</b> ${totalDebt} ש"ח</p>`;
    html += `<p><b style="color: red;">ספרים שחויבו:</b><ul>`;
    studentUnpaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      html += `<li style="color: red;">${c.bookName} (${c.type}) - חויב ב־${chargedAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (totalPaid > 0) {
    html += `<p><b style="color: green;">שולם:</b> ${totalPaid} ש"ח</p>`;
    html += `<p><b style="color: green;">ספרים שחויבו ושולמו:</b><ul>`;
    studentPaidCharges.forEach(c => {
      const chargedAt = c.date ? new Date(c.date).toLocaleString('he-IL') : '---';
      const paidAt = c.paidDate ? new Date(c.paidDate).toLocaleString('he-IL') : '---';
      html += `<li style="color: green;">${c.bookName} (${c.type}) - חויב ב־${chargedAt}, שולם ב־${paidAt}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksStillBorrowed.length > 0) {
    html += `<p><b>ספרים שטרם הוחזרו:</b><ul>`;
    booksStillBorrowed.forEach(b => {
      html += `<li>${b.book.name} (${b.book.subject}) - הושאל ב־${new Date(b.date).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  if (booksReturned.length > 0) {
    html += `<p><b>ספרים שהוחזרו:</b><ul>`;
    booksReturned.forEach(r => {
      html += `<li>${r.book.name} (${r.book.subject}) - הוחזר ב־${new Date(r.returnDate).toLocaleString('he-IL')}</li>`;
    });
    html += `</ul></p>`;
  }

  // ✅ חתימות של התלמיד/בעל תפקיד לפי קבוצה
  const groupedBySignature = {};

  studentBorrows.forEach(b => {
    const key = b.bulkId + '|' + b.date;
    if (!groupedBySignature[key]) {
      groupedBySignature[key] = {
        date: b.date,
        signature: b.signature
      };
    }
  });

  const groupedEntries = Object.values(groupedBySignature);
  if (groupedEntries.length > 0) {
    html += `<p><b>חתימות על השאלות:</b></p>`;
    groupedEntries.forEach(g => {
      const dateStr = new Date(g.date).toLocaleString('he-IL');
      html += `
        <div style="margin:10px 0;">
          <p style="margin:0;"><b>${dateStr}:</b></p>
          <img src="${g.signature}" alt="חתימה" style="border:1px solid #ccc; max-width:100%; height:auto; margin-top:5px;" />
        </div>
      `;
    });
  }

  html += `<button onclick="printStudentCard(${index})">🖨️ הדפס כרטיס</button>`;
  document.getElementById('studentDetailContent').innerHTML = html;
  document.getElementById('studentDetailModal').style.display = 'flex';
}

function closeStudentModal() {
  document.getElementById('studentDetailModal').style.display = 'none';
}


function fixCanvasDPI() {
  const dpi = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpi;
  canvas.height = rect.height * dpi;
  ctx.scale(dpi, dpi);
}

function openBorrowModal() {
  const modal = document.getElementById('confirmBorrowModal');
  modal.style.display = 'flex';

  setTimeout(() => {
    canvas = document.getElementById('signaturePad');
    ctx = canvas.getContext('2d');
    fixCanvasDPI();

    canvas.addEventListener('pointerdown', e => {
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      canvas.setPointerCapture(e.pointerId);
    });

    canvas.addEventListener('pointermove', e => {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    });

    ['pointerup', 'pointercancel', 'pointerleave'].forEach(event =>
      canvas.addEventListener(event, () => (drawing = false))
    );

  }, 100); // מחכה טיפה אחרי שהמודל מוצג
}


function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
}

function getSignatureImage() {
  return canvas.toDataURL(); // מחזיר את החתימה כתמונה בפורמט base64
}


function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function isSignatureEmpty() {
  const blank = document.createElement('canvas');
  blank.width = canvas.width;
  blank.height = canvas.height;
  return canvas.toDataURL() === blank.toDataURL();
}

function finalizeBorrow() {
  const studentIdx = document.getElementById('filteredStudentsSelect').value;
  if (studentIdx === '') return alert("בחר תלמיד");
  const student = students[studentIdx];

  if (!document.getElementById('confirmBorrowCheckbox').checked)
    return alert("יש לאשר את הצהרת קבלת הספרים התקינים");

  if (isSignatureEmpty())
    return alert("נדרשת חתימה לפני השלמת הפעולה");

  const borrowerType = document.getElementById('borrowerTypeSelect').value;
  const borrowerName = document.getElementById('borrowerNameInput').value.trim();

  if ((borrowerType === 'parent' || borrowerType === 'staff') && !borrowerName) {
    return alert("נא למלא שם מלא עבור הורה או בעל תפקיד");
  }

  const checkboxes = document.querySelectorAll('#filteredBooksSelect input[type=checkbox]:checked');
  if (checkboxes.length === 0) return alert("בחר לפחות ספר אחד");

  const signatureData = getSignatureImage();
  const now = new Date().toISOString();
  const bulkId = crypto.randomUUID(); // מזהה קבוצתי לפעולה

  let countAdded = 0;

  if (window.currentActionType === 'השאלה') {
    checkboxes.forEach(cb => {
      const book = books[cb.value];
      const alreadyBorrowed = borrowed.some(b =>
        b.student.id === student.id &&
        b.book.id === book.id &&
        !returned.some(r => r.id === b.id)
      );

      if (!alreadyBorrowed) {
        borrowed.push({
          id: crypto.randomUUID(),
          student,
          book,
          date: now,
          signature: signatureData,
          bulkId,
          borrowerType,    // שמירת סוג המשאיל
          borrowerName: borrowerType === 'student' ? student.name : borrowerName // שם מלא (אם תלמיד - שמו)
        });
        countAdded++;
      }
    });

    if (countAdded === 0) {
      return alert("כל הספרים שנבחרו כבר הושאלו");
    } else {
      showSuccess(`הושאלו ${countAdded} ספרים`);
    }

  } else if (window.currentActionType === 'רכישה') {
    // דומה - רק סימון רכישה
    checkboxes.forEach(cb => {
      const book = books[cb.value];
      const alreadyPurchased = borrowed.some(b =>
        b.student.id === student.id &&
        b.book.id === book.id &&
        b.purchase === true
      );

      if (!alreadyPurchased) {
        borrowed.push({
          id: crypto.randomUUID(),
          student,
          book,
          date: now,
          signature: signatureData,
          purchase: true,
          bulkId,
          borrowerType,
          borrowerName: borrowerType === 'student' ? student.name : borrowerName
        });
        countAdded++;
      }
    });

    if (countAdded === 0) {
      return alert("כל הספרים שנבחרו כבר נקנו");
    } else {
      showSuccess(`נרכשו ${countAdded} ספרים`);
    }
  } else {
    return alert("שגיאה: סוג פעולה לא מוגדר");
  }

  saveData();
  filterBooks();
  closeBorrowModal();
}

function returnBook() {
  const selectedIds = Array.from(document.querySelectorAll('#returnBooksSelect input[type="checkbox"]:checked'))
    .map(cb => cb.value);

  if (selectedIds.length === 0) {
    showError("בחר ספרים להחזרה");
    return;
  }

  const returnDate = new Date().toISOString();
  const bulkId = `return-${Date.now()}`;

  selectedIds.forEach(id => {
    const entry = borrowed.find(b => b.id === id);
    if (entry && !returned.some(r => r.id === entry.id)) {
      returned.push({ ...entry, returnDate, bulkId });
    }
  });

  saveData();
  showSuccess("הספרים הוחזרו בהצלחה");
  filterStudentsReturn();
}

function closeBorrowModal()
{
    document.getElementById('confirmBorrowModal').style.display = 'none';
}

function deleteStudentFromTable(index) {
  if (!confirm('האם למחוק תלמיד זה?')) return;

  const deletedStudent = students[index]; // שומר את התלמיד לפני המחיקה
  if (!deletedStudent?.id) return;

  students.splice(index, 1); // מוחק את התלמיד

  // מוחק את ההשאלות וההחזרות שלו לפי ת"ז
  borrowed = borrowed.filter(b => b.student.id !== deletedStudent.id);
  returned = returned.filter(r => r.student.id !== deletedStudent.id);

  saveData();
  renderStudentTable();
  filterStudents();
  showSuccess('תלמיד נמחק');
}

function deleteSelectedBook() {
  const idx = document.getElementById('filteredBooksSelect').value;
  if (idx === '') return alert("בחר ספר למחיקה");
  if (!confirm("האם אתה בטוח שברצונך למחוק את הספר?")) return;
  books.splice(idx, 1);
  saveData();
  showSuccess("ספר נמחק");
  filterBooks();
}

function exportToExcel(data, type) {
  let rows = [];
  let headers = [];

  if (type === 'students') {
    headers = [
      "שם מלא",
      "תעודת זהות",
      "בית ספר",
      "כיתה",
      "משתתף בפרויקט השאלת ספרים", // הוספה
      "ספרים שהושאלו",
      "ספרים שחויבו",
      "חוב כולל (₪)"
    ];

    rows = data.map(student => {
      const borrowedBooks = borrowed
        .filter(b => b.student.id === student.id && !returned.some(r => r.id === b.id))
        .map(b => `${b.book.name} (${b.book.subject})`)
        .join(', ') || "אין";

      const unpaidCharges = charges.filter(c => c.studentId === student.id && !c.paid);
      const chargedBooks = unpaidCharges.map(c => `${c.bookName} (${c.type})`).join(', ') || "אין";
      const totalDebt = unpaidCharges.length * 50;

      return [
        student.name,
        student.id,
        student.school,
        student.classroom,
        student.inLoanProject ? "כן" : "לא",  // הוספה
        borrowedBooks,
        chargedBooks,
        totalDebt > 0 ? totalDebt : "0"
      ];
    });

  } else if (type === 'books') {
    headers = [
      "שם הספר",
      "מקצוע",
      "שכבת גיל",
      "רמת לימוד",
      "כרך",
      "שם הוצאה",
      "סוג ספר"
    ];

    rows = data.map(book => [
      book.name,
      book.subject,
      book.grade,
      book.level || "כללי",
      book.volume || "",
      book.publisher || "",
      book.type || ""
    ]);
  }

  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, type === 'students' ? 'תלמידים' : 'ספרים');
  XLSX.writeFile(wb, `${type}.xlsx`);
}

function importExcel(event, type) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const headers = rows[0];
    const dataRows = rows.slice(1);

    if (type === 'students') {
      const idx = {
        name: headers.indexOf("שם מלא"),
        id: headers.indexOf("תעודת זהות"),
        school: headers.indexOf("בית ספר"),
        classroom: headers.indexOf("כיתה"),
        inLoanProject: headers.indexOf("משתתף בפרויקט השאלת ספרים") // הוספה
      };

      dataRows.forEach(row => {
        const name = row[idx.name]?.toString().trim();
        const id = row[idx.id]?.toString().trim();
        const school = row[idx.school]?.toString().trim();
        const classroom = row[idx.classroom]?.toString().trim();
        const inLoanProjectRaw = idx.inLoanProject !== -1 ? row[idx.inLoanProject]?.toString().trim() : null;
        const inLoanProject = inLoanProjectRaw === 'כן' || inLoanProjectRaw === 'true';

        const alreadyExists = students.some(s => s.id === id);
        if (name && id && school && classroom && !alreadyExists) {
          students.push({ name, id, school, classroom, inLoanProject });
        }
      });

    } else if (type === 'books') {
      const idx = {
        name: headers.indexOf("שם הספר"),
        subject: headers.indexOf("מקצוע"),
        grade: headers.indexOf("שכבת גיל"),
        level: headers.indexOf("רמת לימוד"),
        volume: headers.indexOf("כרך"),
        publisher: headers.indexOf("שם הוצאה"),
        type: headers.indexOf("סוג ספר")
      };

      dataRows.forEach(row => {
        const name = row[idx.name]?.toString().trim();
        const subject = row[idx.subject]?.toString().trim();
        const grade = row[idx.grade]?.toString().trim();
        const level = row[idx.level]?.toString().trim() || "כללי";
        const volume = row[idx.volume]?.toString().trim() || "";
        const publisher = row[idx.publisher]?.toString().trim() || "";
        const typeValue = row[idx.type]?.toString().trim() || "";

        const alreadyExists = books.some(b =>
          b.name === name &&
          b.subject === subject &&
          b.grade === grade &&
          b.level === level &&
          b.volume === volume &&
          b.publisher === publisher &&
          b.type === typeValue
        );

        if (name && subject && grade && !alreadyExists) {
          books.push({
            id: crypto.randomUUID(),
            name,
            subject,
            grade,
            level,
            volume,
            publisher,
            type: typeValue
          });
        }
      });
    }

    saveData();
    showSuccess("ייבוא הצליח");
    filterStudents();
    filterBooks();
  };
  reader.readAsArrayBuffer(event.target.files[0]);
}

let selectedBulkBookIds = new Set(); // 🧠 משתנה גלובלי לזכירת ספרים שנבחרו

function selectAllFilteredBulkBooks() {
  const checkboxes = document.querySelectorAll('#bulkBooksSelect input[type=checkbox]');
  checkboxes.forEach(cb => {
    cb.checked = true;
    selectedBulkBookIds.add(cb.value);
  });
}

function deselectAllFilteredBulkBooks() {
  const checkboxes = document.querySelectorAll('#bulkBooksSelect input[type=checkbox]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    selectedBulkBookIds.delete(cb.value);
  });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function initializeCanvas(canvasId) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const dpi = window.devicePixelRatio || 1;

  canvas.width = rect.width * dpi;
  canvas.height = rect.height * dpi;
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpi, dpi);

  // מניעת מחוות swipe וגלילה
  canvas.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
  canvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
  canvas.addEventListener('touchend', e => e.preventDefault(), { passive: false });
}

function enableFullscreenOnCanvas(canvasId, containerId) {
  const container = document.getElementById(containerId);
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');

  canvas.addEventListener('mousedown', async () => {
    if (document.fullscreenElement) return;

    container.classList.add('fullscreen-signature');
    try {
      await container.requestFullscreen();
      setTimeout(() => resizeCanvasForFullscreen(canvas, ctx), 100);
    } catch (err) {
      console.warn('מסך מלא נכשל:', err);
    }
  });

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      container.classList.remove('fullscreen-signature');
      resizeCanvasToDefault(canvas, ctx);
    }
  });

  function resizeCanvasForFullscreen(canvas, ctx) {
    const dpi = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpi;
    canvas.height = window.innerHeight * 0.6 * dpi;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpi, dpi);
  }

  function resizeCanvasToDefault(canvas, ctx) {
    const dataURL = canvas.toDataURL();
    const img = new Image();
    img.onload = () => {
      const rect = canvas.getBoundingClientRect();
      const dpi = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpi;
      canvas.height = rect.height * dpi;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(dpi, dpi);
      ctx.drawImage(img, 0, 0, rect.width, rect.height);
    };
    img.src = dataURL;
  }
}

window.addEventListener('DOMContentLoaded', () => {
  initializeCanvas('signaturePad');
  initializeCanvas('bulkSignaturePad');
  enableFullscreenOnCanvas('signaturePad', 'signatureContainer');
  enableFullscreenOnCanvas('bulkSignaturePad', 'bulkSignatureContainer');
});

document.getElementById('filteredStudentsSelect').addEventListener('change', (e) => {
  const index = e.target.value;
  filterBooks();           // לעדכון רשימת ספרים להשאלה
  updateReturnBooks(index); // לעדכון רשימת ספרים להחזרה
});

</script>

<script>
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
  button.addEventListener('click', () => {
    const tabId = button.getAttribute('data-tab');

    // שמירת הלשונית הנבחרת ב-localStorage
    localStorage.setItem('activeTabId', tabId);

    // הסתרת כל הטאבים
    tabContents.forEach(tc => tc.classList.remove('active'));
    // ביטול סלקטיב של כל הכפתורים
    tabButtons.forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });

    // הצגת הטאב שנבחר
    document.getElementById(tabId).classList.add('active');
    button.classList.add('active');
    button.setAttribute('aria-selected', 'true');
  });
});

// טעינת הטאב הפעיל מ-localStorage בעת טעינת הדף
window.addEventListener('DOMContentLoaded', () => {
  const savedTabId = localStorage.getItem('activeTabId');
  if (savedTabId && document.getElementById(savedTabId)) {
    // הסרת ה-active מכל הטאבים והכפתורים
    tabContents.forEach(tc => tc.classList.remove('active'));
    tabButtons.forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });

    // הפעלת הטאב השמור
    document.getElementById(savedTabId).classList.add('active');
    const btn = Array.from(tabButtons).find(b => b.getAttribute('data-tab') === savedTabId);
    if (btn) {
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
    }
  } else {
    // אין טאב שמור, הפעל את הראשון כברירת מחדל
    tabButtons[0].click();
  }
});

function updateReturnBooks(studentIdx) {
  const container = document.getElementById('returnBooksSelect');
  container.innerHTML = '';

  if (!studentIdx) return;
  const student = students[studentIdx];
  if (!student) return;

  const sameStudentBorrowed = borrowed.filter(b => 
    b.student.id === student.id &&
    !returned.some(r => r.id === b.id) &&
    !charges.some(c => c.studentId === b.student.id && c.borrowId === b.id)
  );

  if (sameStudentBorrowed.length === 0) {
    container.innerHTML = '<p>אין ספרים להחזרה</p>';
    return;
  }

  sameStudentBorrowed.forEach((b, i) => {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = b.id;
    checkbox.id = 'return_' + i;
    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.textContent = `${b.book.name} (${b.book.subject}) - רמה: ${b.book.level || 'כללי'}`;
    label.prepend(checkbox);
    container.appendChild(label);
  });
}

// מאזינים לאירועים בלשונית החזרה – חשוב מאוד להאזין ל-SELECT הנכון!
document.getElementById('searchStudentInputReturn').addEventListener('input', () => {
  filterStudentsReturn();
});
document.getElementById('filteredStudentsSelectReturn').addEventListener('change', (e) => {
  updateReturnBooks(e.target.value);
});
document.getElementById('searchBookInputReturn').addEventListener('input', () => {
  // כאן נעדכן עם הפרמטר האחרון שנבחר ב-select
  const select = document.getElementById('filteredStudentsSelectReturn');
  updateReturnBooks(select ? select.value : '');
});
document.getElementById('levelFilterReturn').addEventListener('change', () => {
  const select = document.getElementById('filteredStudentsSelectReturn');
  updateReturnBooks(select ? select.value : '');
});

// קריאה ראשונית לטעינת התלמידים בלשונית החזרה
window.addEventListener('DOMContentLoaded', () => {
  loadData().then(() => {
    filterStudentsReturn();
  });
});


document.getElementById('studentTableSearch').addEventListener('input', () => renderStudentTable(1));
document.getElementById('filterGrade').addEventListener('change', () => renderStudentTable(1));
document.getElementById('filterClassroom').addEventListener('input', () => renderStudentTable(1));
document.getElementById('filterSubject').addEventListener('input', () => renderStudentTable(1));
document.getElementById('filterLevel').addEventListener('change', () => renderStudentTable(1));
document.getElementById('filterInLoanProject').addEventListener('change', () => renderStudentTable(1));

document.getElementById('bookTableSearch').addEventListener('input', () => renderBookTable(1));
document.getElementById('bookLevelFilter').addEventListener('change', () => renderBookTable(1));
document.getElementById('bookVolumeFilter').addEventListener('change', () => renderBookTable(1));
document.getElementById('bookPublisherFilter').addEventListener('input', () => renderBookTable(1));
document.getElementById('bookTypeFilter').addEventListener('change', () => renderBookTable(1));

// קריאות התחלתיות (אם יש)
renderStudentTable();
renderBookTable();
</script>


</body>
</html>